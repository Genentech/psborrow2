---
title: "6. Walkthrough overview slides"
subtitle: "Matt Secrest"
output:
  rmarkdown::ioslides_presentation:
    widescreen: true
    transition: 0.05
vignette: >
  %\VignetteIndexEntry{6. Walkthrough overview slides}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---







# Introducing `psborrow2`

## Presentation flow

- Bayesian Dynamic Borrowing
- History of `psborrow2`
- Overview of package
- Demonstration of a single dataset analysis
- Demonstration of a simulation study analysis
- Installing `psborrow2`

## Acknowledgements

`psborrow2` is the culmination of work from many individuals within
industry, academia, and the FDA. The below list of authors
and collaborators has been integral to the package development (alphabetical):

- Craig Gower-Page
- Isaac Gravestock
- Yichen Lu
- Herb Pang
- Daniel Sabanes Bove
- Matthew Secrest
- Jiawen Zhu

# Bayesian Dynamic Borrowing

## Hybrid controls

Hybrid control studies are those in which external data
are used to supplement the control arm of a
randomized, controlled trial (RCT). The schematic below describes such
a scenario:

<br>

<center>
![](hc_schematic.jpg)
</center>

## Types of borrowing

How best should we incorporate the knowledge we have on the external control arm?

There are several ways to do this. `psborrow2` allows for three
ways of incorporating external data:

<br>

<!--html_preserve--><div id="snzfksvsth" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#snzfksvsth table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#snzfksvsth thead, #snzfksvsth tbody, #snzfksvsth tfoot, #snzfksvsth tr, #snzfksvsth td, #snzfksvsth th {
  border-style: none;
}

#snzfksvsth p {
  margin: 0;
  padding: 0;
}

#snzfksvsth .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#snzfksvsth .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#snzfksvsth .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#snzfksvsth .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#snzfksvsth .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#snzfksvsth .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#snzfksvsth .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#snzfksvsth .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#snzfksvsth .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#snzfksvsth .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#snzfksvsth .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#snzfksvsth .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#snzfksvsth .gt_spanner_row {
  border-bottom-style: hidden;
}

#snzfksvsth .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#snzfksvsth .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#snzfksvsth .gt_from_md > :first-child {
  margin-top: 0;
}

#snzfksvsth .gt_from_md > :last-child {
  margin-bottom: 0;
}

#snzfksvsth .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#snzfksvsth .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#snzfksvsth .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#snzfksvsth .gt_row_group_first td {
  border-top-width: 2px;
}

#snzfksvsth .gt_row_group_first th {
  border-top-width: 2px;
}

#snzfksvsth .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#snzfksvsth .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#snzfksvsth .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#snzfksvsth .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#snzfksvsth .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#snzfksvsth .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#snzfksvsth .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#snzfksvsth .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#snzfksvsth .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#snzfksvsth .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#snzfksvsth .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#snzfksvsth .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#snzfksvsth .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#snzfksvsth .gt_left {
  text-align: left;
}

#snzfksvsth .gt_center {
  text-align: center;
}

#snzfksvsth .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#snzfksvsth .gt_font_normal {
  font-weight: normal;
}

#snzfksvsth .gt_font_bold {
  font-weight: bold;
}

#snzfksvsth .gt_font_italic {
  font-style: italic;
}

#snzfksvsth .gt_super {
  font-size: 65%;
}

#snzfksvsth .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#snzfksvsth .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#snzfksvsth .gt_indent_1 {
  text-indent: 5px;
}

#snzfksvsth .gt_indent_2 {
  text-indent: 10px;
}

#snzfksvsth .gt_indent_3 {
  text-indent: 15px;
}

#snzfksvsth .gt_indent_4 {
  text-indent: 20px;
}

#snzfksvsth .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>

    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" style="font-weight: bold;" scope="col" id="Borrowing type">Borrowing type</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" style="font-weight: bold;" scope="col" id="Description">Description</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="Borrowing type" class="gt_row gt_left">No borrowing</td>
<td headers="Description" class="gt_row gt_left">Only include the internal RCT date (i.e., ignoring external controls)</td></tr>
    <tr><td headers="Borrowing type" class="gt_row gt_left">Full borrowing</td>
<td headers="Description" class="gt_row gt_left">Pool external and internal controls</td></tr>
    <tr><td headers="Borrowing type" class="gt_row gt_left">Bayesian dynamic borrowing (BDB)</td>
<td headers="Description" class="gt_row gt_left">Borrowing external controls to the extent that the outcomes are similar</td></tr>
  </tbody>


</table>
</div><!--/html_preserve-->

## Standard Bayesian analysis without borrowing

Consider a standard Bayesian model with survival as an endpoint without
external data. This is equally valid in "No borrowing" and "Full borrowing"
approaches. There are two parameters of interest:

- $\rho_{00}$, the hazard rate for the internal control
- $\rho_{10}$, the hazard rate for the internal experimental

The hazard ratio, $\theta$, is therefore:
$$
\theta = \frac{\rho_{10}}{\rho_{00}}
$$

And the posterior distribution of $\theta$ is:

$$
P(\theta | X) \propto P(X | \theta) \times P(\theta)
$$

## Bayesian Dynamic Borrowing

In BDB, we introduce two more parameters:

- $\rho_{01}$, the hazard rate of the external control cohort
- $\tau$, a precision parameter known as the "commensurability parameter"

Information from $\rho_{01}$ is used in estimating $\rho_{00}$ through a
hierarchical model:

$$
\rho_{00} | \rho_{01} \sim \operatorname{Normal}\left(\rho_{01}, \frac{1}{\tau}\right)
$$

The posterior distribution for $\theta$ is then:

$$
P(\theta, \tau | X) \propto P(X | \theta, \tau) \times P(\theta | \tau) \times P(\tau)
$$

## Impact of $\tau$

The commensurability parameter, $\tau$ dictates the extent of borrowing. This
is estimated by the model but can be influenced by the choice of hyperprior.
As $\tau$ approaches infinity, the prior distribution on $\rho_{00}$ effectively
becomes $\rho_{01}$:

$$
\rho_{00} \sim \rho_{01} \approxeq \operatorname{Normal}\left(\rho_{01}, \infty\right)
$$


## Choice of hyperprior for $\tau$

Consider two hyperprior distributions for $\tau$:


```
> Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
> ℹ Please use `linewidth` instead.
> This warning is displayed once every 8 hours.
> Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.
```

<img src="figure-overview_slides-unnamed-chunk-4-1.png" alt="plot of chunk unnamed-chunk-4" style="display: block; margin: auto;" />

The $gamma(1, .001)$ will induce more borrowing.

# History of `psborrow2`

## `psborrow2` timeline

`psborrow2` is the successor to [`psborrow`](https://cran.r-project.org/web/packages/psborrow/index.html),
an R package for simulation studies to aid trial
design and understand the benefits of BDB on
operating characteristics.

<!--html_preserve--><div id="bquyoqczya" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#bquyoqczya table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#bquyoqczya thead, #bquyoqczya tbody, #bquyoqczya tfoot, #bquyoqczya tr, #bquyoqczya td, #bquyoqczya th {
  border-style: none;
}

#bquyoqczya p {
  margin: 0;
  padding: 0;
}

#bquyoqczya .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#bquyoqczya .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#bquyoqczya .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#bquyoqczya .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#bquyoqczya .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#bquyoqczya .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bquyoqczya .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#bquyoqczya .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#bquyoqczya .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#bquyoqczya .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#bquyoqczya .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#bquyoqczya .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#bquyoqczya .gt_spanner_row {
  border-bottom-style: hidden;
}

#bquyoqczya .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#bquyoqczya .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#bquyoqczya .gt_from_md > :first-child {
  margin-top: 0;
}

#bquyoqczya .gt_from_md > :last-child {
  margin-bottom: 0;
}

#bquyoqczya .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#bquyoqczya .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#bquyoqczya .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#bquyoqczya .gt_row_group_first td {
  border-top-width: 2px;
}

#bquyoqczya .gt_row_group_first th {
  border-top-width: 2px;
}

#bquyoqczya .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#bquyoqczya .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#bquyoqczya .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#bquyoqczya .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bquyoqczya .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#bquyoqczya .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#bquyoqczya .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#bquyoqczya .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#bquyoqczya .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bquyoqczya .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#bquyoqczya .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#bquyoqczya .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#bquyoqczya .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#bquyoqczya .gt_left {
  text-align: left;
}

#bquyoqczya .gt_center {
  text-align: center;
}

#bquyoqczya .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#bquyoqczya .gt_font_normal {
  font-weight: normal;
}

#bquyoqczya .gt_font_bold {
  font-weight: bold;
}

#bquyoqczya .gt_font_italic {
  font-style: italic;
}

#bquyoqczya .gt_super {
  font-size: 65%;
}

#bquyoqczya .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#bquyoqczya .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#bquyoqczya .gt_indent_1 {
  text-indent: 5px;
}

#bquyoqczya .gt_indent_2 {
  text-indent: 10px;
}

#bquyoqczya .gt_indent_3 {
  text-indent: 15px;
}

#bquyoqczya .gt_indent_4 {
  text-indent: 20px;
}

#bquyoqczya .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>

    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" style="font-weight: bold;" scope="col" id="Date">Date</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" style="font-weight: bold;" scope="col" id="Event">Event</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="Date" class="gt_row gt_left">2019</td>
<td headers="Event" class="gt_row gt_left">psborrow development started</td></tr>
    <tr><td headers="Date" class="gt_row gt_left">Q2 2021</td>
<td headers="Event" class="gt_row gt_left">CRAN v0.1.0 published</td></tr>
    <tr><td headers="Date" class="gt_row gt_left">2021</td>
<td headers="Event" class="gt_row gt_left">Initial user feedback received from the interial POC study and the FDA CID pilot project</td></tr>
    <tr><td headers="Date" class="gt_row gt_left">Q1 2022</td>
<td headers="Event" class="gt_row gt_left">We start a collaboration with Roche statistical engineering team to productionize the package</td></tr>
    <tr><td headers="Date" class="gt_row gt_left">May 2022</td>
<td headers="Event" class="gt_row gt_left">psborrow v0.2.0 published (bug fixed, documentation improved) on CRAN</td></tr>
    <tr><td headers="Date" class="gt_row gt_left">Jul 2022</td>
<td headers="Event" class="gt_row gt_left">psborrow2 development started (faster, improved UI, tests, flexibility, more outcomes)</td></tr>
    <tr><td headers="Date" class="gt_row gt_left">Oct 2022</td>
<td headers="Event" class="gt_row gt_left">psborrow2 package made public</td></tr>
  </tbody>


</table>
</div><!--/html_preserve-->

# Overview of package

## Package objectives

`psborrow2` has two objectives:

### <b><u>1) Facilitate BDB analyses</u></b>
`psborrow2` has a user-friendly interface for conducting
BDB analyses that handles the computationally-difficult MCMC sampling
for the user

### <b><u>2) Facilitate simulation studies of BDB</u></b>
`psborrow2` can be used to compare different trial and BDB characteristics in a
unified way in simulation studies to inform trial design

# Demonstration of a single BDB analysis

## Prior distributions

In `psborrow2`, the user creates fully parametric Bayesian models with
proper prior distributions using the constructors:


```r
bernoulli_prior()
beta_prior()
cauchy_prior()
exponential_prior()
gamma_prior()
normal_prior()
poisson_prior()
uniform_prior()
```


```r
is(normal_prior(mu = 0, sigma = 100), "Prior")
> [1] TRUE
```

## Plotting priors

Each `Prior` object has a `plot` method.


```r
plot(
  normal_prior(mu = 0, sigma = 10),
  xlim = c(-100, 100),
  ylim = c(0, 0.1)
)
```

<img src="figure-overview_slides-unnamed-chunk-8-1.png" alt="plot of chunk unnamed-chunk-8" style="display: block; margin: auto;" />


## Plotting an uninformative normal prior


```r
plot(
  normal_prior(mu = 0, sigma = 10000),
  xlim = c(-100, 100),
  ylim = c(0, 0.1)
)
```

<img src="figure-overview_slides-unnamed-chunk-9-1.png" alt="plot of chunk unnamed-chunk-9" style="display: block; margin: auto;" />

## Hyperpriors for commensurability parameters

Let's look at a conservative hyperprior that will not encourage borrowing:


```r
plot(
  gamma_prior(alpha = 0.001, beta = 0.001),
  xlim = c(-1, 20),
  ylim = c(0, .025)
)
```

<img src="figure-overview_slides-unnamed-chunk-10-1.png" alt="plot of chunk unnamed-chunk-10" style="display: block; margin: auto;" />

##

Now let's look at a more aggressive hyperprior that may induce
borrowing:


```r
plot(
  gamma_prior(alpha = 1, beta = 0.001),
  xlim = c(-1, 20),
  ylim = c(0, .025)
)
```

<img src="figure-overview_slides-unnamed-chunk-11-1.png" alt="plot of chunk unnamed-chunk-11" style="display: block; margin: auto;" />

## Example data

`psborrow2` has simulated example data we can use in an analysis.


```r
head(example_matrix[, c("ext", "trt", "time", "cnsr")])
>      ext trt       time cnsr
> [1,]   0   0  2.4226411    0
> [2,]   0   0 50.0000000    1
> [3,]   0   0  0.9674372    0
> [4,]   0   0 14.5774738    0
> [5,]   0   0 50.0000000    1
> [6,]   0   0 50.0000000    1
```

* `ext = 1` for external trial patients, else `ext = 0`
* `trt = 1` for experimentally-treated patients, else `trt = 0`
* `time` is the time to event or censorship
* `cnsr = 1` if a patient's follow-up was censored, else `csnr = 0`



##

The flags in this `data.frame` are explained in greater detail
in `?example_matrix`.

<center>
<br>
<!--html_preserve--><div id="wpfbyktkdu" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#wpfbyktkdu table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#wpfbyktkdu thead, #wpfbyktkdu tbody, #wpfbyktkdu tfoot, #wpfbyktkdu tr, #wpfbyktkdu td, #wpfbyktkdu th {
  border-style: none;
}

#wpfbyktkdu p {
  margin: 0;
  padding: 0;
}

#wpfbyktkdu .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#wpfbyktkdu .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#wpfbyktkdu .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#wpfbyktkdu .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#wpfbyktkdu .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#wpfbyktkdu .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#wpfbyktkdu .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#wpfbyktkdu .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#wpfbyktkdu .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#wpfbyktkdu .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#wpfbyktkdu .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#wpfbyktkdu .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#wpfbyktkdu .gt_spanner_row {
  border-bottom-style: hidden;
}

#wpfbyktkdu .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#wpfbyktkdu .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#wpfbyktkdu .gt_from_md > :first-child {
  margin-top: 0;
}

#wpfbyktkdu .gt_from_md > :last-child {
  margin-bottom: 0;
}

#wpfbyktkdu .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#wpfbyktkdu .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#wpfbyktkdu .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#wpfbyktkdu .gt_row_group_first td {
  border-top-width: 2px;
}

#wpfbyktkdu .gt_row_group_first th {
  border-top-width: 2px;
}

#wpfbyktkdu .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#wpfbyktkdu .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#wpfbyktkdu .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#wpfbyktkdu .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#wpfbyktkdu .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#wpfbyktkdu .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#wpfbyktkdu .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#wpfbyktkdu .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#wpfbyktkdu .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#wpfbyktkdu .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#wpfbyktkdu .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#wpfbyktkdu .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#wpfbyktkdu .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#wpfbyktkdu .gt_left {
  text-align: left;
}

#wpfbyktkdu .gt_center {
  text-align: center;
}

#wpfbyktkdu .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#wpfbyktkdu .gt_font_normal {
  font-weight: normal;
}

#wpfbyktkdu .gt_font_bold {
  font-weight: bold;
}

#wpfbyktkdu .gt_font_italic {
  font-style: italic;
}

#wpfbyktkdu .gt_super {
  font-size: 65%;
}

#wpfbyktkdu .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#wpfbyktkdu .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#wpfbyktkdu .gt_indent_1 {
  text-indent: 5px;
}

#wpfbyktkdu .gt_indent_2 {
  text-indent: 10px;
}

#wpfbyktkdu .gt_indent_3 {
  text-indent: 15px;
}

#wpfbyktkdu .gt_indent_4 {
  text-indent: 20px;
}

#wpfbyktkdu .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>

    <tr class="gt_col_headings gt_spanner_row">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="2" colspan="1" scope="col" id=""></th>
      <th class="gt_center gt_columns_top_border gt_column_spanner_outer" rowspan="1" colspan="2" scope="colgroup" id="External trial data flag">
        <span class="gt_column_spanner">External trial data flag</span>
      </th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="2" colspan="1" scope="col" id="Total">Total</th>
    </tr>
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="0">0</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="1">1</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="label" class="gt_row gt_left">Experimental treatment flag</td>
<td headers="stat_1" class="gt_row gt_center"></td>
<td headers="stat_2" class="gt_row gt_center"></td>
<td headers="stat_0" class="gt_row gt_center"></td></tr>
    <tr><td headers="label" class="gt_row gt_left">    0</td>
<td headers="stat_1" class="gt_row gt_center">50</td>
<td headers="stat_2" class="gt_row gt_center">350</td>
<td headers="stat_0" class="gt_row gt_center">400</td></tr>
    <tr><td headers="label" class="gt_row gt_left">    1</td>
<td headers="stat_1" class="gt_row gt_center">100</td>
<td headers="stat_2" class="gt_row gt_center">0</td>
<td headers="stat_0" class="gt_row gt_center">100</td></tr>
    <tr><td headers="label" class="gt_row gt_left">Total</td>
<td headers="stat_1" class="gt_row gt_center">150</td>
<td headers="stat_2" class="gt_row gt_center">350</td>
<td headers="stat_0" class="gt_row gt_center">500</td></tr>
  </tbody>


</table>
</div><!--/html_preserve-->
</center>

<br>

It looks like we have 50 patients in our internal control,
100 in our internal experimental, and 350 in our external control.

## Naive internal comparisons

Let's start by exploring the three arms descriptively:

```{r message = FALSE, echo = FALSE, fig.align = "center", fig.dim = c(7, 4)}
library(survival)
library(survminer)
km_fit <- survfit(Surv(time = time, event = 1 - cnsr) ~ trt + ext, example_dataframe)
ggsurvplot(fit = km_fit, data = example_dataframe, palette = "Set1")
```
<br>
Wow, the external control population looks quite different from the internal
control population!

##

<br>

As a point of reference, let's conduct a Cox proportional hazards model
looking just at the internal RCT data.

<br>

<center>
<!--html_preserve--><div id="vgwzvpznzo" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#vgwzvpznzo table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#vgwzvpznzo thead, #vgwzvpznzo tbody, #vgwzvpznzo tfoot, #vgwzvpznzo tr, #vgwzvpznzo td, #vgwzvpznzo th {
  border-style: none;
}

#vgwzvpznzo p {
  margin: 0;
  padding: 0;
}

#vgwzvpznzo .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#vgwzvpznzo .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#vgwzvpznzo .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#vgwzvpznzo .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#vgwzvpznzo .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#vgwzvpznzo .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#vgwzvpznzo .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#vgwzvpznzo .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#vgwzvpznzo .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#vgwzvpznzo .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#vgwzvpznzo .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#vgwzvpznzo .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#vgwzvpznzo .gt_spanner_row {
  border-bottom-style: hidden;
}

#vgwzvpznzo .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#vgwzvpznzo .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#vgwzvpznzo .gt_from_md > :first-child {
  margin-top: 0;
}

#vgwzvpznzo .gt_from_md > :last-child {
  margin-bottom: 0;
}

#vgwzvpznzo .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#vgwzvpznzo .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#vgwzvpznzo .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#vgwzvpznzo .gt_row_group_first td {
  border-top-width: 2px;
}

#vgwzvpznzo .gt_row_group_first th {
  border-top-width: 2px;
}

#vgwzvpznzo .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#vgwzvpznzo .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#vgwzvpznzo .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#vgwzvpznzo .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#vgwzvpznzo .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#vgwzvpznzo .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#vgwzvpznzo .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#vgwzvpznzo .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#vgwzvpznzo .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#vgwzvpznzo .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#vgwzvpznzo .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#vgwzvpznzo .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#vgwzvpznzo .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#vgwzvpznzo .gt_left {
  text-align: left;
}

#vgwzvpznzo .gt_center {
  text-align: center;
}

#vgwzvpznzo .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#vgwzvpznzo .gt_font_normal {
  font-weight: normal;
}

#vgwzvpznzo .gt_font_bold {
  font-weight: bold;
}

#vgwzvpznzo .gt_font_italic {
  font-style: italic;
}

#vgwzvpznzo .gt_super {
  font-size: 65%;
}

#vgwzvpznzo .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#vgwzvpznzo .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#vgwzvpznzo .gt_indent_1 {
  text-indent: 5px;
}

#vgwzvpznzo .gt_indent_2 {
  text-indent: 10px;
}

#vgwzvpznzo .gt_indent_3 {
  text-indent: 15px;
}

#vgwzvpznzo .gt_indent_4 {
  text-indent: 20px;
}

#vgwzvpznzo .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>

    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="term">term</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="estimate">estimate</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="std.error">std.error</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="statistic">statistic</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="p.value">p.value</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="conf.low">conf.low</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="conf.high">conf.high</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="term" class="gt_row gt_left">trt</td>
<td headers="estimate" class="gt_row gt_right">0.90</td>
<td headers="std.error" class="gt_row gt_right">0.20</td>
<td headers="statistic" class="gt_row gt_right">−0.56</td>
<td headers="p.value" class="gt_row gt_right">0.58</td>
<td headers="conf.low" class="gt_row gt_right">0.61</td>
<td headers="conf.high" class="gt_row gt_right">1.32</td></tr>
  </tbody>


</table>
</div><!--/html_preserve-->

</center>

<br>

Here, the hazard ratio is 0.90 (95% CI 0.61 - 1.32), ignoring the external
control data.

## Hybrid control analysis

Let's confirm that BDB will <b>not</b> perform much borrowing when we include
the external data. For a BDB analysis in `psborrow2`, we want to
create an object of class `Analysis` with:


```r
create_analysis_obj(
  data_matrix,
  outcome,
  borrowing,
  treatment
)
```

```{r echo = FALSE}
gt(
  tribble(
    ~Argument, ~Description,
    "data_matrix", paste0(
      "The data matrix, including all relevant outcome variables,",
      "and treatment arm and external control arm flags."
    ),
    "outcome", paste0(
      "Object of class Outcome as output by exp_surv_dist(), ",
      "weib_ph_surv_dist(), or logistic_bin_outcome()."
    ),
    "borrowing", "Object of class Borrowing as output by borrowing_details().",
    "treatment", "Object of class Treatment as output by treatment_details()."
  )
) %>%
  tab_style(
    locations = cells_body(columns = "Argument"),
    style = list(
      cell_text(weight = "bold")
    )
  )
```

#pkabfvefvw thead, #pkabfvefvw tbody, #pkabfvefvw tfoot, #pkabfvefvw tr, #pkabfvefvw td, #pkabfvefvw th {
  border-style: none;
}

#pkabfvefvw p {
  margin: 0;
  padding: 0;
}

#pkabfvefvw .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#pkabfvefvw .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#pkabfvefvw .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#pkabfvefvw .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#pkabfvefvw .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#pkabfvefvw .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#pkabfvefvw .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#pkabfvefvw .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#pkabfvefvw .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#pkabfvefvw .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#pkabfvefvw .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#pkabfvefvw .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#pkabfvefvw .gt_spanner_row {
  border-bottom-style: hidden;
}

#pkabfvefvw .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#pkabfvefvw .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#pkabfvefvw .gt_from_md > :first-child {
  margin-top: 0;
}

#pkabfvefvw .gt_from_md > :last-child {
  margin-bottom: 0;
}

#pkabfvefvw .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#pkabfvefvw .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#pkabfvefvw .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#pkabfvefvw .gt_row_group_first td {
  border-top-width: 2px;
}

#pkabfvefvw .gt_row_group_first th {
  border-top-width: 2px;
}

#pkabfvefvw .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#pkabfvefvw .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#pkabfvefvw .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#pkabfvefvw .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#pkabfvefvw .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#pkabfvefvw .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#pkabfvefvw .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#pkabfvefvw .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#pkabfvefvw .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#pkabfvefvw .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#pkabfvefvw .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#pkabfvefvw .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#pkabfvefvw .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#pkabfvefvw .gt_left {
  text-align: left;
}

#pkabfvefvw .gt_center {
  text-align: center;
}

#pkabfvefvw .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#pkabfvefvw .gt_font_normal {
  font-weight: normal;
}

#pkabfvefvw .gt_font_bold {
  font-weight: bold;
}

#pkabfvefvw .gt_font_italic {
  font-style: italic;
}

#pkabfvefvw .gt_super {
  font-size: 65%;
}

#pkabfvefvw .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#pkabfvefvw .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#pkabfvefvw .gt_indent_1 {
  text-indent: 5px;
}

#pkabfvefvw .gt_indent_2 {
  text-indent: 10px;
}

#pkabfvefvw .gt_indent_3 {
  text-indent: 15px;
}

#pkabfvefvw .gt_indent_4 {
  text-indent: 20px;
}

#pkabfvefvw .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>

    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="Argument">Argument</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="Description">Description</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="Argument" class="gt_row gt_left" style="font-weight: bold;">data_matrix</td>
<td headers="Description" class="gt_row gt_left">The data matrix, including all relevant outcome variables,and treatment arm and external control arm flags.</td></tr>
    <tr><td headers="Argument" class="gt_row gt_left" style="font-weight: bold;">outcome</td>
<td headers="Description" class="gt_row gt_left">Object of class Outcome as output by exp_surv_dist(), weib_ph_surv_dist(), or logistic_bin_outcome().</td></tr>
    <tr><td headers="Argument" class="gt_row gt_left" style="font-weight: bold;">borrowing</td>
<td headers="Description" class="gt_row gt_left">Object of class Borrowing as output by borrowing_details().</td></tr>
    <tr><td headers="Argument" class="gt_row gt_left" style="font-weight: bold;">treatment</td>
<td headers="Description" class="gt_row gt_left">Object of class Treatment as output by treatment_details().</td></tr>
  </tbody>


</table>
</div><!--/html_preserve-->

## Outcome class

Let's look at the `Outcome` class. There are three different
outcomes supported by `psborrow2`, each of which has a constructor:

<br>

```{r, echo = FALSE}
gt(
  tribble(
    ~Constructor, ~Description,
    "exp_surv_dist()", "Exponential survival distribution",
    "weib_ph_surv_dist()", "Weibull survival distribution (proportional hazards formulation)",
    "logistic_bin_outcome()", "Bernoulli distribution with logit parametrization"
  )
) %>%
  tab_style(
    locations = cells_body(columns = "Constructor"),
    style = list(
      cell_text(weight = "bold")
    )
  )
```

## Arguments to `exp_surv_dist()`

```{r eval = FALSE}
exp_surv_dist(
  time_var,
  cens_var,
  baseline_prior
)
```

The first two arguments to `outcome_surv_exponential()` are straightforward:

- `time_var`, Name of time variable column in model matrix
- `cens_var`, Name of the censorship variable flag in model matrix

The final argument is more complicated:

- `baseline_prior`, Prior distribution for the log hazard rate of the external
control arm.

##

Let's create our outcome object with `outcome_surv_exponential()` using an uninformative
Normal prior distribution for the log hazard rate of the external control
arm.

```{r}
exp_outcome <- exp_surv_dist(
  time_var = "time",
  cens_var = "cnsr",
  baseline_prior = normal_prior(0, 10000)
)
```


```r
class(exp_outcome)
> [1] "ExponentialSurvDist"
> attr(,"package")
> [1] "psborrow2"
```


```r
is(exp_outcome, "Outcome")
> [1] TRUE
```

## Borrowing class

Borrowing class objects are created with `borrowing_details()`.


```r
borrowing_details(
  method,
  ext_flag_col,
  tau_prior
)
```

- `method`, The type of borrowing to perform. It must be one of: `'BDB'`,
`'Full borrowing'`, or `'No borrowing'`
- `ext_flag_col`, The name of the column in the data matrix that corresponds to
the external control flag
- `tau_prior`, the hyperprior for the commensurability parameter (only
necessary for 'BDB')

##

Let's create a `Borrowing` object with a conservative inverse
Gamma distribution with rate and scale of 0.001:


```r
bdb_borrowing <- borrowing_details(
  method = "BDB",
  ext_flag_col = "ext",
  tau_prior = gamma_prior(alpha = 0.001, beta = 0.001)
)
```



```r
class(bdb_borrowing)
> [1] "Borrowing"
> attr(,"package")
> [1] "psborrow2"
```

## Treatment class

Finally, we'll create an object of class `Treatment` through the constructor
`treatment_details`.


```r
treatment_details(
  trt_flag_col,
  trt_prior
)
```

- `trt_flag_col`, The name of the column in the model matrix that corresponds to
the treatment flag
- `trt_prior`, Object of class `Prior` specifying the prior distribution of the
log hazard ratio for the experimental treatment

##

Let's assume an uninformative prior distribution for the log hazard ratio
of treatment and create our `Treatment` object:


```r
trt_details <- treatment_details(
  trt_flag_col = "trt",
  trt_prior = normal_prior(0, 10000)
)
```


```r
class(trt_details)
> [1] "Treatment"
> attr(,"package")
> [1] "psborrow2"
```

## Analysis class object

Now we have all the information we need to create an object of class `Analysis`:


```r
analysis_object <- create_analysis_obj(
  data_matrix = example_matrix,
  outcome = exp_outcome,
  borrowing = bdb_borrowing,
  treatment = trt_details
)
```


```r
class(analysis_object)
> [1] "Analysis"
> attr(,"package")
> [1] "psborrow2"
```

##
We can do this in one function call as well:


```r
analysis_object <- create_analysis_obj(
  data_matrix = example_matrix,
  outcome = outcome_surv_exponential(
    time_var = "time",
    cens_var = "cnsr",
    baseline_prior = normal_prior(0, 10000)
  ),
  borrowing = borrowing_details(
    method = "BDB",
    ext_flag_col = "ext",
    tau_prior = gamma_prior(alpha = 0.001, beta = 0.001)
  ),
  treatment = treatment_details(
    trt_flag_col = "trt",
    trt_prior = normal_prior(0, 10000)
  )
)
```

##


```r
print(analysis_object)
> Analysis Object
>
> Outcome model: ExponentialSurvDist
> Outcome variables: time cnsr
>
> Borrowing method: BDB
> External flag: ext
>
> Treatment variable: trt
>
> Data: Matrix with 500 observations
>     -  50  internal controls
>     -  350  external controls
>     -  100  internal experimental
>
> Stan model compiled and ready to sample.
>  Call mcmc_sample() next.
```

## Sampling from an analysis object

The `Analysis` object suggests calling `mcmc_sample()`
as a next step. We'll follow that advice!




```r
results <- mcmc_sample(
  analysis_object,
  iter_warmup = 1000,
  iter_sampling = 1000,
  chains = 1
)
```


```r
results
>  variable     mean   median   sd  mad       q5      q95 rhat ess_bulk ess_tail
>  lp__     -1617.90 -1617.59 1.45 1.25 -1620.76 -1616.18 1.00      342      549
>  beta_trt    -0.15    -0.15 0.19 0.20    -0.45     0.16 1.00      359      468
>  tau          1.16     0.54 1.77 0.74     0.01     4.18 1.00      494      463
>  alpha[1]    -3.36    -3.36 0.15 0.15    -3.63    -3.12 1.00      395      526
>  alpha[2]    -2.40    -2.40 0.06 0.06    -2.50    -2.30 1.00      726      553
>  HR_trt       0.88     0.86 0.17 0.17     0.64     1.18 1.00      359      468
```

At this point in our analysis, we should refer
to the [`cmdstanr`](https://github.com/stan-dev/cmdstanr) site for
methods.

##

Let's look at a summary of the median and 95% credible intervals:

<!--html_preserve--><div id="gvqqrrkpcw" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#gvqqrrkpcw table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#gvqqrrkpcw thead, #gvqqrrkpcw tbody, #gvqqrrkpcw tfoot, #gvqqrrkpcw tr, #gvqqrrkpcw td, #gvqqrrkpcw th {
  border-style: none;
}

#gvqqrrkpcw p {
  margin: 0;
  padding: 0;
}

#gvqqrrkpcw .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#gvqqrrkpcw .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#gvqqrrkpcw .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#gvqqrrkpcw .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#gvqqrrkpcw .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#gvqqrrkpcw .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#gvqqrrkpcw .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#gvqqrrkpcw .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#gvqqrrkpcw .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#gvqqrrkpcw .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#gvqqrrkpcw .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#gvqqrrkpcw .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#gvqqrrkpcw .gt_spanner_row {
  border-bottom-style: hidden;
}

#gvqqrrkpcw .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#gvqqrrkpcw .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#gvqqrrkpcw .gt_from_md > :first-child {
  margin-top: 0;
}

#gvqqrrkpcw .gt_from_md > :last-child {
  margin-bottom: 0;
}

#gvqqrrkpcw .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#gvqqrrkpcw .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#gvqqrrkpcw .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#gvqqrrkpcw .gt_row_group_first td {
  border-top-width: 2px;
}

#gvqqrrkpcw .gt_row_group_first th {
  border-top-width: 2px;
}

#gvqqrrkpcw .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#gvqqrrkpcw .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#gvqqrrkpcw .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#gvqqrrkpcw .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#gvqqrrkpcw .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#gvqqrrkpcw .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#gvqqrrkpcw .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#gvqqrrkpcw .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#gvqqrrkpcw .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#gvqqrrkpcw .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#gvqqrrkpcw .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#gvqqrrkpcw .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#gvqqrrkpcw .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#gvqqrrkpcw .gt_left {
  text-align: left;
}

#gvqqrrkpcw .gt_center {
  text-align: center;
}

#gvqqrrkpcw .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#gvqqrrkpcw .gt_font_normal {
  font-weight: normal;
}

#gvqqrrkpcw .gt_font_bold {
  font-weight: bold;
}

#gvqqrrkpcw .gt_font_italic {
  font-style: italic;
}

#gvqqrrkpcw .gt_super {
  font-size: 65%;
}

#gvqqrrkpcw .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#gvqqrrkpcw .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#gvqqrrkpcw .gt_indent_1 {
  text-indent: 5px;
}

#gvqqrrkpcw .gt_indent_2 {
  text-indent: 10px;
}

#gvqqrrkpcw .gt_indent_3 {
  text-indent: 15px;
}

#gvqqrrkpcw .gt_indent_4 {
  text-indent: 20px;
}

#gvqqrrkpcw .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>

    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="variable">variable</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="2.5%">2.5%</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="50%">50%</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="97.5%">97.5%</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="variable" class="gt_row gt_left">treatment log HR</td>
<td headers="2.5%" class="gt_row gt_right">−0.49</td>
<td headers="50%" class="gt_row gt_right">−0.15</td>
<td headers="97.5%" class="gt_row gt_right">0.23</td></tr>
    <tr><td headers="variable" class="gt_row gt_left">commensurability parameter</td>
<td headers="2.5%" class="gt_row gt_right">0.00</td>
<td headers="50%" class="gt_row gt_right">0.54</td>
<td headers="97.5%" class="gt_row gt_right">6.23</td></tr>
    <tr><td headers="variable" class="gt_row gt_left">baseline log hazard rate, internal</td>
<td headers="2.5%" class="gt_row gt_right">−3.67</td>
<td headers="50%" class="gt_row gt_right">−3.36</td>
<td headers="97.5%" class="gt_row gt_right">−3.08</td></tr>
    <tr><td headers="variable" class="gt_row gt_left">baseline log hazard rate, external</td>
<td headers="2.5%" class="gt_row gt_right">−2.52</td>
<td headers="50%" class="gt_row gt_right">−2.40</td>
<td headers="97.5%" class="gt_row gt_right">−2.29</td></tr>
    <tr><td headers="variable" class="gt_row gt_left" style="font-weight: bold; background-color: #E0FFFF;">treatment HR</td>
<td headers="2.5%" class="gt_row gt_right" style="font-weight: bold; background-color: #E0FFFF;">0.61</td>
<td headers="50%" class="gt_row gt_right" style="font-weight: bold; background-color: #E0FFFF;">0.86</td>
<td headers="97.5%" class="gt_row gt_right" style="font-weight: bold; background-color: #E0FFFF;">1.25</td></tr>
  </tbody>


</table>
</div><!--/html_preserve-->

<br>



<img src="figure-overview_slides-unnamed-chunk-39-1.png" alt="plot of chunk unnamed-chunk-39" style="display: block; margin: auto;" />

##

Our results did not change substantially after using
BDB. This is exactly what we would expect given how different our
populations are!

Let's explore baseline characteristics and see if we can identify ways
in which the internal and external control arms differ:

<center>


```
>                              Internal        External       Internal
> 1                              (N=50)         (N=350)        (N=100)
> 2                 cov1
> 3            Mean (SD)  0.540 (0.503)   0.740 (0.439)  0.630 (0.485)
> 4    Median [Min, Max] 1.00 [0, 1.00]  1.00 [0, 1.00] 1.00 [0, 1.00]
> 5                 cov2
> 6            Mean (SD)  0.200 (0.404)   0.500 (0.501)  0.370 (0.485)
> 7    Median [Min, Max]    0 [0, 1.00] 0.500 [0, 1.00]    0 [0, 1.00]
> 8                 cov3
> 9            Mean (SD)  0.760 (0.431)   0.403 (0.491)  0.760 (0.429)
> 10   Median [Min, Max] 1.00 [0, 1.00]     0 [0, 1.00] 1.00 [0, 1.00]
> 11                cov4
> 12           Mean (SD)  0.420 (0.499)   0.197 (0.398)  0.460 (0.501)
> 13   Median [Min, Max]    0 [0, 1.00]     0 [0, 1.00]    0 [0, 1.00]
>          Internal        External
> 1         (N=150)         (N=350)
> 2
> 3   0.600 (0.492)   0.740 (0.439)
> 4  1.00 [0, 1.00]  1.00 [0, 1.00]
> 5
> 6   0.313 (0.465)   0.500 (0.501)
> 7     0 [0, 1.00] 0.500 [0, 1.00]
> 8
> 9   0.760 (0.429)   0.403 (0.491)
> 10 1.00 [0, 1.00]     0 [0, 1.00]
> 11
> 12  0.447 (0.499)   0.197 (0.398)
> 13    0 [0, 1.00]     0 [0, 1.00]
```
</center>

##

There appear to be some differences. Let's use statistical adjustment
base on the propensity score to address this:


```r
ps_model <- glm(ext ~ cov1 + cov2 + cov3 + cov4,
  data = example_dataframe,
  family = binomial
)
```


```r
ps_model
>
> Call:  glm(formula = ext ~ cov1 + cov2 + cov3 + cov4, family = binomial,
>     data = example_dataframe)
>
> Coefficients:
> (Intercept)         cov1         cov2         cov3         cov4
>      1.4389       0.5840       0.7643      -1.5827      -1.1420
>
> Degrees of Freedom: 499 Total (i.e. Null);  495 Residual
> Null Deviance:	    610.9
> Residual Deviance: 508.1 	AIC: 518.1
```

##

We'll make a new matrix called `example_matrix_ps` which has 5 categories of
propensity score levels with approximately the same number of patients
in each.









```r
head(example_matrix_ps)
>         time cnsr trt ext ps_cat_low ps_cat_low_med ps_cat_high_med ps_cat_high
> 1  2.4226411    0   0   0          1              0               0           0
> 2 50.0000000    1   0   0          0              0               0           0
> 3  0.9674372    0   0   0          0              0               0           1
> 4 14.5774738    0   0   0          0              0               0           0
> 5 50.0000000    1   0   0          0              0               0           0
> 6 50.0000000    1   0   0          0              0               0           0
```


## Adjusting for covariates in `psborrow2`

To adjust for covariates, we'll use the costructor `add_covariates()`:


```r
add_covariates(
  covariates,
  priors
)
```

- `covariates`, Names of columns in the data matrix containing covariates to
be adjusted for
- `priors`, Either a single object of class `Prior` specifying the prior
distribution to apply to all covariates or a named list of distributions of
class `Prior`, one for each covariate

## Analysis object adjusting for propensity scores

Now let's create an `Analysis` object that adjusts for propensity scores:


```r
analysis_object_ps <- create_analysis_obj(
  data_matrix = example_matrix_ps,
  covariates = add_covariates(
    c("ps_cat_low", "ps_cat_low_med", "ps_cat_high_med", "ps_cat_high"),
    normal_prior(0, 10000)
  ),
  outcome = outcome_surv_exponential("time", "cnsr", normal_prior(0, 10000)),
  borrowing = borrowing_details("BDB", "ext", gamma_prior(0.001, 0.001)),
  treatment = treatment_details("trt", normal_prior(0, 10000))
)
```




```r
results_ps <- mcmc_sample(analysis_object_ps,
  iter_warmup = 1000,
  iter_sampling = 1000,
  chains = 1
)
```

##

It looks like we do indeed see a treatment effect when differences in the
distributions of baseline confounds are taken into consideration!

<br>

<!--html_preserve--><div id="hnkoknqrmw" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#hnkoknqrmw table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#hnkoknqrmw thead, #hnkoknqrmw tbody, #hnkoknqrmw tfoot, #hnkoknqrmw tr, #hnkoknqrmw td, #hnkoknqrmw th {
  border-style: none;
}

#hnkoknqrmw p {
  margin: 0;
  padding: 0;
}

#hnkoknqrmw .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#hnkoknqrmw .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#hnkoknqrmw .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#hnkoknqrmw .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#hnkoknqrmw .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#hnkoknqrmw .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hnkoknqrmw .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#hnkoknqrmw .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#hnkoknqrmw .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#hnkoknqrmw .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#hnkoknqrmw .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#hnkoknqrmw .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#hnkoknqrmw .gt_spanner_row {
  border-bottom-style: hidden;
}

#hnkoknqrmw .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#hnkoknqrmw .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#hnkoknqrmw .gt_from_md > :first-child {
  margin-top: 0;
}

#hnkoknqrmw .gt_from_md > :last-child {
  margin-bottom: 0;
}

#hnkoknqrmw .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#hnkoknqrmw .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#hnkoknqrmw .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#hnkoknqrmw .gt_row_group_first td {
  border-top-width: 2px;
}

#hnkoknqrmw .gt_row_group_first th {
  border-top-width: 2px;
}

#hnkoknqrmw .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#hnkoknqrmw .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#hnkoknqrmw .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#hnkoknqrmw .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hnkoknqrmw .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#hnkoknqrmw .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#hnkoknqrmw .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#hnkoknqrmw .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#hnkoknqrmw .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hnkoknqrmw .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#hnkoknqrmw .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#hnkoknqrmw .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#hnkoknqrmw .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#hnkoknqrmw .gt_left {
  text-align: left;
}

#hnkoknqrmw .gt_center {
  text-align: center;
}

#hnkoknqrmw .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#hnkoknqrmw .gt_font_normal {
  font-weight: normal;
}

#hnkoknqrmw .gt_font_bold {
  font-weight: bold;
}

#hnkoknqrmw .gt_font_italic {
  font-style: italic;
}

#hnkoknqrmw .gt_super {
  font-size: 65%;
}

#hnkoknqrmw .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#hnkoknqrmw .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#hnkoknqrmw .gt_indent_1 {
  text-indent: 5px;
}

#hnkoknqrmw .gt_indent_2 {
  text-indent: 10px;
}

#hnkoknqrmw .gt_indent_3 {
  text-indent: 15px;
}

#hnkoknqrmw .gt_indent_4 {
  text-indent: 20px;
}

#hnkoknqrmw .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>

    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="variable">variable</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="2.5%">2.5%</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="50%">50%</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="97.5%">97.5%</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="variable" class="gt_row gt_left">treatment log HR</td>
<td headers="2.5%" class="gt_row gt_right">−0.67</td>
<td headers="50%" class="gt_row gt_right">−0.35</td>
<td headers="97.5%" class="gt_row gt_right">−0.01</td></tr>
    <tr><td headers="variable" class="gt_row gt_left">commensurability parameter</td>
<td headers="2.5%" class="gt_row gt_right">0.06</td>
<td headers="50%" class="gt_row gt_right">44.47</td>
<td headers="97.5%" class="gt_row gt_right">1,573.35</td></tr>
    <tr><td headers="variable" class="gt_row gt_left">baseline log hazard rate, internal</td>
<td headers="2.5%" class="gt_row gt_right">−4.68</td>
<td headers="50%" class="gt_row gt_right">−4.17</td>
<td headers="97.5%" class="gt_row gt_right">−3.81</td></tr>
    <tr><td headers="variable" class="gt_row gt_left">baseline log hazard rate, external</td>
<td headers="2.5%" class="gt_row gt_right">−4.68</td>
<td headers="50%" class="gt_row gt_right">−4.18</td>
<td headers="97.5%" class="gt_row gt_right">−3.78</td></tr>
    <tr><td headers="variable" class="gt_row gt_left">ps_cat_low</td>
<td headers="2.5%" class="gt_row gt_right">−0.32</td>
<td headers="50%" class="gt_row gt_right">0.25</td>
<td headers="97.5%" class="gt_row gt_right">0.90</td></tr>
    <tr><td headers="variable" class="gt_row gt_left">ps_cat_low_med</td>
<td headers="2.5%" class="gt_row gt_right">0.64</td>
<td headers="50%" class="gt_row gt_right">1.05</td>
<td headers="97.5%" class="gt_row gt_right">1.55</td></tr>
    <tr><td headers="variable" class="gt_row gt_left">ps_cat_high_med</td>
<td headers="2.5%" class="gt_row gt_right">1.63</td>
<td headers="50%" class="gt_row gt_right">2.09</td>
<td headers="97.5%" class="gt_row gt_right">2.60</td></tr>
    <tr><td headers="variable" class="gt_row gt_left">ps_cat_high</td>
<td headers="2.5%" class="gt_row gt_right">2.49</td>
<td headers="50%" class="gt_row gt_right">2.92</td>
<td headers="97.5%" class="gt_row gt_right">3.43</td></tr>
    <tr><td headers="variable" class="gt_row gt_left" style="font-weight: bold; background-color: #E0FFFF;">treatment HR</td>
<td headers="2.5%" class="gt_row gt_right" style="font-weight: bold; background-color: #E0FFFF;">0.51</td>
<td headers="50%" class="gt_row gt_right" style="font-weight: bold; background-color: #E0FFFF;">0.70</td>
<td headers="97.5%" class="gt_row gt_right" style="font-weight: bold; background-color: #E0FFFF;">0.99</td></tr>
  </tbody>


</table>
</div><!--/html_preserve-->

##

The histogram of MCMC samples confirms this as well:

<br>

<img src="figure-overview_slides-unnamed-chunk-52-1.png" alt="plot of chunk unnamed-chunk-52" style="display: block; margin: auto;" />

## Summary of analyses



<img src="figure-overview_slides-unnamed-chunk-54-1.png" alt="plot of chunk unnamed-chunk-54" style="display: block; margin: auto;" />

# Demonstration of a simulation study

## Simulation study

We now turn to the question of how to design trials with BDB
in mind. Here, we will
create an object of class `Simulation` with `create_simulation_obj()`:


```r
create_simulation_obj(
  data_matrix_list,
  outcome,
  borrowing,
  treatment
)
```

If this looks similar to `create_analysis_obj()`, that is by design!

## `sim_data_list()`

The first argument we need to fill in
is `data_matrix_list`, created with `sim_data_list()`.


```r
sim_data_list(
  data_list,
  guide,
  effect,
  drift,
  index
)
```

The first argument is a list of lists of matrices. At the highest level,
we'll index different data generation parameters. At the lowest level,
we'll index different matrices generated with these parameters.

## `data_list`

This example `data_list` object is a
list of lists with two data generation scenarios (e.g., true
HR of 1.0 and true HR of 0.8).

<center>
![](data_list.jpg){width=80%}
</center>

##

Suppose we have a list of lists of simulated data called
`my_data_list`:



There are four scenarios.


```r
NROW(my_data_list)
> [1] 4
```

Each scenario has 100 matrices.


```r
NROW(my_data_list[[1]])
> [1] 100
```



```r
head(my_data_list[[1]][[1]], 3)
>      id ext trt     time status cnsr
> [1,]  1   0   0 8.179722      1    0
> [2,]  2   0   0 6.884286      1    0
> [3,]  3   0   0 2.348331      1    0
```

## Data generation guide

We also need to create a `guide` that explains
how the data were generated. In this example, the four scenarios are
summarized with the below `guide`:






```r
my_sim_data_guide
>   true_hr          drift_hr id
> 1     0.6       No drift HR  1
> 2     1.0       No drift HR  2
> 3     0.6 Moderate drift HR  3
> 4     1.0 Moderate drift HR  4
```

This guide implies that `my_sim_data_guide[[1]]` is a list of
matrices where the treatment HR was 0.6 and the drift HR was 1.0.

##

Finally, we need to specify where in the `guide` three important features are:
the true hazard ratio, the drift hazard ratio, and the index. These are all
the columns we have in our guide, so we simply specify the column names:


```r
my_sim_data_list <- sim_data_list(
  data_list = my_data_list,
  guide = my_sim_data_guide,
  effect = "true_hr",
  drift = "drift_hr",
  index = "id"
)
```


```r
my_sim_data_list
> SimDataList object with  4  different scenarios
>   true_hr          drift_hr id n_datasets_per_param
> 1     0.6       No drift HR  1                  100
> 2     1.0       No drift HR  2                  100
> 3     0.6 Moderate drift HR  3                  100
> 4     1.0 Moderate drift HR  4                  100
```

## Borrowing list

For this simulation study, let's focus on comparing four borrowing methods:

* No borrowing
* BDB, conservative hyperprior
* BDB, aggressive hyperprior
* Full borrowing

How do we specify that we want to evaluate multiple borrowing methods?
We'll use a special list of `Borrowing` objects,
which we'll create through the function `sim_borrowing_list()`.

##

`sim_borrowing_list()` needs a named list of `Borrowing` objects:


```r
my_borrowing_list <- sim_borrowing_list(
  list(
    "No borrowing" = borrowing_details("No borrowing", "ext"),
    "Full borrowing" = borrowing_details("Full borrowing", "ext"),
    "BDB - conservative" = borrowing_details("BDB", "ext", gamma_prior(0.001, 0.001)),
    "BDB - aggressive" = borrowing_details("BDB", "ext", gamma_prior(1, 0.001))
  )
)
```


```r
my_borrowing_list
> SimBorrowingList object with  4  different scenario(s)
>   borrowing_scenario
> 1       No borrowing
> 2     Full borrowing
> 3 BDB - conservative
> 4   BDB - aggressive
```

##

Note, in this example we'll only pass a list of `Borrowing` objects, but
similar constructors exist for other `psborrow2` objects:


```r
sim_treatment_list()
sim_covariate_list()
sim_outcome_list()
```

*Note*: If you do not want to vary parameters in your simulation study,
you can simply pass an unlisted object. That is, you could call
`borrowing_details()` instead of `sim_borrowing_list()`.

## `create_simulation_obj()`

Now, let's create a `Simulation` object:


```r
simulation_obj <- create_simulation_obj(
  my_sim_data_list,
  outcome = outcome_surv_exponential("time",
    "cnsr",
    baseline_prior = normal_prior(0, 10000)
  ),
  borrowing = my_borrowing_list,
  treatment = treatment_details(
    trt_flag_col = "trt",
    trt_prior = normal_prior(0, 10000)
  )
)
```

## `mcmc_sample()`

As with `Analysis` objects, the next step for us with `Simulation` objects
is to call `mcmc_sample()`:




```r
simulation_res <- mcmc_sample(
  simulation_obj,
  iter_warmup = 1000,
  iter_sampling = 1000,
  chains = 1
)
```

You'll note the simulation study results are a special `psborrow2` class,
<b>NOT</b> a `CmdStanMCMC` object (as with `Analysis` objects).


```r
simulation_res
> `MCMCSimulationResult` object.  Call `get_results()` to save outputs as a data.frame
```

##

Let's get a useful `data.frame` of results by calling `get_results`:


```r
simulation_res_df <- get_results(simulation_res)
```



## Simulation study results

Let's see what exactly is contained in the results.


```r
colnames(simulation_res_df)
>  [1] "true_hr"              "drift_hr"             "id"
>  [4] "n_datasets_per_param" "outcome_scenario"     "borrowing_scenario"
>  [7] "covariate_scenario"   "treatment_scenario"   "mse_mean"
> [10] "bias_mean"            "null_coverage"        "true_coverage"
```

* `mse_mean`, the mean MSE for results
* `bias_mean`, the mean bias for the results
* `null_coverage`, the proportion of results that contain the null effect (1.0)
in the specified credible interval quantiles (default are 0.025 - 0.975)
* `true_coverage`, the proportion of results that contain the true effect
in the specified credible interval quantiles (default are 0.025 - 0.975)

##

Let's look at the number of parameter combinations that were evaluated:


```r
NROW(simulation_res_df)
> [1] 16
```


```r
head(simulation_res_df, 2)
>   true_hr    drift_hr id n_datasets_per_param outcome_scenario
> 1     0.6 No drift HR  1                  100          default
> 2     1.0 No drift HR  2                  100          default
>   borrowing_scenario covariate_scenario treatment_scenario   mse_mean
> 1       No borrowing      No adjustment            default 0.05857251
> 2       No borrowing      No adjustment            default 0.12906304
>    bias_mean null_coverage true_coverage
> 1 0.05870855          0.50          0.97
> 2 0.03200872          0.97          0.97
```

This makes sense as we had
4 scenarios in our data generation step and
4 in our borrowing step. The cartesian
product is 16.

## MSE

We can use the results to plot MSE by scenario as below:

<img src="figure-overview_slides-unnamed-chunk-78-1.png" alt="plot of chunk unnamed-chunk-78" style="display: block; margin: auto;" />

## Type I error

Because we included a true HR of 1.0, we can evaluate type I error by looking
at the compliment to the true parameter coverage:

<img src="figure-overview_slides-unnamed-chunk-79-1.png" alt="plot of chunk unnamed-chunk-79" style="display: block; margin: auto;" />

## Power

We can include power by looking at the results for our true simulation of 0.6.

<img src="figure-overview_slides-unnamed-chunk-80-1.png" alt="plot of chunk unnamed-chunk-80" style="display: block; margin: auto;" />

# Installing `psborrow2`

##
`psborrow2` can be installed from GitHub with:


```r
devtools::install_git("https://github.com/Genentech/psborrow2")
```

Feedback can be provided through GitHub issues:

`https://github.com/Genentech/psborrow2/issues`

The vignettes can be accessed with:


```r
browseVignettes("psborrow2")
```

# Thank you!
