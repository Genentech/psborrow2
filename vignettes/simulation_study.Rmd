---
title: "Conduct a simulation study"
author: "Matt Secrest, Yichen Lu, Isaac Gravestock"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{4. Conduct a simulation study}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#"
)
options(rmarkdown.html_vignette.check_title = FALSE)
```

In this vignette, you'll learn how to use `psborrow2` to create a
simulation study with the goal of informing trial design. Let's start by
loading `psborrow2`:

```{r setup, message = FALSE}
library(psborrow2)
```

# Bringing your own simulated data

We'll start by showing how to conduct a simulation study when you bring your
own simulated data. To execute a simulation study with your own data,
we need to build an object of class `Simulation` using the function
`create_simulation_obj()`. Let's look at the arguments to
`create_simulation_obj()` and consider them one-by-one below:

```
create_simulation_obj(
  sim_data_list,
  sim_outcome_list,
  sim_borrowing_list,
  sim_covariate_list,
  sim_trt_list
)

```

## `sim_data_list()`

`sim_data_list()` is where you input the data you will be using for the
simulation study. Let's simulate some data together for the sake of example.
We'll use the `simsurv` package to generate survival data under two
scenarios: a true hazard ratio (HR) for the treatment effect of 0.6 and a true
HR of 0.8.

### `data_list`

Looking at the arguments to `sim_data_list()`, the first argument, `data_list`
requires a list of lists of matrices. Each list of matrices should represent
a different data generation scenario, such as our difference true HR.
Therefore, let's create an object `data_list` that is length two:
one list for a HR of 0.6, and one for a HR of 0.8. Within
these lists, we can provide any number of matrices, but we'll only do
two for the sake of ease.

```{r}
library(simsurv)
library(survival)

# Simulate a single matrix
sim_single_matrix <- function(true_hr = 0.6,
                              drift_hr = 1.0,
                              n = 600) {
  # Create a data frame with the subject IDs and treatment covariate
  cov <- data.frame(
    id = 1:n,
    trt = rbinom(n, 1, 0.5)
  )
  cov$ext <- ifelse(cov$trt == 1L, 0L, rbinom(sum(cov$trt), 1, 0.5))

  # Simulate the event times
  dat <- simsurv(
    lambdas = 0.1,
    gammas = 1.5,
    betas = c(
      trt = log(true_hr),
      ext = log(drift_hr)
    ),
    x = cov,
    maxt = 5
  )

  dat$censor <- 1 - dat$status

  # Merge the simulated event times onto covariate data frame
  dat <- merge(cov, dat)

  as.matrix(dat)
}

# Set seed
set.seed(112233)

# Create data list
data_list <- list(
  list(sim_single_matrix(true_hr = 0.6), sim_single_matrix(true_hr = 0.6)),
  list(sim_single_matrix(true_hr = 0.8), sim_single_matrix(true_hr = 0.8))
)
```

As you can see, `data_list` is a list of list of matrices, the correct format
for inputting into `sim_data_list()`:

```{r}
str(data_list)
```

At the lowest level are matrices of simulated data:
```{r}
head(data_list[[1]][[1]])
```

### `guide`
In order to summarize the results from the different parameters in
your simulation study, `psborrow2` needs to know how the simulation parameters
differ. That is the purpose of the argument `guide`, which is a data.frame
that distinguishes the simulation study parameters. Two columns are required
in `guide`, though many more can be provided. The two required columns are:

* The true treatment effect (in our case a HR)
* The true drift effect (in our case a HR). Drift effects >1 will mean
that the external control arm experiences greater hazard than the internal
control arm.

In our study, the drift HR was 1.0. We varied the true HR so that it took
two values: 0.6 and 0.8. Our guide should therefore be two rows to represent
the two scenarios:

```{r}
guide <- data.frame(
  trueHR = c(0.6, 0.8),
  driftHR = c(1.0, 1.0)
)

guide
```


***Note*** the order is extremely important in `guide` and should correspond
exactly to the order in your simulated data. For us, the scenario with
a true HR of 0.6 was the first list element in our `data_list` and should
therefore be the first row of `guide`.

### `effect` and `drift`

The last two inputs to `sim_data_list()`, `effect` and `drift`
are the column names in `guide` that correspond to the true treatment effect
and true drift effect, respectively. For our study, these are `"trueHR"`
and `"driftHR"`, respectively.

Putting it all together, we can create an object of class `SimDataList`:

```{r}
sdl <- sim_data_list(
  data_list,
  guide,
  "trueHR",
  "driftHR"
)

sdl
```

## `sim_covariate_list()`

`sim_covariate_list()` is where you input details on which covariates to
adjust for in your simulation study outcome models. Note that we did not
simulate any covariates, so we will leave this argument empty.
