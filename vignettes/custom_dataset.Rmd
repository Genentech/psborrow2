---
title: "Conduct a hybrid control analysis on a custom dataset using BDB"
author: "Matt Secrest and Isaac Gravestock"
output:   
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{custom dataset}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In this article, you'll learn how to conduct Bayesian dynamic borrowing (BDB) 
analyses on a custom dataset using `psborrow2`.

# Load dependancies and setup Stan

We'll start by loading dependencies. `psborrow2` relies on the package
`cmdstanr`, so we load [`cmdstanr`](https://mc-stan.org/cmdstanr/index.html)
as well.

```{r dependancies, message = FALSE}
library(psborrow2)
library(cmdstanr)
```

*Note*: As explained in the 
[`cmstanr` vignettes](https://mc-stan.org/cmdstanr/articles/cmdstanr.html), 
installing `cmdstanr` does not install the underlying CMD Stan program we need.
To install this, we will call the `cmdstanr` function `install_cmdstan()`:

```{r install_cmdstan-1, include = FALSE}
if (!dir.exists(cmdstan_default_path())) {
  install_cmdstan()
}
```

```{r install_cmdstan-2, eval=FALSE}
install_cmdstan(cores = 2)
```

# The end goal
For an analysis on custom data in `psborrow2`, our goal is to create an object
of class `Analysis` which contains all the information we need to build a model
and compile an MCMC sampler using Stan. To create an `Analysis` object, 
we need to call the function `create_analysis_obj()`. Let's look at the four
required arguments to this function and evaluate them one at a time.

```
create_analysis_obj(
  data_matrix,
  outcome,
  borrowing,
  treatment
)
```

# Prepare data for `data_matrix`

## Required elements

### All matrices

`data_matrix` is where we input the one-row-per-patient data matrix for our 
analysis. There are two columns required for all analyses:

* A flag denoting receipt of the experimental intervention (`1`) or not (`0`)
* A flag denoting whether the patient was part of the external data source 
(`1`) or the internal trial (`0`).

`psborrow2` supports time-to-event endpoints as well as binary endpoints. 

### Time to event
If the outcome is time-to-event, then two additional columns are needed:

* The duration of follow-up for each patient
* A flag denoting the patient was censored (`1`) or not (`0`)

### Binary endpoints
If the outcome is binary, one additional column is needed

* A flag denoting a patient had the event of interest (`1`) or not (`0`)

### Covariates

Covariates may also be included in BDB analyses. These should be included
in the data matrix if the plan is to adjust for them.

*Note* R data frames are not allowed, only matrices.
*Note* No missing data is currently allowed, all values must be non-missing.

## Example data

We will be using an example dataset stored in `psborrow2` 
(`psborrow2::example_matrix`). Data frames and tibbles may be 
cast to matrices easily with the `psborrow2` helper function 
`create_data_matrix()`.

Let's look at the first few rows of the example matrix:

```{r}
head(example_matrix)
```

# Specify outcomes

`psborrow2` supports three outcomes, each of which has its own function
that is passed to the argument `outcome` in `create_analysis_obj()`.

* Time to event with exponential distribution (constant hazard), created with
`exp_surv_dist()`
* Time to event with Weibull distribution and proportional hazards
formulation, created with `weib_ph_surv_dist()`
* Binary endpoints with a bernoulli distribution (logistic regression), 
created with `logistic_bin_outcome()`

For our example, let's conduct a time-to-event analysis using the exponential
distribution. We will specify a couple of arguments
to `weib_ph_surv_dist()`:

* `time_var`, the name of the column in our example matrix that represents 
time to event or censorship. In our case it is 'time'.
* `cens_var`, the name of the column in our example matrix that represents 
censorship flag. In our case it is 'cnsr'.

*Note:* The Weibull proportional hazards distribution has ancillary parameters
that must also be specified.

```{r}
exp_outcome <- exp_surv_dist(time_var = "time",
                             cens_var = "cnsr")
```




