<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="psborrow2">
<title>Incorporating propensity scores analysis in psborrow2 • psborrow2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Incorporating propensity scores analysis in psborrow2">
<meta property="og:description" content="psborrow2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-125641273-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-125641273-1');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">psborrow2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/psborrow2.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/dataset.html">Conduct a hybrid control analysis on a dataset using BDB</a>
    <a class="dropdown-item" href="../articles/prior_distributions.html">Specifying prior distributions</a>
    <a class="dropdown-item" href="../articles/propensity_scores.html">Incorporating propensity scores analysis in psborrow2</a>
    <a class="dropdown-item" href="../articles/simulation_study.html">Conduct a simulation study</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<!-- start dropdown for versions --> <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle"
          data-bs-toggle="dropdown" role="button"
          aria-expanded="false" aria-haspopup="true"
          id="dropdown-versions">Versions</a> <div class="dropdown-menu" aria-labelledby="dropdown-versions"> <a class="dropdown-item" data-toggle="tooltip" title="" href="https://Genentech.github.io/psborrow2/develop">develop</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://Genentech.github.io/psborrow2/main">main</a> </div></li>
<!-- end dropdown for versions -->
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Genentech/psborrow2">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Incorporating propensity scores analysis in psborrow2</h1>
                        <h4 data-toc-skip class="author">Isaac
Gravestock</h4>
            
      
      
      <div class="d-none name"><code>propensity_scores.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">psborrow2</span><span class="op">)</span></span></code></pre></div>
<p>Propensity scores (PS) methods offer various ways to adjust analyses
for differences in groups of patients.</p>
<p><span class="citation">Austin (<a href="#ref-austin2013" role="doc-biblioref">2013</a>)</span> discusses various approaches for
using PS with survival analyses to obtain effect measures similar to
randomized controlled trials.</p>
<p><span class="citation">Wang et al. (<a href="#ref-wang2021" role="doc-biblioref">2021</a>)</span> discuss using PS for IPTW,
matching and stratification in combination with a Bayesian analysis.
These methods allow for the separation of the design and analysis into
two stages, which may be attractive in a regulatory setting.</p>
<p>Another approach is the direct inclusion of the PS as a covariate in
the outcome model.</p>
<div class="section level2">
<h2 id="propensity-score-calculation">Propensity Score Calculation<a class="anchor" aria-label="anchor" href="#propensity-score-calculation"></a>
</h2>
<p>Propensity scores are the probabilities that an observation belongs
to one group or another, in this setting the internal or external
patients. The PS models are fitted based on baseline covariates that
could be confounders between outcome and being in the internal/external
group.</p>
<p>The simplest approach for calculating PS is a logistic generalized
linear model. First, let’s load some demo data from
<code>psborrow2</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_data</span> <span class="op">&lt;-</span> <span class="va">example_surv</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">my_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   trt ext eventtime status censor cov1 cov2      cov3</span></span>
<span><span class="co">#&gt; 1   0   1 24.000000      0      1    0    7 13.551859</span></span>
<span><span class="co">#&gt; 2   1   0 24.000000      0      1    1    6  7.517466</span></span>
<span><span class="co">#&gt; 3   0   1  9.468386      1      0    0    7  4.884504</span></span>
<span><span class="co">#&gt; 4   0   0  8.841009      1      0    0    7  5.631334</span></span>
<span><span class="co">#&gt; 5   0   0 13.559467      1      0    1   12  8.312818</span></span>
<span><span class="co">#&gt; 6   1   0 24.000000      0      1    0   12 13.539768</span></span></code></pre></div>
<p>Let’s now fit a logistic generalized linear model and add the PS as
an additional covariate.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ps_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">ext</span> <span class="op">~</span> <span class="va">cov1</span> <span class="op">+</span> <span class="va">cov2</span> <span class="op">+</span> <span class="va">cov3</span>, data <span class="op">=</span> <span class="va">my_data</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span>
<span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">ps_model</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span><span class="va">my_data</span><span class="op">$</span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="va">ps</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">my_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   trt ext eventtime status censor cov1 cov2      cov3        ps</span></span>
<span><span class="co">#&gt; 1   0   1 24.000000      0      1    0    7 13.551859 0.4694384</span></span>
<span><span class="co">#&gt; 2   1   0 24.000000      0      1    1    6  7.517466 0.4005745</span></span>
<span><span class="co">#&gt; 3   0   1  9.468386      1      0    0    7  4.884504 0.4192069</span></span>
<span><span class="co">#&gt; 4   0   0  8.841009      1      0    0    7  5.631334 0.4234848</span></span>
<span><span class="co">#&gt; 5   0   0 13.559467      1      0    1   12  8.312818 0.5332824</span></span>
<span><span class="co">#&gt; 6   1   0 24.000000      0      1    0   12 13.539768 0.5765787</span></span></code></pre></div>
<p>The calculated PS can be included as a covariate in the analysis
object, for the “covariate adjustment” PS approach:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_data_matrix.html">create_data_matrix</a></span><span class="op">(</span></span>
<span>  <span class="va">my_data</span>,</span>
<span>  covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cov1"</span>, <span class="st">"cov2"</span>, <span class="st">"cov3"</span>, <span class="st">"ps"</span><span class="op">)</span>,</span>
<span>  ext_flag_col <span class="op">=</span> <span class="st">"ext"</span>,</span>
<span>  outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"eventtime"</span>, <span class="st">"censor"</span><span class="op">)</span>,</span>
<span>  trt_flag_col <span class="op">=</span> <span class="st">"trt"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Call `add_covariates()` with `covariates =  c("cov1", "cov2", "cov3", "ps") `</span></span>
<span></span>
<span><span class="va">analysis_object</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_analysis_obj.html">create_analysis_obj</a></span><span class="op">(</span></span>
<span>  data_matrix <span class="op">=</span> <span class="va">data_mat</span>,</span>
<span>  covariates <span class="op">=</span> <span class="fu"><a href="../reference/add_covariates.html">add_covariates</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cov1"</span>, <span class="st">"cov2"</span>, <span class="st">"cov3"</span>, <span class="st">"ps"</span><span class="op">)</span>,</span>
<span>    priors <span class="op">=</span> <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  borrowing <span class="op">=</span> <span class="fu"><a href="../reference/borrowing_details.html">borrowing_details</a></span><span class="op">(</span><span class="st">"BDB"</span>,</span>
<span>    ext_flag_col <span class="op">=</span> <span class="st">"ext"</span>,</span>
<span>    tau_prior <span class="op">=</span> <span class="fu"><a href="../reference/gamma_prior.html">gamma_prior</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  treatment <span class="op">=</span> <span class="fu"><a href="../reference/treatment_details.html">treatment_details</a></span><span class="op">(</span><span class="st">"trt"</span>, <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  outcome <span class="op">=</span> <span class="fu"><a href="../reference/weib_ph_surv_dist.html">weib_ph_surv_dist</a></span><span class="op">(</span><span class="st">"eventtime"</span>, <span class="st">"censor"</span>,</span>
<span>    shape_prior <span class="op">=</span> <span class="fu"><a href="../reference/exponential_prior.html">exponential_prior</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>    baseline_prior <span class="op">=</span> <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Inputs look good.</span></span>
<span><span class="co">#&gt; Stan program compiled successfully!</span></span>
<span><span class="co">#&gt; Ready to go! Now call `mcmc_sample()`.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="other-ps-analyses">Other PS Analyses<a class="anchor" aria-label="anchor" href="#other-ps-analyses"></a>
</h2>
<p>For more complex PS analyses, we can use one of the dedicated R
packages.</p>
<div class="section level3">
<h3 id="psweight">PSweight<a class="anchor" aria-label="anchor" href="#psweight"></a>
</h3>
<p>The <a href="https://cran.r-project.org/package=PSweight" class="external-link">PSweight</a> package
can calculate PS using other model fitting approaches than the simple
glm described above. It also provides some summary statistics and plots.
For example we can use a generalized boosted regression model (gbm):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/thuizhou/PSweight" class="external-link">PSweight</a></span><span class="op">)</span></span>
<span><span class="va">my_data2</span> <span class="op">&lt;-</span> <span class="va">example_surv</span></span>
<span><span class="va">psw_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PSweight/man/SumStat.html" class="external-link">SumStat</a></span><span class="op">(</span><span class="va">ext</span> <span class="op">~</span> <span class="va">cov1</span> <span class="op">+</span> <span class="va">cov2</span> <span class="op">+</span> <span class="va">cov3</span>, data <span class="op">=</span> <span class="va">my_data2</span>, method <span class="op">=</span> <span class="st">"gbm"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">psw_model</span><span class="op">)</span></span>
<span><span class="co">#&gt; unweighted result</span></span>
<span><span class="co">#&gt;      Mean 0 Mean 1   SMD</span></span>
<span><span class="co">#&gt; cov1  0.514  0.500 0.028</span></span>
<span><span class="co">#&gt; cov2  5.804  6.607 0.297</span></span>
<span><span class="co">#&gt; cov3  5.663  6.692 0.240</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; overlap result</span></span>
<span><span class="co">#&gt;      Mean 0 Mean 1   SMD</span></span>
<span><span class="co">#&gt; cov1  0.499  0.500 0.000</span></span>
<span><span class="co">#&gt; cov2  6.295  6.344 0.018</span></span>
<span><span class="co">#&gt; cov3  6.228  6.348 0.028</span></span></code></pre></div>
<p>A plot of the distributions shows there is good overlap between the
scores between both groups.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">psw_model</span>, type <span class="op">=</span> <span class="st">"density"</span><span class="op">)</span></span></code></pre></div>
<p><img src="propensity_scores_files/figure-html/psweight_plot-1.png" width="50%" style="display: block; margin: auto;"><img src="propensity_scores_files/figure-html/psweight_plot-2.png" width="50%" style="display: block; margin: auto;"></p>
<p>The PS values can be copied into the data set and the analysis object
can be constructed as before.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_data2</span><span class="op">$</span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="va">psw_model</span><span class="op">$</span><span class="va">propensity</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span></code></pre></div>
<p>This package can also trim the data.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">psw_trimmed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PSweight/man/PStrim.html" class="external-link">PStrim</a></span><span class="op">(</span><span class="va">ext</span> <span class="op">~</span> <span class="va">cov1</span> <span class="op">+</span> <span class="va">cov2</span> <span class="op">+</span> <span class="va">cov3</span>, data <span class="op">=</span> <span class="va">my_data2</span>, delta <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">psw_trimmed</span></span>
<span><span class="co">#&gt; Summary of the trimming:</span></span>
<span><span class="co">#&gt;            0   1</span></span>
<span><span class="co">#&gt; trimmed    0   0</span></span>
<span><span class="co">#&gt; remained 358 242</span></span></code></pre></div>
<p>Since there is a reasonable overlap between the data, only 5 patients
were trimmed.</p>
<p>As before this can be used for in the analysis by creating a suitable
data matrix.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/create_data_matrix.html">create_data_matrix</a></span><span class="op">(</span></span>
<span>  <span class="va">psw_trimmed</span><span class="op">$</span><span class="va">data</span>,</span>
<span>  covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cov1"</span>, <span class="st">"cov2"</span>, <span class="st">"cov3"</span>, <span class="st">"ps"</span><span class="op">)</span>,</span>
<span>  ext_flag_col <span class="op">=</span> <span class="st">"ext"</span>,</span>
<span>  outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"eventtime"</span>, <span class="st">"censor"</span><span class="op">)</span>,</span>
<span>  trt_flag_col <span class="op">=</span> <span class="st">"trt"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Call `add_covariates()` with `covariates =  c("cov1", "cov2", "cov3", "ps") `</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="matchit">MatchIt<a class="anchor" aria-label="anchor" href="#matchit"></a>
</h3>
<p>A variety of matching methods, including PS matching are implemented
in the <a href="https://cran.r-project.org/package=MatchIt" class="external-link">MatchIt</a>
package.</p>
<p>As described in the <a href="https://cran.r-project.org/web/packages/MatchIt/vignettes/MatchIt.html" class="external-link">Getting
Started vignette</a>, it can be useful to check the imbalance before
matching.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://kosukeimai.github.io/MatchIt/" class="external-link">MatchIt</a></span><span class="op">)</span></span>
<span><span class="co"># No matching; constructing a pre-match matchit object</span></span>
<span><span class="va">no_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html" class="external-link">matchit</a></span><span class="op">(</span><span class="va">trt</span> <span class="op">~</span> <span class="va">cov1</span> <span class="op">+</span> <span class="va">cov2</span> <span class="op">+</span> <span class="va">cov3</span>,</span>
<span>  data <span class="op">=</span> <span class="va">example_surv</span>,</span>
<span>  method <span class="op">=</span> <span class="cn">NULL</span>, distance <span class="op">=</span> <span class="st">"glm"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">no_match</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; matchit(formula = trt ~ cov1 + cov2 + cov3, data = example_surv, </span></span>
<span><span class="co">#&gt;     method = NULL, distance = "glm")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for All Data:</span></span>
<span><span class="co">#&gt;          Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance        0.4246        0.2877          0.8238     1.0491    0.2234</span></span>
<span><span class="co">#&gt; cov1            0.5350        0.4950          0.0802          .    0.0400</span></span>
<span><span class="co">#&gt; cov2            4.7400        6.8225         -0.9420     0.6640    0.1302</span></span>
<span><span class="co">#&gt; cov3            4.5484        6.8425         -0.6058     0.7777    0.1557</span></span>
<span><span class="co">#&gt;          eCDF Max</span></span>
<span><span class="co">#&gt; distance   0.3350</span></span>
<span><span class="co">#&gt; cov1       0.0400</span></span>
<span><span class="co">#&gt; cov2       0.3100</span></span>
<span><span class="co">#&gt; cov3       0.2525</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample Sizes:</span></span>
<span><span class="co">#&gt;           Control Treated</span></span>
<span><span class="co">#&gt; All           400     200</span></span>
<span><span class="co">#&gt; Matched       400     200</span></span>
<span><span class="co">#&gt; Unmatched       0       0</span></span>
<span><span class="co">#&gt; Discarded       0       0</span></span></code></pre></div>
<p>Here we are matching treated to untreated to select the most
comparable control group, regardless of whether they are internal or
external.</p>
<p>Now we can try a 1:1 nearest matching approach.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">match_11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html" class="external-link">matchit</a></span><span class="op">(</span><span class="va">trt</span> <span class="op">~</span> <span class="va">cov1</span> <span class="op">+</span> <span class="va">cov2</span> <span class="op">+</span> <span class="va">cov3</span>,</span>
<span>  data <span class="op">=</span> <span class="va">example_surv</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"nearest"</span>, distance <span class="op">=</span> <span class="st">"glm"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">match_11</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; matchit(formula = trt ~ cov1 + cov2 + cov3, data = example_surv, </span></span>
<span><span class="co">#&gt;     method = "nearest", distance = "glm")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for All Data:</span></span>
<span><span class="co">#&gt;          Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance        0.4246        0.2877          0.8238     1.0491    0.2234</span></span>
<span><span class="co">#&gt; cov1            0.5350        0.4950          0.0802          .    0.0400</span></span>
<span><span class="co">#&gt; cov2            4.7400        6.8225         -0.9420     0.6640    0.1302</span></span>
<span><span class="co">#&gt; cov3            4.5484        6.8425         -0.6058     0.7777    0.1557</span></span>
<span><span class="co">#&gt;          eCDF Max</span></span>
<span><span class="co">#&gt; distance   0.3350</span></span>
<span><span class="co">#&gt; cov1       0.0400</span></span>
<span><span class="co">#&gt; cov2       0.3100</span></span>
<span><span class="co">#&gt; cov3       0.2525</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for Matched Data:</span></span>
<span><span class="co">#&gt;          Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance        0.4246        0.3979          0.1607     1.3369    0.0313</span></span>
<span><span class="co">#&gt; cov1            0.5350        0.5400         -0.0100          .    0.0050</span></span>
<span><span class="co">#&gt; cov2            4.7400        5.0450         -0.1380     1.2490    0.0203</span></span>
<span><span class="co">#&gt; cov3            4.5484        5.1457         -0.1577     0.8926    0.0444</span></span>
<span><span class="co">#&gt;          eCDF Max Std. Pair Dist.</span></span>
<span><span class="co">#&gt; distance    0.125          0.1621</span></span>
<span><span class="co">#&gt; cov1        0.005          1.0325</span></span>
<span><span class="co">#&gt; cov2        0.100          0.2013</span></span>
<span><span class="co">#&gt; cov3        0.090          0.8468</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample Sizes:</span></span>
<span><span class="co">#&gt;           Control Treated</span></span>
<span><span class="co">#&gt; All           400     200</span></span>
<span><span class="co">#&gt; Matched       200     200</span></span>
<span><span class="co">#&gt; Unmatched     200       0</span></span>
<span><span class="co">#&gt; Discarded       0       0</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">match_11</span>, type <span class="op">=</span> <span class="st">"jitter"</span>, interactive <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="propensity_scores_files/figure-html/matchit_jitter-1.png" width="768" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">match_11</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"qq"</span>, interactive <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  which.xs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cov1"</span>, <span class="st">"cov2"</span>, <span class="st">"cov3"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="propensity_scores_files/figure-html/matchit_qq-1.png" width="768" style="display: block; margin: auto;"></p>
<p>Determining whether the balance after matching is appropriate is
beyond the scope of this vignette. You can read more in the <a href="https://cran.r-project.org/web/packages/MatchIt/vignettes/assessing-balance.html" class="external-link">MatchIt
Assessing Balance vignette</a>. Another useful package is <a href="https://cran.r-project.org/package=cobalt" class="external-link">cobalt</a>, which
provides tools for assessing balance between groups after weighting or
matching. It is compatible with many matching and weighting packaes. See
the <a href="https://cran.r-project.org/web/packages/cobalt/vignettes/cobalt.html" class="external-link">vignette</a>
for more details.</p>
<p>However, if you are happy with the results of the matching procedure,
you can extract the data for use in psborrow2.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/create_data_matrix.html">create_data_matrix</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">example_surv</span><span class="op">[</span><span class="va">match_11</span><span class="op">$</span><span class="va">weights</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span>,</span>
<span>  covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cov1"</span>, <span class="st">"cov2"</span>, <span class="st">"cov3"</span><span class="op">)</span>,</span>
<span>  ext_flag_col <span class="op">=</span> <span class="st">"ext"</span>,</span>
<span>  outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"eventtime"</span>, <span class="st">"censor"</span><span class="op">)</span>,</span>
<span>  trt_flag_col <span class="op">=</span> <span class="st">"trt"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Call `add_covariates()` with `covariates =  c("cov1", "cov2", "cov3") `</span></span></code></pre></div>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-austin2013" class="csl-entry">
Austin, Peter C. 2013. <span>“The Use of Propensity Score Methods with
Survival or Time<span>-</span>to<span>-</span>Event Outcomes: Reporting
Measures of Effect Similar to Those Used in Randomized
Experiments.”</span> <em>Statistics in Medicine</em> 33 (7): 1242–58. <a href="https://doi.org/10.1002/sim.5984" class="external-link">https://doi.org/10.1002/sim.5984</a>.
</div>
<div id="ref-wang2021" class="csl-entry">
Wang, Xi, Leah Suttner, Thomas Jemielita, and Xiaoyun Li. 2021.
<span>“Propensity Score-Integrated Bayesian Prior Approaches for
Augmented Control Designs: A Simulation Study.”</span> <em>Journal of
Biopharmaceutical Statistics</em> 32 (1): 170–90. <a href="https://doi.org/10.1080/10543406.2021.2011743" class="external-link">https://doi.org/10.1080/10543406.2021.2011743</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Matt Secrest, Isaac Gravestock.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
