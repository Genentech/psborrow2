<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="psborrow2">
<title>5. Incorporating propensity scores analysis in psborrow2 • psborrow2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="5. Incorporating propensity scores analysis in psborrow2">
<meta property="og:description" content="psborrow2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-125641273-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-125641273-1');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">psborrow2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/psborrow2.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/index.html">Articles</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<!-- start dropdown for versions --> <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle"
          data-bs-toggle="dropdown" role="button"
          aria-expanded="false" aria-haspopup="true"
          id="dropdown-versions">Versions</a> <div class="dropdown-menu" aria-labelledby="dropdown-versions"> <a class="dropdown-item" data-toggle="tooltip" title="" href="https://Genentech.github.io/psborrow2/develop">develop</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://Genentech.github.io/psborrow2/main">main</a> </div></li>
<!-- end dropdown for versions -->
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Genentech/psborrow2">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>5. Incorporating propensity scores analysis in psborrow2</h1>
                        <h4 data-toc-skip class="author">Isaac
Gravestock and Matt Secrest</h4>
            
      
      
      <div class="d-none name"><code>propensity_scores.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">psborrow2</span><span class="op">)</span></span></code></pre></div>
<p>Propensity scores (PS) methods offer various ways to adjust analyses
for differences in groups of patients.</p>
<p><span class="citation">Austin (<a href="#ref-austin2013">2013</a>)</span> discusses various approaches for
using PS with survival analyses to obtain effect measures similar to
randomized controlled trials.</p>
<p><span class="citation">Wang et al. (<a href="#ref-wang2021">2021</a>)</span> discuss using PS for IPTW,
matching and stratification in combination with a Bayesian analysis.
These methods allow for the separation of the design and analysis into
two stages, which may be attractive in a regulatory setting.</p>
<p>Another approach is the direct inclusion of the PS as a covariate in
the outcome model.</p>
<div class="section level3">
<h3 id="propensity-score-calculation">Propensity Score Calculation<a class="anchor" aria-label="anchor" href="#propensity-score-calculation"></a>
</h3>
<p>Propensity scores are the probabilities that an observation belongs
to one group or another, in this setting the internal or external
patients. The PS models are fitted based on baseline covariates that
could be confounders between outcome and being in the internal/external
group.</p>
<p>The simplest approach for calculating PS is a logistic generalized
linear model. First, let’s load some demo data from
<code>psborrow2</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_dataframe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">example_matrix</span><span class="op">)</span></span>
<span><span class="va">example_dataframe</span><span class="op">$</span><span class="va">int</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">example_dataframe</span><span class="op">$</span><span class="va">ext</span></span></code></pre></div>
<p>Let’s now fit a logistic generalized linear model and add the PS as
an additional covariate.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ps_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">int</span> <span class="op">~</span> <span class="va">cov1</span> <span class="op">+</span> <span class="va">cov2</span> <span class="op">+</span> <span class="va">cov3</span> <span class="op">+</span> <span class="va">cov4</span>,</span>
<span>  data <span class="op">=</span> <span class="va">example_dataframe</span>,</span>
<span>  family <span class="op">=</span> <span class="va">binomial</span></span>
<span><span class="op">)</span></span>
<span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">ps_model</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span><span class="va">example_dataframe</span><span class="op">$</span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="va">ps</span></span>
<span></span>
<span><span class="va">example_dataframe</span><span class="op">$</span><span class="va">ps_cat_</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span></span>
<span>  <span class="va">example_dataframe</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>  breaks <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  include.lowest <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">example_dataframe</span><span class="op">$</span><span class="va">ps_cat_</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"ref"</span>, <span class="st">"low"</span>,</span>
<span>  <span class="st">"low_med"</span>, <span class="st">"high_med"</span>, <span class="st">"high"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The calculated PS can be included as a covariate in the analysis
object, for the “covariate adjustment” PS approach:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">analysis_ps_cuts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_analysis_obj.html">create_analysis_obj</a></span><span class="op">(</span></span>
<span>  data_matrix <span class="op">=</span> <span class="va">example_matrix_ps</span>,</span>
<span>  covariates <span class="op">=</span> <span class="fu"><a href="../reference/add_covariates.html">add_covariates</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ps_cat_low"</span>, <span class="st">"ps_cat_low_med"</span>, <span class="st">"ps_cat_high_med"</span>, <span class="st">"ps_cat_high"</span><span class="op">)</span>,</span>
<span>    priors <span class="op">=</span> <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  outcome <span class="op">=</span> <span class="fu"><a href="../reference/exp_surv_dist.html">exp_surv_dist</a></span><span class="op">(</span><span class="st">"time"</span>, <span class="st">"cnsr"</span>, <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  borrowing <span class="op">=</span> <span class="fu"><a href="../reference/borrowing_details.html">borrowing_details</a></span><span class="op">(</span><span class="st">"Full borrowing"</span>, <span class="st">"ext"</span><span class="op">)</span>,</span>
<span>  treatment <span class="op">=</span> <span class="fu"><a href="../reference/treatment_details.html">treatment_details</a></span><span class="op">(</span><span class="st">"trt"</span>, <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Inputs look good.</span></span>
<span><span class="co">#&gt; NOTE: dropping column `ext` for full borrowing.</span></span>
<span><span class="co">#&gt; Stan program compiled successfully!</span></span>
<span><span class="co">#&gt; Ready to go! Now call `mcmc_sample()`.</span></span>
<span></span>
<span><span class="va">result_ps_cuts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcmc_sample.html">mcmc_sample</a></span><span class="op">(</span><span class="va">analysis_ps_cuts</span><span class="op">)</span></span>
<span><span class="co">#&gt; Running MCMC with 4 sequential chains...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 finished in 4.3 seconds.</span></span>
<span><span class="co">#&gt; Chain 2 finished in 4.4 seconds.</span></span>
<span><span class="co">#&gt; Chain 3 finished in 4.4 seconds.</span></span>
<span><span class="co">#&gt; Chain 4 finished in 4.4 seconds.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; All 4 chains finished successfully.</span></span>
<span><span class="co">#&gt; Mean chain execution time: 4.4 seconds.</span></span>
<span><span class="co">#&gt; Total execution time: 18.0 seconds.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="alternative-ps-weights-with-weightit">Alternative PS Weights with <code>WeightIt</code><a class="anchor" aria-label="anchor" href="#alternative-ps-weights-with-weightit"></a>
</h3>
<p>The <a href="https://cran.r-project.org/package=WeightIt" class="external-link"><code>WeightIt</code></a>
package can calculate PS and other balancing weights with a number of
different methods, such as generalized boosted modeling
(<code>method = "gbm"</code>). In addition, weights can be calculated
differently for different estimands. Here, we specifying
<code>estimand = "ATT"</code>, to calculate weights for estimating the
average treatment effect among the treated (ATT).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/WeightIt/" class="external-link">WeightIt</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">weightit_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ngreifer.github.io/WeightIt/reference/weightit.html" class="external-link">weightit</a></span><span class="op">(</span></span>
<span>  <span class="va">int</span> <span class="op">~</span> <span class="va">cov1</span> <span class="op">+</span> <span class="va">cov2</span> <span class="op">+</span> <span class="va">cov3</span> <span class="op">+</span> <span class="va">cov4</span>,</span>
<span>  data <span class="op">=</span> <span class="va">example_dataframe</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"gbm"</span>,</span>
<span>  estimand <span class="op">=</span> <span class="st">"ATT"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: No `criterion` was provided. Using "smd.mean"FALSETRUE.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">weightit_model</span><span class="op">)</span></span>
<span><span class="co">#&gt;                  <span style="text-decoration: underline;">Summary of weights</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - <span style="font-style: italic;">Weight ranges</span>:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            Min                                  Max</span></span>
<span><span class="co">#&gt; treated 1.0000      ||                       1.0000</span></span>
<span><span class="co">#&gt; control 0.0826 |---------------------------| 5.8966</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - <span style="font-style: italic;">Units with the 5 most extreme weights by group</span>:</span></span>
<span><span class="co">#&gt;                                            </span></span>
<span><span class="co">#&gt;               5      4      3      2      1</span></span>
<span><span class="co">#&gt;  treated      1      1      1      1      1</span></span>
<span><span class="co">#&gt;             195    158    465    438    371</span></span>
<span><span class="co">#&gt;  control 2.7924 2.7924 5.8966 5.8966 5.8966</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - <span style="font-style: italic;">Weight statistics</span>:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         Coef of Var  MAD Entropy # Zeros</span></span>
<span><span class="co">#&gt; treated       0.000 0.00     0.0       0</span></span>
<span><span class="co">#&gt; control       1.582 0.82     0.6       0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - <span style="font-style: italic;">Effective Sample Sizes</span>:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            Control Treated</span></span>
<span><span class="co">#&gt; Unweighted  350.       150</span></span>
<span><span class="co">#&gt; Weighted    100.09     150</span></span></code></pre></div>
<p>Another useful package is <a href="https://cran.r-project.org/package=cobalt" class="external-link">cobalt</a>, which
provides tools for assessing balance between groups after weighting or
matching. It is compatible with many matching and weighting packages.
See the <a href="https://cran.r-project.org/web/packages/cobalt/vignettes/cobalt.html" class="external-link">vignette</a>
for more details. We can use the <code>cobalt</code> package to assess
balance with <code><a href="https://ngreifer.github.io/cobalt/reference/bal.plot.html" class="external-link">bal.plot()</a></code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/cobalt/" class="external-link">cobalt</a></span><span class="op">)</span></span>
<span><span class="co">#&gt;  cobalt (Version 4.5.1, Build Date: 2023-04-27)</span></span>
<span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.plot.html" class="external-link">bal.plot</a></span><span class="op">(</span><span class="va">weightit_model</span><span class="op">)</span></span>
<span><span class="co">#&gt; No `var.name` was provided. Displaying balance for prop.score.</span></span></code></pre></div>
<p><img src="propensity_scores_files/figure-html/balplot-1.png" width="768" style="display: block; margin: auto;"></p>
<p>The PS values can be copied into the data set and the analysis object
can be constructed as before.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_dataframe</span><span class="op">$</span><span class="va">att</span> <span class="op">&lt;-</span> <span class="va">weightit_model</span><span class="op">$</span><span class="va">weights</span></span>
<span></span>
<span><span class="va">example_matrix_att</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_data_matrix.html">create_data_matrix</a></span><span class="op">(</span></span>
<span>  <span class="va">example_dataframe</span>,</span>
<span>  ext_flag_col <span class="op">=</span> <span class="st">"ext"</span>,</span>
<span>  outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"time"</span>, <span class="st">"cnsr"</span><span class="op">)</span>,</span>
<span>  trt_flag_col <span class="op">=</span> <span class="st">"trt"</span>,</span>
<span>  weight_var <span class="op">=</span> <span class="st">"att"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">analysis_att</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_analysis_obj.html">create_analysis_obj</a></span><span class="op">(</span></span>
<span>  data_matrix <span class="op">=</span> <span class="va">example_matrix_att</span>,</span>
<span>  outcome <span class="op">=</span> <span class="fu"><a href="../reference/exp_surv_dist.html">exp_surv_dist</a></span><span class="op">(</span><span class="st">"time"</span>, <span class="st">"cnsr"</span>, <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span>, weight_var <span class="op">=</span> <span class="st">"att"</span><span class="op">)</span>,</span>
<span>  borrowing <span class="op">=</span> <span class="fu"><a href="../reference/borrowing_details.html">borrowing_details</a></span><span class="op">(</span><span class="st">"Full borrowing"</span>, <span class="st">"ext"</span><span class="op">)</span>,</span>
<span>  treatment <span class="op">=</span> <span class="fu"><a href="../reference/treatment_details.html">treatment_details</a></span><span class="op">(</span><span class="st">"trt"</span>, <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Inputs look good.</span></span>
<span><span class="co">#&gt; NOTE: dropping column `ext` for full borrowing.</span></span>
<span><span class="co">#&gt; Stan program compiled successfully!</span></span>
<span><span class="co">#&gt; Ready to go! Now call `mcmc_sample()`.</span></span>
<span></span>
<span><span class="va">result_att</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcmc_sample.html">mcmc_sample</a></span><span class="op">(</span><span class="va">analysis_att</span><span class="op">)</span></span>
<span><span class="co">#&gt; Running MCMC with 4 sequential chains...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 finished in 2.7 seconds.</span></span>
<span><span class="co">#&gt; Chain 2 finished in 2.7 seconds.</span></span>
<span><span class="co">#&gt; Chain 3 finished in 2.5 seconds.</span></span>
<span><span class="co">#&gt; Chain 4 finished in 2.6 seconds.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; All 4 chains finished successfully.</span></span>
<span><span class="co">#&gt; Mean chain execution time: 2.6 seconds.</span></span>
<span><span class="co">#&gt; Total execution time: 10.8 seconds.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="matching-with-matchit">Matching with <code>MatchIt</code><a class="anchor" aria-label="anchor" href="#matching-with-matchit"></a>
</h3>
<p>A variety of matching methods, including PS matching are implemented
in the <a href="https://cran.r-project.org/package=MatchIt" class="external-link">MatchIt</a>
package.</p>
<p>As described in the <a href="https://cran.r-project.org/web/packages/MatchIt/vignettes/MatchIt.html" class="external-link">Getting
Started vignette</a>, it can be useful to check the imbalance before
matching.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://kosukeimai.github.io/MatchIt/" class="external-link">MatchIt</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'MatchIt'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:cobalt':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     lalonde</span></span>
<span><span class="co"># No matching; constructing a pre-match matchit object</span></span>
<span><span class="va">no_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html" class="external-link">matchit</a></span><span class="op">(</span><span class="va">trt</span> <span class="op">~</span> <span class="va">cov1</span> <span class="op">+</span> <span class="va">cov2</span> <span class="op">+</span> <span class="va">cov3</span> <span class="op">+</span> <span class="va">cov4</span>,</span>
<span>  data <span class="op">=</span> <span class="va">example_dataframe</span>,</span>
<span>  method <span class="op">=</span> <span class="cn">NULL</span>, distance <span class="op">=</span> <span class="st">"glm"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">no_match</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; matchit(formula = trt ~ cov1 + cov2 + cov3 + cov4, data = example_dataframe, </span></span>
<span><span class="co">#&gt;     method = NULL, distance = "glm")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for All Data:</span></span>
<span><span class="co">#&gt;          Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance        0.2898        0.1776          0.7585     1.5831    0.2328</span></span>
<span><span class="co">#&gt; cov1            0.6300        0.7150         -0.1761          .    0.0850</span></span>
<span><span class="co">#&gt; cov2            0.3700        0.4625         -0.1916          .    0.0925</span></span>
<span><span class="co">#&gt; cov3            0.7600        0.4475          0.7317          .    0.3125</span></span>
<span><span class="co">#&gt; cov4            0.4600        0.2250          0.4715          .    0.2350</span></span>
<span><span class="co">#&gt;          eCDF Max</span></span>
<span><span class="co">#&gt; distance   0.3375</span></span>
<span><span class="co">#&gt; cov1       0.0850</span></span>
<span><span class="co">#&gt; cov2       0.0925</span></span>
<span><span class="co">#&gt; cov3       0.3125</span></span>
<span><span class="co">#&gt; cov4       0.2350</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample Sizes:</span></span>
<span><span class="co">#&gt;           Control Treated</span></span>
<span><span class="co">#&gt; All           400     100</span></span>
<span><span class="co">#&gt; Matched       400     100</span></span>
<span><span class="co">#&gt; Unmatched       0       0</span></span>
<span><span class="co">#&gt; Discarded       0       0</span></span></code></pre></div>
<p>Here we are matching treated to untreated to select the most
comparable control group, regardless of whether they are internal or
external. For simplicity let’s try a 1:1 nearest matching approach.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">match_11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html" class="external-link">matchit</a></span><span class="op">(</span><span class="va">trt</span> <span class="op">~</span> <span class="va">cov1</span> <span class="op">+</span> <span class="va">cov2</span> <span class="op">+</span> <span class="va">cov3</span> <span class="op">+</span> <span class="va">cov4</span>,</span>
<span>  data <span class="op">=</span> <span class="va">example_dataframe</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"nearest"</span>, distance <span class="op">=</span> <span class="st">"glm"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">match_11</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; matchit(formula = trt ~ cov1 + cov2 + cov3 + cov4, data = example_dataframe, </span></span>
<span><span class="co">#&gt;     method = "nearest", distance = "glm")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for All Data:</span></span>
<span><span class="co">#&gt;          Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance        0.2898        0.1776          0.7585     1.5831    0.2328</span></span>
<span><span class="co">#&gt; cov1            0.6300        0.7150         -0.1761          .    0.0850</span></span>
<span><span class="co">#&gt; cov2            0.3700        0.4625         -0.1916          .    0.0925</span></span>
<span><span class="co">#&gt; cov3            0.7600        0.4475          0.7317          .    0.3125</span></span>
<span><span class="co">#&gt; cov4            0.4600        0.2250          0.4715          .    0.2350</span></span>
<span><span class="co">#&gt;          eCDF Max</span></span>
<span><span class="co">#&gt; distance   0.3375</span></span>
<span><span class="co">#&gt; cov1       0.0850</span></span>
<span><span class="co">#&gt; cov2       0.0925</span></span>
<span><span class="co">#&gt; cov3       0.3125</span></span>
<span><span class="co">#&gt; cov4       0.2350</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for Matched Data:</span></span>
<span><span class="co">#&gt;          Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance        0.2898        0.2845          0.0355     1.1082    0.0075</span></span>
<span><span class="co">#&gt; cov1            0.6300        0.6800         -0.1036          .    0.0500</span></span>
<span><span class="co">#&gt; cov2            0.3700        0.3900         -0.0414          .    0.0200</span></span>
<span><span class="co">#&gt; cov3            0.7600        0.7600          0.0000          .    0.0000</span></span>
<span><span class="co">#&gt; cov4            0.4600        0.4600          0.0000          .    0.0000</span></span>
<span><span class="co">#&gt;          eCDF Max Std. Pair Dist.</span></span>
<span><span class="co">#&gt; distance     0.07          0.0355</span></span>
<span><span class="co">#&gt; cov1         0.05          0.1036</span></span>
<span><span class="co">#&gt; cov2         0.02          0.1243</span></span>
<span><span class="co">#&gt; cov3         0.00          0.0000</span></span>
<span><span class="co">#&gt; cov4         0.00          0.0000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample Sizes:</span></span>
<span><span class="co">#&gt;           Control Treated</span></span>
<span><span class="co">#&gt; All           400     100</span></span>
<span><span class="co">#&gt; Matched       100     100</span></span>
<span><span class="co">#&gt; Unmatched     300       0</span></span>
<span><span class="co">#&gt; Discarded       0       0</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">match_11</span>, type <span class="op">=</span> <span class="st">"jitter"</span>, interactive <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="propensity_scores_files/figure-html/matchit_jitter-1.png" width="768" style="display: block; margin: auto;"></p>
<p>Determining whether the balance after matching is appropriate is
beyond the scope of this vignette. You can read more in the <a href="https://cran.r-project.org/web/packages/MatchIt/vignettes/assessing-balance.html" class="external-link">MatchIt
Assessing Balance</a> vignette. Again the <code>cobalt</code> package
can be useful here.</p>
<p>However, if you are happy with the results of the matching procedure,
you can extract the data for use in <code>psborrow2</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_matrix_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_data_matrix.html">create_data_matrix</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">example_dataframe</span><span class="op">[</span><span class="va">match_11</span><span class="op">$</span><span class="va">weights</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span>,</span>
<span>  ext_flag_col <span class="op">=</span> <span class="st">"ext"</span>,</span>
<span>  outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"time"</span>, <span class="st">"cnsr"</span><span class="op">)</span>,</span>
<span>  trt_flag_col <span class="op">=</span> <span class="st">"trt"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">analysis_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_analysis_obj.html">create_analysis_obj</a></span><span class="op">(</span></span>
<span>  data_matrix <span class="op">=</span> <span class="va">example_matrix_match</span>,</span>
<span>  outcome <span class="op">=</span> <span class="fu"><a href="../reference/exp_surv_dist.html">exp_surv_dist</a></span><span class="op">(</span><span class="st">"time"</span>, <span class="st">"cnsr"</span>, <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  borrowing <span class="op">=</span> <span class="fu"><a href="../reference/borrowing_details.html">borrowing_details</a></span><span class="op">(</span><span class="st">"Full borrowing"</span>, <span class="st">"ext"</span><span class="op">)</span>,</span>
<span>  treatment <span class="op">=</span> <span class="fu"><a href="../reference/treatment_details.html">treatment_details</a></span><span class="op">(</span><span class="st">"trt"</span>, <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Inputs look good.</span></span>
<span><span class="co">#&gt; NOTE: dropping column `ext` for full borrowing.</span></span>
<span><span class="co">#&gt; Stan program compiled successfully!</span></span>
<span><span class="co">#&gt; Ready to go! Now call `mcmc_sample()`.</span></span>
<span></span>
<span><span class="va">result_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcmc_sample.html">mcmc_sample</a></span><span class="op">(</span><span class="va">analysis_match</span><span class="op">)</span></span>
<span><span class="co">#&gt; Running MCMC with 4 sequential chains...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 finished in 1.1 seconds.</span></span>
<span><span class="co">#&gt; Chain 2 finished in 1.2 seconds.</span></span>
<span><span class="co">#&gt; Chain 3 finished in 1.2 seconds.</span></span>
<span><span class="co">#&gt; Chain 4 finished in 1.1 seconds.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; All 4 chains finished successfully.</span></span>
<span><span class="co">#&gt; Mean chain execution time: 1.1 seconds.</span></span>
<span><span class="co">#&gt; Total execution time: 4.9 seconds.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="combined-weighting-and-dynamic-borrowing">Combined Weighting and Dynamic Borrowing<a class="anchor" aria-label="anchor" href="#combined-weighting-and-dynamic-borrowing"></a>
</h3>
<p>The models also support fixed weights on the likelihood contributions
from each observation. This is equivalent to fixed power prior weights.
This allows for the combination of models, such as an IPTW +
commensurate prior approach.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">analysis_iptw_bdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_analysis_obj.html">create_analysis_obj</a></span><span class="op">(</span></span>
<span>  data_matrix <span class="op">=</span> <span class="va">example_matrix_att</span>,</span>
<span>  outcome <span class="op">=</span> <span class="fu"><a href="../reference/exp_surv_dist.html">exp_surv_dist</a></span><span class="op">(</span><span class="st">"time"</span>, <span class="st">"cnsr"</span>, <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span>, weight_var <span class="op">=</span> <span class="st">"att"</span><span class="op">)</span>,</span>
<span>  borrowing <span class="op">=</span> <span class="fu"><a href="../reference/borrowing_details.html">borrowing_details</a></span><span class="op">(</span><span class="st">"BDB"</span>, <span class="st">"ext"</span>, <span class="fu"><a href="../reference/gamma_prior.html">gamma_prior</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  treatment <span class="op">=</span> <span class="fu"><a href="../reference/treatment_details.html">treatment_details</a></span><span class="op">(</span><span class="st">"trt"</span>, <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Inputs look good.</span></span>
<span><span class="co">#&gt; Stan program compiled successfully!</span></span>
<span><span class="co">#&gt; Ready to go! Now call `mcmc_sample()`.</span></span>
<span></span>
<span><span class="va">result_iptw_bdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcmc_sample.html">mcmc_sample</a></span><span class="op">(</span><span class="va">analysis_iptw_bdb</span><span class="op">)</span></span>
<span><span class="co">#&gt; Running MCMC with 4 sequential chains...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 finished in 5.6 seconds.</span></span>
<span><span class="co">#&gt; Chain 2 finished in 5.8 seconds.</span></span>
<span><span class="co">#&gt; Chain 3 finished in 5.8 seconds.</span></span>
<span><span class="co">#&gt; Chain 4 finished in 4.8 seconds.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; All 4 chains finished successfully.</span></span>
<span><span class="co">#&gt; Mean chain execution time: 5.5 seconds.</span></span>
<span><span class="co">#&gt; Total execution time: 22.3 seconds.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fixed-weights">Fixed Weights<a class="anchor" aria-label="anchor" href="#fixed-weights"></a>
</h3>
<p>We can also use weights to specify a fixed power prior model. Here we
set the power parameter <span class="math inline">\(\alpha =
0.1\)</span> for the external controls.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_matrix_pp01</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">example_matrix</span>, pp_alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">example_matrix</span><span class="op">[</span>, <span class="st">"ext"</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">0.1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">analysis_pp01</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_analysis_obj.html">create_analysis_obj</a></span><span class="op">(</span></span>
<span>  data_matrix <span class="op">=</span> <span class="va">example_matrix_pp01</span>,</span>
<span>  outcome <span class="op">=</span> <span class="fu"><a href="../reference/exp_surv_dist.html">exp_surv_dist</a></span><span class="op">(</span><span class="st">"time"</span>, <span class="st">"cnsr"</span>, <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span>, weight_var <span class="op">=</span> <span class="st">"pp_alpha"</span><span class="op">)</span>,</span>
<span>  borrowing <span class="op">=</span> <span class="fu"><a href="../reference/borrowing_details.html">borrowing_details</a></span><span class="op">(</span><span class="st">"Full borrowing"</span>, <span class="st">"ext"</span><span class="op">)</span>,</span>
<span>  treatment <span class="op">=</span> <span class="fu"><a href="../reference/treatment_details.html">treatment_details</a></span><span class="op">(</span><span class="st">"trt"</span>, <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Inputs look good.</span></span>
<span><span class="co">#&gt; NOTE: dropping column `ext` for full borrowing.</span></span>
<span><span class="co">#&gt; Stan program compiled successfully!</span></span>
<span><span class="co">#&gt; Ready to go! Now call `mcmc_sample()`.</span></span>
<span></span>
<span><span class="va">result_pp01</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcmc_sample.html">mcmc_sample</a></span><span class="op">(</span><span class="va">analysis_pp01</span><span class="op">)</span></span>
<span><span class="co">#&gt; Running MCMC with 4 sequential chains...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 finished in 3.2 seconds.</span></span>
<span><span class="co">#&gt; Chain 2 finished in 2.9 seconds.</span></span>
<span><span class="co">#&gt; Chain 3 finished in 3.1 seconds.</span></span>
<span><span class="co">#&gt; Chain 4 finished in 3.1 seconds.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; All 4 chains finished successfully.</span></span>
<span><span class="co">#&gt; Mean chain execution time: 3.1 seconds.</span></span>
<span><span class="co">#&gt; Total execution time: 12.6 seconds.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="reference-models">Reference Models<a class="anchor" aria-label="anchor" href="#reference-models"></a>
</h3>
<p>For comparison, we also fit a full borrowing, a no borrowing, and a
BDB model without weights.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcmc_sample.html">mcmc_sample</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/create_analysis_obj.html">create_analysis_obj</a></span><span class="op">(</span></span>
<span>    data_matrix <span class="op">=</span> <span class="va">example_matrix</span>,</span>
<span>    outcome <span class="op">=</span> <span class="fu"><a href="../reference/exp_surv_dist.html">exp_surv_dist</a></span><span class="op">(</span><span class="st">"time"</span>, <span class="st">"cnsr"</span>, <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    borrowing <span class="op">=</span> <span class="fu"><a href="../reference/borrowing_details.html">borrowing_details</a></span><span class="op">(</span><span class="st">"Full borrowing"</span>, <span class="st">"ext"</span><span class="op">)</span>,</span>
<span>    treatment <span class="op">=</span> <span class="fu"><a href="../reference/treatment_details.html">treatment_details</a></span><span class="op">(</span><span class="st">"trt"</span>, <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Inputs look good.</span></span>
<span><span class="co">#&gt; NOTE: dropping column `ext` for full borrowing.</span></span>
<span><span class="co">#&gt; Stan program compiled successfully!</span></span>
<span><span class="co">#&gt; Ready to go! Now call `mcmc_sample()`.</span></span>
<span><span class="co">#&gt; Running MCMC with 4 sequential chains...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 finished in 2.3 seconds.</span></span>
<span><span class="co">#&gt; Chain 2 finished in 2.1 seconds.</span></span>
<span><span class="co">#&gt; Chain 3 finished in 2.4 seconds.</span></span>
<span><span class="co">#&gt; Chain 4 finished in 2.4 seconds.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; All 4 chains finished successfully.</span></span>
<span><span class="co">#&gt; Mean chain execution time: 2.3 seconds.</span></span>
<span><span class="co">#&gt; Total execution time: 9.5 seconds.</span></span>
<span></span>
<span><span class="va">result_none</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcmc_sample.html">mcmc_sample</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/create_analysis_obj.html">create_analysis_obj</a></span><span class="op">(</span></span>
<span>    data_matrix <span class="op">=</span> <span class="va">example_matrix</span>,</span>
<span>    outcome <span class="op">=</span> <span class="fu"><a href="../reference/exp_surv_dist.html">exp_surv_dist</a></span><span class="op">(</span><span class="st">"time"</span>, <span class="st">"cnsr"</span>, <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    borrowing <span class="op">=</span> <span class="fu"><a href="../reference/borrowing_details.html">borrowing_details</a></span><span class="op">(</span><span class="st">"No borrowing"</span>, <span class="st">"ext"</span><span class="op">)</span>,</span>
<span>    treatment <span class="op">=</span> <span class="fu"><a href="../reference/treatment_details.html">treatment_details</a></span><span class="op">(</span><span class="st">"trt"</span>, <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Inputs look good.</span></span>
<span><span class="co">#&gt; NOTE: excluding `ext` == `1`/`TRUE` for no borrowing.</span></span>
<span><span class="co">#&gt; Stan program compiled successfully!</span></span>
<span><span class="co">#&gt; Ready to go! Now call `mcmc_sample()`.</span></span>
<span><span class="co">#&gt; Running MCMC with 4 sequential chains...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 finished in 1.1 seconds.</span></span>
<span><span class="co">#&gt; Chain 2 finished in 1.0 seconds.</span></span>
<span><span class="co">#&gt; Chain 3 finished in 1.0 seconds.</span></span>
<span><span class="co">#&gt; Chain 4 finished in 1.1 seconds.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; All 4 chains finished successfully.</span></span>
<span><span class="co">#&gt; Mean chain execution time: 1.1 seconds.</span></span>
<span><span class="co">#&gt; Total execution time: 4.5 seconds.</span></span>
<span></span>
<span><span class="va">result_bdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcmc_sample.html">mcmc_sample</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/create_analysis_obj.html">create_analysis_obj</a></span><span class="op">(</span></span>
<span>    data_matrix <span class="op">=</span> <span class="va">example_matrix_att</span>,</span>
<span>    outcome <span class="op">=</span> <span class="fu"><a href="../reference/exp_surv_dist.html">exp_surv_dist</a></span><span class="op">(</span><span class="st">"time"</span>, <span class="st">"cnsr"</span>, <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    borrowing <span class="op">=</span> <span class="fu"><a href="../reference/borrowing_details.html">borrowing_details</a></span><span class="op">(</span><span class="st">"BDB"</span>, <span class="st">"ext"</span>, <span class="fu"><a href="../reference/gamma_prior.html">gamma_prior</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    treatment <span class="op">=</span> <span class="fu"><a href="../reference/treatment_details.html">treatment_details</a></span><span class="op">(</span><span class="st">"trt"</span>, <span class="fu"><a href="../reference/normal_prior.html">normal_prior</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Inputs look good.</span></span>
<span><span class="co">#&gt; Stan program compiled successfully!</span></span>
<span><span class="co">#&gt; Ready to go! Now call `mcmc_sample()`.</span></span>
<span><span class="co">#&gt; Running MCMC with 4 sequential chains...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 finished in 5.3 seconds.</span></span>
<span><span class="co">#&gt; Chain 2 finished in 4.9 seconds.</span></span>
<span><span class="co">#&gt; Chain 3 finished in 4.8 seconds.</span></span>
<span><span class="co">#&gt; Chain 4 finished in 5.0 seconds.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; All 4 chains finished successfully.</span></span>
<span><span class="co">#&gt; Mean chain execution time: 5.0 seconds.</span></span>
<span><span class="co">#&gt; Total execution time: 20.5 seconds.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="comparison-of-results">Comparison of Results<a class="anchor" aria-label="anchor" href="#comparison-of-results"></a>
</h2>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"No borrowing"</span> <span class="op">=</span> <span class="va">result_none</span>,</span>
<span>  <span class="st">"Full borrowing"</span> <span class="op">=</span> <span class="va">result_full</span>,</span>
<span>  <span class="st">"Power Prior 01"</span> <span class="op">=</span> <span class="va">result_pp01</span>,</span>
<span>  <span class="st">"PS Groups"</span> <span class="op">=</span> <span class="va">result_ps_cuts</span>,</span>
<span>  <span class="st">"ATT Weights"</span> <span class="op">=</span> <span class="va">result_att</span>,</span>
<span>  <span class="st">"IPTW + BDB"</span> <span class="op">=</span> <span class="va">result_iptw_bdb</span>,</span>
<span>  <span class="st">"Matching 1:1"</span> <span class="op">=</span> <span class="va">result_match</span>,</span>
<span>  <span class="st">"BDB"</span> <span class="op">=</span> <span class="va">result_bdb</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can use <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> to extract the variable of interest
and specify summary statistics.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="va">models</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="va">i</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="st">"HR_trt"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mean"</span>, <span class="st">"median"</span>, <span class="st">"sd"</span>, <span class="st">"quantile2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span>, <span class="va">results_table</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">models</th>
<th align="left">variable</th>
<th align="right">mean</th>
<th align="right">median</th>
<th align="right">sd</th>
<th align="right">q5</th>
<th align="right">q95</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">No borrowing</td>
<td align="left">HR_trt</td>
<td align="right">0.895</td>
<td align="right">0.876</td>
<td align="right">0.181</td>
<td align="right">0.632</td>
<td align="right">1.220</td>
</tr>
<tr class="even">
<td align="left">Full borrowing</td>
<td align="left">HR_trt</td>
<td align="right">0.388</td>
<td align="right">0.386</td>
<td align="right">0.049</td>
<td align="right">0.311</td>
<td align="right">0.473</td>
</tr>
<tr class="odd">
<td align="left">Power Prior 01</td>
<td align="left">HR_trt</td>
<td align="right">0.635</td>
<td align="right">0.627</td>
<td align="right">0.106</td>
<td align="right">0.476</td>
<td align="right">0.821</td>
</tr>
<tr class="even">
<td align="left">PS Groups</td>
<td align="left">HR_trt</td>
<td align="right">0.720</td>
<td align="right">0.715</td>
<td align="right">0.096</td>
<td align="right">0.571</td>
<td align="right">0.886</td>
</tr>
<tr class="odd">
<td align="left">ATT Weights</td>
<td align="left">HR_trt</td>
<td align="right">0.894</td>
<td align="right">0.886</td>
<td align="right">0.127</td>
<td align="right">0.703</td>
<td align="right">1.117</td>
</tr>
<tr class="even">
<td align="left">IPTW + BDB</td>
<td align="left">HR_trt</td>
<td align="right">0.895</td>
<td align="right">0.879</td>
<td align="right">0.163</td>
<td align="right">0.656</td>
<td align="right">1.185</td>
</tr>
<tr class="odd">
<td align="left">Matching 1:1</td>
<td align="left">HR_trt</td>
<td align="right">0.792</td>
<td align="right">0.782</td>
<td align="right">0.128</td>
<td align="right">0.599</td>
<td align="right">1.016</td>
</tr>
<tr class="even">
<td align="left">BDB</td>
<td align="left">HR_trt</td>
<td align="right">0.871</td>
<td align="right">0.853</td>
<td align="right">0.175</td>
<td align="right">0.618</td>
<td align="right">1.184</td>
</tr>
</tbody>
</table>
<p>We can extract a <code>draws</code> object from each model and plot
the posterior distribution of the treatment hazard ratio.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">models</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">draws</span><span class="op">(</span><span class="st">"HR_trt"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="fl">1</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">9</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"HR_trt"</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Posterior Hazard Ratio"</span></span>
<span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">draws</span><span class="op">(</span><span class="st">"HR_trt"</span><span class="op">)</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">i</span>, lty <span class="op">=</span> <span class="va">i</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="propensity_scores_files/figure-html/plots-1.png" width="768" style="display: block; margin: auto;"></p>
<p>Here we see no borrowing and full borrowing at the extremes and the
other methods in between.</p>
<div class="section level3">
<h3 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-austin2013" class="csl-entry">
Austin, Peter C. 2013. <span>“The Use of Propensity Score Methods with
Survival or Time<span>-</span>to<span>-</span>Event Outcomes: Reporting
Measures of Effect Similar to Those Used in Randomized
Experiments.”</span> <em>Statistics in Medicine</em> 33 (7): 1242–58. <a href="https://doi.org/10.1002/sim.5984" class="external-link">https://doi.org/10.1002/sim.5984</a>.
</div>
<div id="ref-wang2021" class="csl-entry">
Wang, Xi, Leah Suttner, Thomas Jemielita, and Xiaoyun Li. 2021.
<span>“Propensity Score-Integrated Bayesian Prior Approaches for
Augmented Control Designs: A Simulation Study.”</span> <em>Journal of
Biopharmaceutical Statistics</em> 32 (1): 170–90. <a href="https://doi.org/10.1080/10543406.2021.2011743" class="external-link">https://doi.org/10.1080/10543406.2021.2011743</a>.
</div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Matt Secrest, Isaac Gravestock.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
