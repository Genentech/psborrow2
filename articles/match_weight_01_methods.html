<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="psborrow2">
<title>1. Matching and Weighting Methods • psborrow2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="1. Matching and Weighting Methods">
<meta property="og:description" content="psborrow2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-125641273-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-125641273-1');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">psborrow2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.3.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/psborrow2.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/index.html">Articles</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Genentech/psborrow2">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>1. Matching and Weighting Methods</h1>
                        <h4 data-toc-skip class="author">Manoj Khanal <a href="mailto:khanal_manoj@lilly.com" class="email">khanal_manoj@lilly.com</a>
</h4>
                        <h4 data-toc-skip class="author">Eli Lilly &amp;
Company</h4>
            
            <h4 data-toc-skip class="date">2024-04-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Genentech/psborrow2/blob/HEAD/vignettes/match_weight_01_methods.Rmd" class="external-link"><code>vignettes/match_weight_01_methods.Rmd</code></a></small>
      <div class="d-none name"><code>match_weight_01_methods.Rmd</code></div>
    </div>

    
    
<p>Using external control in the analysis of clinical trial data can be
challenging as the two data source may be heterogenous. In this
document, we demonstrate the use of various matching and weighting
techniques using readily available packages in R to adjust for imbalance
in baseline covariates between the data sets.</p>
<p>We first load all of the libraries used in this tutorial.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Loading the libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/AFialkowski/SimMultiCorrData" class="external-link">SimMultiCorrData</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://web.stanford.edu/~jhain/" class="external-link">ebal</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/kaz-yos/tableone" class="external-link">tableone</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://kosukeimai.github.io/MatchIt/" class="external-link">MatchIt</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">twang</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/cobalt/" class="external-link">cobalt</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">overlapping</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://r-survey.r-forge.r-project.org/survey/" class="external-link">survey</a></span><span class="op">)</span></span></code></pre></div>
<p>To demonstrate the utility of the tools, we simulate data for a
randomized controlled trial (RCT) and a dataset with external controls.
We simulate a two arm trial where approximately <span class="math inline">\(70\%\)</span> of subjects receive the active
treatment. The sample size for the RCT and external data is <span class="math inline">\(n_D=600\)</span> and <span class="math inline">\(n_K=500\)</span> respectively. In the RCT, we
generate <span class="math inline">\(5\)</span> continuous and <span class="math inline">\(3\)</span> binary baseline covariates <span class="math inline">\(X\)</span> as follows:</p>
<ul>
<li>The continuous variables are
<ul>
<li>Age (years): mean = <span class="math inline">\(55\)</span> and
variance = <span class="math inline">\(15\)</span>
</li>
<li>Weight (lbs): mean = <span class="math inline">\(150\)</span> and
variance = <span class="math inline">\(10\)</span>
</li>
<li>Height (inches): mean = <span class="math inline">\(65\)</span> and
variance = <span class="math inline">\(6\)</span>
</li>
<li>Biomarker1: mean = <span class="math inline">\(53\)</span> and
variance = <span class="math inline">\(5\)</span>
</li>
<li>Biomarker2: mean = <span class="math inline">\(50\)</span> and
variance = <span class="math inline">\(6\)</span>
</li>
</ul>
</li>
<li>The categorical variables are
<ul>
<li>Smoker: Yes = 1 and No = 0. Proportion of Yes is <span class="math inline">\(20\%\)</span>.</li>
<li>Sex: Male = 1 and Female = 0. Proportion of Male is <span class="math inline">\(80\%\)</span>.</li>
<li>ECOG1: ECOG 1 = 1 and ECOG 0 = 0. Proportion of ECOG 1 is <span class="math inline">\(30\%\)</span>.</li>
</ul>
</li>
</ul>
<p>We simulate covariates with a correlation coefficient of <span class="math inline">\(0.2\)</span> between all variables. For the
continuous variables, we also specify the skewness and kurtosis to be
<span class="math inline">\(0.2\)</span> and <span class="math inline">\(0.1\)</span>, respectively, for all variables.
Given the randomized nature of the RCT, subjects are assigned treatment
at random.</p>
<p>Other variables in the simulated data include</p>
<ul>
<li>The treatment indicator is
<ul>
<li>group: group = 1 is treatment and group = 0 is placebo.</li>
</ul>
</li>
<li>The time to event variable is
<ul>
<li>time</li>
</ul>
</li>
<li>The event indicator variable is
<ul>
<li>event: event = 1 is an event indicator and event = 0 is
censored</li>
</ul>
</li>
<li>The data indicator variable is
<ul>
<li>data: data = TRIAL indicating the trial data set</li>
</ul>
</li>
</ul>
<p>To generate the covariates, we first specify the sample sizes, number
of continuous and categorical variables, the marginal moments of the
covariates, and the correlation matrix. Note that rcorrvar2 requires the
correlation matrix to be ordered as ordinal, continuous, Poisson, and
Negative Binomial.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Simulate correlated covariates</span></span>
<span><span class="va">n_t</span> <span class="op">&lt;-</span> <span class="fl">600</span> <span class="co">#Sample size in trial data</span></span>
<span><span class="va">n_ec</span> <span class="op">&lt;-</span> <span class="fl">500</span> <span class="co">#Sample size in external control data</span></span>
<span><span class="va">k_cont</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co">#Number of continuous variables</span></span>
<span><span class="va">k_cat</span> <span class="op">&lt;-</span> <span class="fl">3</span> <span class="co">#Number of categorical variables</span></span>
<span><span class="va">means_cont_tc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="fl">55</span>,<span class="fl">150</span>,<span class="fl">65</span>,<span class="fl">35</span>,<span class="fl">50</span><span class="op">)</span> <span class="co">#Vector of means of continuous variables</span></span>
<span><span class="va">vars_cont_tc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>,<span class="fl">10</span>,<span class="fl">6</span>,<span class="fl">5</span>,<span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">marginal_tc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">0.2</span>,<span class="fl">0.8</span>,<span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="va">rho_tc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">8</span>, <span class="fl">8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">rho_tc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">skews_tc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.2</span>,<span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">skurts_tc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="simulating-trial-data">Simulating trial data<a class="anchor" aria-label="anchor" href="#simulating-trial-data"></a>
</h2>
<p>After specifying the moments of the covariate distribution, we
simulate the covariates using <code>rcorrvar2</code> function from
<code>SimMultiCorrData</code> package.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Simulating covariates</span></span>
<span><span class="va">trial.data</span> <span class="op">&lt;-</span> <span class="fu">rcorrvar2</span><span class="op">(</span>n <span class="op">=</span> <span class="va">n_t</span>, k_cont <span class="op">=</span> <span class="va">k_cont</span>, k_cat <span class="op">=</span> <span class="va">k_cat</span>, k_nb <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                        method <span class="op">=</span> <span class="st">"Fleishman"</span>,  seed<span class="op">=</span><span class="fl">1</span>,</span>
<span>                        means <span class="op">=</span> <span class="va">means_cont_tc</span>, vars <span class="op">=</span> <span class="va">vars_cont_tc</span>, <span class="co"># if continuous variables</span></span>
<span>                        skews <span class="op">=</span> <span class="va">skews_tc</span>, skurts <span class="op">=</span> <span class="va">skurts_tc</span>, </span>
<span>                        marginal<span class="op">=</span><span class="va">marginal_tc</span>, rho <span class="op">=</span> <span class="va">rho_tc</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Constants: Distribution  1  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Constants: Distribution  2  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Constants: Distribution  3  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Constants: Distribution  4  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Constants: Distribution  5  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Constants calculation time: 0.004 minutes </span></span>
<span><span class="co">#&gt; Intercorrelation calculation time: 0.002 minutes </span></span>
<span><span class="co">#&gt; Error loop calculation time: 0 minutes </span></span>
<span><span class="co">#&gt; Total Simulation time: 0.006 minutes</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"TRIAL"</span>,<span class="fl">1</span><span class="op">:</span><span class="va">n_t</span>,sep<span class="op">=</span><span class="st">""</span><span class="op">)</span>, <span class="va">trial.data</span><span class="op">$</span><span class="va">continuous_variables</span>, </span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">trial.data</span><span class="op">$</span><span class="va">ordinal_variables</span><span class="op">==</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">trial.data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="st">"ID"</span>, <span class="st">"Age"</span>, <span class="st">"Weight"</span>,<span class="st">"Height"</span>,<span class="st">"Biomarker1"</span>,<span class="st">"Biomarker2"</span>,<span class="st">"Smoker"</span>, </span>
<span>                          <span class="st">"Sex"</span>, <span class="st">"ECOG1"</span><span class="op">)</span></span></code></pre></div>
<p>We now simulate the survival outcome data using the Cox proportional
hazards model <span class="citation">(Cox 1972)</span> in which the
hazard function <span class="math inline">\(\lambda(t|\boldsymbol X,
Z)\)</span> is given by <span class="math display">\[\lambda(t|\boldsymbol X, Z)=\lambda_0(t)
\exp\{\boldsymbol X \boldsymbol \beta_{Trial} + Z \gamma\},\]</span></p>
<p>where <span class="math inline">\(\lambda_0(t)=2\)</span> is the
baseline hazard function and assumed to be constant, <span class="math inline">\(\boldsymbol X\)</span> is a matrix of baseline
covariates, <span class="math inline">\(\boldsymbol
\beta_{Trial}\)</span> is a vector of covariate effects, <span class="math inline">\(Z\)</span> is the treatment indicator, and <span class="math inline">\(\gamma\)</span> is the treatment effect in terms
of the log hazard ratio.</p>
<!-- #MS maybe this section below can be deleted, it might not be necessary to provide all of the coefficients -->
<!-- *   The true value of the covariates effect and treatment effect are -->
<!--       + $\beta_{Age,Trial}=0.3$ -->
<!--       + $\beta_{Weight,Trial}=0.1$ -->
<!--       + $\beta_{Height,Trial}=-0.3$ -->
<!--       + $\beta_{Biomarker1,Trial}=-0.2$ -->
<!--       + $\beta_{Biomarker2,Trial}=-0.12$ -->
<!--       + $\beta_{Smoker,Trial}=0.3$ -->
<!--       + $\beta_{Sex,Trial}=1$ -->
<!--       + $\beta_{ECOG1,Trial}=-1$ -->
<!--       + $\gamma=-0.4$ -->
<p>The survival function is given by <span class="math display">\[S(t|\boldsymbol X, Z)=exp\{-\Lambda(t|\boldsymbol
X, Z)\},\]</span> where <span class="math inline">\(\Lambda(t|\boldsymbol X,
Z)=\int_0^t\lambda(u|\boldsymbol X, Z)du\)</span>. The time to event is
generated using a inverse CDF method. The censoring time is generated
independently from an exponential distribution with
<code>rate=1/4</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Simulate survival outcome using Cox proportional hazards regression model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">lambda0</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co">#constant baseline hazard</span></span>
<span><span class="co">#Simulate treatment indicator in the trial data</span></span>
<span><span class="va">trial.data</span><span class="op">$</span><span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n_t</span>,<span class="fl">1</span>,prob<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="fl">0.3</span>,<span class="fl">0.1</span>,<span class="op">-</span><span class="fl">0.3</span>,<span class="op">-</span><span class="fl">0.2</span>,<span class="op">-</span><span class="fl">0.12</span>,<span class="fl">0.3</span>,<span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">0.4</span><span class="op">)</span></span>
<span><span class="va">times</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">lambda0</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">trial.data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">beta</span><span class="op">)</span><span class="op">)</span> <span class="co">#Inverse CDF method</span></span>
<span><span class="va">cens.time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="va">n_t</span>,rate<span class="op">=</span><span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">)</span> <span class="co">#Censoring time from exponential distribution</span></span>
<span><span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">times</span> <span class="op">&lt;=</span> <span class="va">cens.time</span><span class="op">)</span> <span class="co">#Event indicator. 0 is censored.</span></span>
<span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">times</span>,<span class="va">cens.time</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Combine trial data</span></span>
<span><span class="va">trial.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">trial.data</span>,<span class="va">time</span>,<span class="va">event</span>,data<span class="op">=</span><span class="st">"TRIAL"</span><span class="op">)</span></span></code></pre></div>
<p>The first 10 observations in the RCT data is shown below.</p>
<table class="table">
<colgroup>
<col width="7%">
<col width="8%">
<col width="8%">
<col width="8%">
<col width="10%">
<col width="10%">
<col width="6%">
<col width="3%">
<col width="5%">
<col width="5%">
<col width="9%">
<col width="5%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="left">ID</th>
<th align="right">Age</th>
<th align="right">Weight</th>
<th align="right">Height</th>
<th align="right">Biomarker1</th>
<th align="right">Biomarker2</th>
<th align="right">Smoker</th>
<th align="right">Sex</th>
<th align="right">ECOG1</th>
<th align="right">group</th>
<th align="right">time</th>
<th align="right">event</th>
<th align="left">data</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">TRIAL1</td>
<td align="right">55.51419</td>
<td align="right">148.5092</td>
<td align="right">65.63899</td>
<td align="right">33.71898</td>
<td align="right">55.26178</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.4089043</td>
<td align="right">0</td>
<td align="left">TRIAL</td>
</tr>
<tr class="even">
<td align="left">TRIAL2</td>
<td align="right">49.93326</td>
<td align="right">146.9441</td>
<td align="right">63.44883</td>
<td align="right">35.65828</td>
<td align="right">45.50928</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0.9721405</td>
<td align="right">0</td>
<td align="left">TRIAL</td>
</tr>
<tr class="odd">
<td align="left">TRIAL3</td>
<td align="right">58.51588</td>
<td align="right">153.5435</td>
<td align="right">70.53193</td>
<td align="right">35.53710</td>
<td align="right">55.89283</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.2956919</td>
<td align="right">0</td>
<td align="left">TRIAL</td>
</tr>
<tr class="even">
<td align="left">TRIAL4</td>
<td align="right">48.61226</td>
<td align="right">147.2873</td>
<td align="right">64.10615</td>
<td align="right">31.17663</td>
<td align="right">55.80523</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">4.3111823</td>
<td align="right">0</td>
<td align="left">TRIAL</td>
</tr>
<tr class="odd">
<td align="left">TRIAL5</td>
<td align="right">51.84943</td>
<td align="right">151.0312</td>
<td align="right">62.16361</td>
<td align="right">33.99677</td>
<td align="right">48.01981</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.2644848</td>
<td align="right">0</td>
<td align="left">TRIAL</td>
</tr>
<tr class="even">
<td align="left">TRIAL6</td>
<td align="right">51.81743</td>
<td align="right">148.1115</td>
<td align="right">68.69766</td>
<td align="right">33.82398</td>
<td align="right">47.32652</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.3103544</td>
<td align="right">0</td>
<td align="left">TRIAL</td>
</tr>
<tr class="odd">
<td align="left">TRIAL7</td>
<td align="right">58.04648</td>
<td align="right">150.2572</td>
<td align="right">71.35831</td>
<td align="right">38.71276</td>
<td align="right">50.68694</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1.7177436</td>
<td align="right">0</td>
<td align="left">TRIAL</td>
</tr>
<tr class="even">
<td align="left">TRIAL8</td>
<td align="right">50.72777</td>
<td align="right">147.1815</td>
<td align="right">64.55223</td>
<td align="right">33.86884</td>
<td align="right">49.31299</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">5.2652367</td>
<td align="right">0</td>
<td align="left">TRIAL</td>
</tr>
<tr class="odd">
<td align="left">TRIAL9</td>
<td align="right">55.16073</td>
<td align="right">145.0733</td>
<td align="right">63.84238</td>
<td align="right">36.28519</td>
<td align="right">50.27354</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">3.9595461</td>
<td align="right">1</td>
<td align="left">TRIAL</td>
</tr>
<tr class="even">
<td align="left">TRIAL10</td>
<td align="right">54.85184</td>
<td align="right">146.4757</td>
<td align="right">65.59890</td>
<td align="right">36.21950</td>
<td align="right">47.12495</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1.1788494</td>
<td align="right">1</td>
<td align="left">TRIAL</td>
</tr>
</tbody>
</table>
<p>The censoring and event rate in the RCT data is</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">trial.data</span><span class="op">$</span><span class="va">event</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">trial.data</span><span class="op">)</span> </span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         0         1 </span></span>
<span><span class="co">#&gt; 0.3883333 0.6116667</span></span></code></pre></div>
<p>The distribution of the outcome time is</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">trial.data</span><span class="op">$</span><span class="va">time</span><span class="op">)</span></span>
<span><span class="co">#&gt;     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span></span>
<span><span class="co">#&gt;  0.00771  0.35048  0.89904  1.61350  2.04652 21.27313</span></span></code></pre></div>
<p>The summary of each of the baseline covariates and their standardized
mean difference between treatment arms is shown below.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">myVars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="st">"Age"</span>, <span class="st">"Weight"</span>, <span class="st">"Height"</span>, <span class="st">"Biomarker1"</span>, <span class="st">"Biomarker2"</span>, <span class="st">"Smoker"</span>, <span class="st">"Sex"</span>,</span>
<span>          <span class="st">"ECOG1"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Vector of categorical variables </span></span>
<span><span class="va">catVars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="st">"Smoker"</span>, <span class="st">"Sex"</span>, <span class="st">"ECOG1"</span>, <span class="st">"group"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tab1</span> <span class="op">&lt;-</span> <span class="fu">CreateTableOne</span><span class="op">(</span>vars <span class="op">=</span> <span class="va">myVars</span>, strata <span class="op">=</span> <span class="st">"group"</span> , data <span class="op">=</span> <span class="va">trial.data</span>, factorVars <span class="op">=</span> <span class="va">catVars</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">tab1</span>,smd<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;                         Stratified by group</span></span>
<span><span class="co">#&gt;                          0              1              p      test SMD   </span></span>
<span><span class="co">#&gt;   n                         178            422                           </span></span>
<span><span class="co">#&gt;   Age (mean (SD))         54.82 (4.00)   55.08 (3.83)   0.451       0.067</span></span>
<span><span class="co">#&gt;   Weight (mean (SD))     150.18 (3.02)  149.92 (3.24)   0.357       0.084</span></span>
<span><span class="co">#&gt;   Height (mean (SD))      65.30 (2.39)   64.88 (2.49)   0.056       0.173</span></span>
<span><span class="co">#&gt;   Biomarker1 (mean (SD))  35.26 (2.38)   34.89 (2.16)   0.066       0.161</span></span>
<span><span class="co">#&gt;   Biomarker2 (mean (SD))  50.21 (2.52)   49.91 (2.43)   0.181       0.119</span></span>
<span><span class="co">#&gt;   Smoker = 1 (%)             32 (18.0)      87 (20.6)   0.530       0.067</span></span>
<span><span class="co">#&gt;   Sex = 1 (%)               132 (74.2)     344 (81.5)   0.054       0.178</span></span>
<span><span class="co">#&gt;   ECOG1 = 1 (%)              44 (24.7)     139 (32.9)   0.057       0.182</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulating-external-control-data">Simulating external control data<a class="anchor" aria-label="anchor" href="#simulating-external-control-data"></a>
</h2>
<p>The same set of covariates <span class="math inline">\(X\)</span>
were simulated for the external control data as the RCT. The means,
variances for continuous variables and proportion for categorical
variables are modified for the external controls compared to the RCT
according to the code below.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">means_cont_ec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="fl">55</span><span class="op">+</span><span class="fl">2</span>,<span class="fl">150</span><span class="op">-</span><span class="fl">2</span>,<span class="fl">65</span><span class="op">-</span><span class="fl">2</span>,<span class="fl">35</span><span class="op">+</span><span class="fl">2</span>,<span class="fl">50</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span> <span class="co">#Vector of means of continuous variables</span></span>
<span><span class="va">vars_cont_ec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="fl">14</span>,<span class="fl">10</span>,<span class="fl">5</span>,<span class="fl">5</span>,<span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">marginal_ec</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">0.3</span>,<span class="fl">0.7</span>,<span class="fl">0.4</span><span class="op">)</span></span>
<span><span class="va">ext.cont.data</span> <span class="op">&lt;-</span> <span class="fu">rcorrvar2</span><span class="op">(</span>n <span class="op">=</span> <span class="va">n_ec</span>, k_cont <span class="op">=</span> <span class="va">k_cont</span>, k_cat <span class="op">=</span> <span class="va">k_cat</span>, k_nb <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                        method <span class="op">=</span> <span class="st">"Fleishman"</span>,  seed<span class="op">=</span><span class="fl">3</span>,</span>
<span>                        means <span class="op">=</span> <span class="va">means_cont_ec</span>, vars <span class="op">=</span> <span class="va">vars_cont_ec</span>, <span class="co"># if continuous variables</span></span>
<span>                        skews <span class="op">=</span> <span class="va">skews_tc</span>, skurts <span class="op">=</span> <span class="va">skurts_tc</span>, </span>
<span>                        marginal<span class="op">=</span><span class="va">marginal_ec</span>, rho <span class="op">=</span> <span class="va">rho_tc</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Constants: Distribution  1  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Constants: Distribution  2  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Constants: Distribution  3  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Constants: Distribution  4  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Constants: Distribution  5  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Constants calculation time: 0.003 minutes </span></span>
<span><span class="co">#&gt; Intercorrelation calculation time: 0.001 minutes </span></span>
<span><span class="co">#&gt; Error loop calculation time: 0 minutes </span></span>
<span><span class="co">#&gt; Total Simulation time: 0.005 minutes</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ext.cont.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"EC"</span>,<span class="fl">1</span><span class="op">:</span><span class="va">n_ec</span>,sep<span class="op">=</span><span class="st">""</span><span class="op">)</span>, <span class="va">ext.cont.data</span><span class="op">$</span><span class="va">continuous_variables</span>, </span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">ext.cont.data</span><span class="op">$</span><span class="va">ordinal_variables</span><span class="op">==</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">ext.cont.data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="st">"ID"</span>, <span class="st">"Age"</span>, <span class="st">"Weight"</span>,<span class="st">"Height"</span>,<span class="st">"Biomarker1"</span>,<span class="st">"Biomarker2"</span>,<span class="st">"Smoker"</span>, <span class="st">"Sex"</span>, <span class="st">"ECOG1"</span><span class="op">)</span></span></code></pre></div>
<p>The same generating mechanism used for the RCT data was used to
simulate survival time for the external controls.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Simulate survival outcome using Cox proportional hazards regression model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1111</span><span class="op">)</span></span>
<span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">lambda0</span> <span class="op">&lt;-</span> <span class="fl">6</span> <span class="co">#constant baseline hazard</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.27</span>,<span class="op">-</span><span class="fl">0.1</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>,<span class="fl">0.1</span>,<span class="op">-</span><span class="fl">0.31</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">times</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">lambda0</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">ext.cont.data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">beta</span><span class="op">)</span><span class="op">)</span> <span class="co">#Inverse CDF method</span></span>
<span><span class="va">cens.time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="va">n_ec</span>,rate<span class="op">=</span><span class="fl">3</span><span class="op">)</span> <span class="co">#Censoring time from exponential distribution</span></span>
<span><span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">times</span> <span class="op">&lt;=</span> <span class="va">cens.time</span><span class="op">)</span> <span class="co">#Event indicator. 0 is censored.</span></span>
<span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">times</span>,<span class="va">cens.time</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Simulate treatment indicator in the trial data</span></span>
<span><span class="va">group</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="va">ext.cont.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">ext.cont.data</span>,<span class="va">group</span>,<span class="va">time</span>,<span class="va">event</span>,data<span class="op">=</span><span class="st">"EC"</span><span class="op">)</span></span></code></pre></div>
<p>The first 10 observations in the external control data is shown
below.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ext.cont.data</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="5%">
<col width="9%">
<col width="9%">
<col width="9%">
<col width="11%">
<col width="11%">
<col width="7%">
<col width="4%">
<col width="6%">
<col width="6%">
<col width="10%">
<col width="6%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="left">ID</th>
<th align="right">Age</th>
<th align="right">Weight</th>
<th align="right">Height</th>
<th align="right">Biomarker1</th>
<th align="right">Biomarker2</th>
<th align="right">Smoker</th>
<th align="right">Sex</th>
<th align="right">ECOG1</th>
<th align="right">group</th>
<th align="right">time</th>
<th align="right">event</th>
<th align="left">data</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">EC1</td>
<td align="right">58.84399</td>
<td align="right">149.2772</td>
<td align="right">60.14479</td>
<td align="right">41.13023</td>
<td align="right">47.84936</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.1368416</td>
<td align="right">1</td>
<td align="left">EC</td>
</tr>
<tr class="even">
<td align="left">EC2</td>
<td align="right">54.94800</td>
<td align="right">142.9350</td>
<td align="right">59.48098</td>
<td align="right">33.54165</td>
<td align="right">48.14581</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0.0316781</td>
<td align="right">0</td>
<td align="left">EC</td>
</tr>
<tr class="odd">
<td align="left">EC3</td>
<td align="right">56.60197</td>
<td align="right">144.2795</td>
<td align="right">65.27178</td>
<td align="right">37.10918</td>
<td align="right">49.17472</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.0269829</td>
<td align="right">0</td>
<td align="left">EC</td>
</tr>
<tr class="even">
<td align="left">EC4</td>
<td align="right">58.26515</td>
<td align="right">144.3181</td>
<td align="right">58.38123</td>
<td align="right">35.80290</td>
<td align="right">48.79969</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.5024074</td>
<td align="right">0</td>
<td align="left">EC</td>
</tr>
<tr class="odd">
<td align="left">EC5</td>
<td align="right">55.35845</td>
<td align="right">151.2542</td>
<td align="right">61.23105</td>
<td align="right">34.81402</td>
<td align="right">47.81858</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0.1666448</td>
<td align="right">1</td>
<td align="left">EC</td>
</tr>
<tr class="even">
<td align="left">EC6</td>
<td align="right">57.25913</td>
<td align="right">147.4564</td>
<td align="right">62.22442</td>
<td align="right">34.45358</td>
<td align="right">47.49526</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0.0889376</td>
<td align="right">0</td>
<td align="left">EC</td>
</tr>
<tr class="odd">
<td align="left">EC7</td>
<td align="right">60.09491</td>
<td align="right">143.2529</td>
<td align="right">64.61370</td>
<td align="right">38.69222</td>
<td align="right">48.54340</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.0368207</td>
<td align="right">0</td>
<td align="left">EC</td>
</tr>
<tr class="even">
<td align="left">EC8</td>
<td align="right">55.55786</td>
<td align="right">149.6638</td>
<td align="right">63.85947</td>
<td align="right">37.91138</td>
<td align="right">46.49153</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0.0307342</td>
<td align="right">1</td>
<td align="left">EC</td>
</tr>
<tr class="odd">
<td align="left">EC9</td>
<td align="right">59.11727</td>
<td align="right">143.3353</td>
<td align="right">61.02850</td>
<td align="right">35.18954</td>
<td align="right">47.95672</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.0379876</td>
<td align="right">0</td>
<td align="left">EC</td>
</tr>
<tr class="even">
<td align="left">EC10</td>
<td align="right">50.35400</td>
<td align="right">141.1806</td>
<td align="right">57.91327</td>
<td align="right">34.52789</td>
<td align="right">42.01203</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.2193177</td>
<td align="right">1</td>
<td align="left">EC</td>
</tr>
</tbody>
</table>
<p>The censoring and event rate in the trial data is</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">ext.cont.data</span><span class="op">$</span><span class="va">event</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">ext.cont.data</span><span class="op">)</span> </span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     0     1 </span></span>
<span><span class="co">#&gt; 0.328 0.672</span></span></code></pre></div>
<p>The distribution of the outcome time is</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ext.cont.data</span><span class="op">$</span><span class="va">time</span><span class="op">)</span></span>
<span><span class="co">#&gt;      Min.   1st Qu.    Median      Mean   3rd Qu.      Max. </span></span>
<span><span class="co">#&gt; 0.0000166 0.0211811 0.0542664 0.0995427 0.1207454 1.2824912</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="merging-trial-and-external-control-data">Merging trial and external control data<a class="anchor" aria-label="anchor" href="#merging-trial-and-external-control-data"></a>
</h2>
<p>We can use <code>bind_rows</code> function to merge two datasets.
Before using this function, we make sure that the column names for the
same variables are consistent in the two datasets.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ext.cont.data</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "ID"         "Age"        "Weight"     "Height"     "Biomarker1"</span></span>
<span><span class="co">#&gt;  [6] "Biomarker2" "Smoker"     "Sex"        "ECOG1"      "group"     </span></span>
<span><span class="co">#&gt; [11] "time"       "event"      "data"</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">trial.data</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "ID"         "Age"        "Weight"     "Height"     "Biomarker1"</span></span>
<span><span class="co">#&gt;  [6] "Biomarker2" "Smoker"     "Sex"        "ECOG1"      "group"     </span></span>
<span><span class="co">#&gt; [11] "time"       "event"      "data"</span></span>
<span><span class="co">#MS I recommend adding a statement that forces the colnames to be the same, like names(ex.cont.data)[1:10]=names(trial.data)[1:10]</span></span></code></pre></div>
<p>Now, we merge the two datasets.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">trial.data</span>,<span class="va">ext.cont.data</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">final.data</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="7%">
<col width="8%">
<col width="8%">
<col width="8%">
<col width="10%">
<col width="10%">
<col width="6%">
<col width="3%">
<col width="5%">
<col width="5%">
<col width="9%">
<col width="5%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="left">ID</th>
<th align="right">Age</th>
<th align="right">Weight</th>
<th align="right">Height</th>
<th align="right">Biomarker1</th>
<th align="right">Biomarker2</th>
<th align="right">Smoker</th>
<th align="right">Sex</th>
<th align="right">ECOG1</th>
<th align="right">group</th>
<th align="right">time</th>
<th align="right">event</th>
<th align="left">data</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">TRIAL1</td>
<td align="right">55.51419</td>
<td align="right">148.5092</td>
<td align="right">65.63899</td>
<td align="right">33.71898</td>
<td align="right">55.26178</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.4089043</td>
<td align="right">0</td>
<td align="left">TRIAL</td>
</tr>
<tr class="even">
<td align="left">TRIAL2</td>
<td align="right">49.93326</td>
<td align="right">146.9441</td>
<td align="right">63.44883</td>
<td align="right">35.65828</td>
<td align="right">45.50928</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0.9721405</td>
<td align="right">0</td>
<td align="left">TRIAL</td>
</tr>
<tr class="odd">
<td align="left">TRIAL3</td>
<td align="right">58.51588</td>
<td align="right">153.5435</td>
<td align="right">70.53193</td>
<td align="right">35.53710</td>
<td align="right">55.89283</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.2956919</td>
<td align="right">0</td>
<td align="left">TRIAL</td>
</tr>
<tr class="even">
<td align="left">TRIAL4</td>
<td align="right">48.61226</td>
<td align="right">147.2873</td>
<td align="right">64.10615</td>
<td align="right">31.17663</td>
<td align="right">55.80523</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">4.3111823</td>
<td align="right">0</td>
<td align="left">TRIAL</td>
</tr>
<tr class="odd">
<td align="left">TRIAL5</td>
<td align="right">51.84943</td>
<td align="right">151.0312</td>
<td align="right">62.16361</td>
<td align="right">33.99677</td>
<td align="right">48.01981</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.2644848</td>
<td align="right">0</td>
<td align="left">TRIAL</td>
</tr>
<tr class="even">
<td align="left">TRIAL6</td>
<td align="right">51.81743</td>
<td align="right">148.1115</td>
<td align="right">68.69766</td>
<td align="right">33.82398</td>
<td align="right">47.32652</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.3103544</td>
<td align="right">0</td>
<td align="left">TRIAL</td>
</tr>
<tr class="odd">
<td align="left">TRIAL7</td>
<td align="right">58.04648</td>
<td align="right">150.2572</td>
<td align="right">71.35831</td>
<td align="right">38.71276</td>
<td align="right">50.68694</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1.7177436</td>
<td align="right">0</td>
<td align="left">TRIAL</td>
</tr>
<tr class="even">
<td align="left">TRIAL8</td>
<td align="right">50.72777</td>
<td align="right">147.1815</td>
<td align="right">64.55223</td>
<td align="right">33.86884</td>
<td align="right">49.31299</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">5.2652367</td>
<td align="right">0</td>
<td align="left">TRIAL</td>
</tr>
<tr class="odd">
<td align="left">TRIAL9</td>
<td align="right">55.16073</td>
<td align="right">145.0733</td>
<td align="right">63.84238</td>
<td align="right">36.28519</td>
<td align="right">50.27354</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">3.9595461</td>
<td align="right">1</td>
<td align="left">TRIAL</td>
</tr>
<tr class="even">
<td align="left">TRIAL10</td>
<td align="right">54.85184</td>
<td align="right">146.4757</td>
<td align="right">65.59890</td>
<td align="right">36.21950</td>
<td align="right">47.12495</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1.1788494</td>
<td align="right">1</td>
<td align="left">TRIAL</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">final.data</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="4%">
<col width="5%">
<col width="8%">
<col width="8%">
<col width="8%">
<col width="10%">
<col width="10%">
<col width="6%">
<col width="3%">
<col width="5%">
<col width="5%">
<col width="9%">
<col width="5%">
<col width="4%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="left">ID</th>
<th align="right">Age</th>
<th align="right">Weight</th>
<th align="right">Height</th>
<th align="right">Biomarker1</th>
<th align="right">Biomarker2</th>
<th align="right">Smoker</th>
<th align="right">Sex</th>
<th align="right">ECOG1</th>
<th align="right">group</th>
<th align="right">time</th>
<th align="right">event</th>
<th align="left">data</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">1091</td>
<td align="left">EC491</td>
<td align="right">54.63798</td>
<td align="right">142.7690</td>
<td align="right">62.33772</td>
<td align="right">31.74800</td>
<td align="right">46.58420</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0.0880112</td>
<td align="right">1</td>
<td align="left">EC</td>
</tr>
<tr class="even">
<td align="left">1092</td>
<td align="left">EC492</td>
<td align="right">58.95356</td>
<td align="right">155.2625</td>
<td align="right">62.49057</td>
<td align="right">39.68135</td>
<td align="right">53.22807</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.0578393</td>
<td align="right">0</td>
<td align="left">EC</td>
</tr>
<tr class="odd">
<td align="left">1093</td>
<td align="left">EC493</td>
<td align="right">56.71679</td>
<td align="right">142.0092</td>
<td align="right">65.47906</td>
<td align="right">37.46290</td>
<td align="right">47.76221</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.0157931</td>
<td align="right">1</td>
<td align="left">EC</td>
</tr>
<tr class="even">
<td align="left">1094</td>
<td align="left">EC494</td>
<td align="right">54.01146</td>
<td align="right">142.2547</td>
<td align="right">61.43211</td>
<td align="right">36.80426</td>
<td align="right">46.80182</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0.0241804</td>
<td align="right">1</td>
<td align="left">EC</td>
</tr>
<tr class="odd">
<td align="left">1095</td>
<td align="left">EC495</td>
<td align="right">54.97775</td>
<td align="right">147.9758</td>
<td align="right">59.52286</td>
<td align="right">38.58231</td>
<td align="right">46.74939</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.0937779</td>
<td align="right">0</td>
<td align="left">EC</td>
</tr>
<tr class="even">
<td align="left">1096</td>
<td align="left">EC496</td>
<td align="right">51.57175</td>
<td align="right">150.7496</td>
<td align="right">61.26278</td>
<td align="right">33.03108</td>
<td align="right">45.15747</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.1023785</td>
<td align="right">0</td>
<td align="left">EC</td>
</tr>
<tr class="odd">
<td align="left">1097</td>
<td align="left">EC497</td>
<td align="right">55.43787</td>
<td align="right">145.5014</td>
<td align="right">60.75110</td>
<td align="right">37.98437</td>
<td align="right">53.90082</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.0636704</td>
<td align="right">1</td>
<td align="left">EC</td>
</tr>
<tr class="even">
<td align="left">1098</td>
<td align="left">EC498</td>
<td align="right">58.63598</td>
<td align="right">148.5516</td>
<td align="right">62.83803</td>
<td align="right">41.17086</td>
<td align="right">48.23983</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.0511597</td>
<td align="right">1</td>
<td align="left">EC</td>
</tr>
<tr class="odd">
<td align="left">1099</td>
<td align="left">EC499</td>
<td align="right">59.18113</td>
<td align="right">150.7839</td>
<td align="right">64.16530</td>
<td align="right">32.80313</td>
<td align="right">47.07868</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.0295196</td>
<td align="right">0</td>
<td align="left">EC</td>
</tr>
<tr class="even">
<td align="left">1100</td>
<td align="left">EC500</td>
<td align="right">57.65147</td>
<td align="right">149.4489</td>
<td align="right">63.26176</td>
<td align="right">35.64399</td>
<td align="right">47.01619</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.0514581</td>
<td align="right">0</td>
<td align="left">EC</td>
</tr>
</tbody>
</table>
<p>We examine the standardized mean difference for covariates between
the RCT and external control data before conducting matching/weighting.
Note that <code>strata="data"</code> in the following code.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tab2</span> <span class="op">&lt;-</span> <span class="fu">CreateTableOne</span><span class="op">(</span>vars <span class="op">=</span> <span class="va">myVars</span>, strata <span class="op">=</span> <span class="st">"data"</span> , data <span class="op">=</span> <span class="va">final.data</span>, factorVars <span class="op">=</span> <span class="va">catVars</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">tab2</span>,smd<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;                         Stratified by data</span></span>
<span><span class="co">#&gt;                          EC             TRIAL          p      test SMD   </span></span>
<span><span class="co">#&gt;   n                         500            600                           </span></span>
<span><span class="co">#&gt;   Age (mean (SD))         57.00 (3.72)   55.00 (3.88)  &lt;0.001       0.526</span></span>
<span><span class="co">#&gt;   Weight (mean (SD))     148.00 (3.15)  150.00 (3.17)  &lt;0.001       0.633</span></span>
<span><span class="co">#&gt;   Height (mean (SD))      63.00 (2.23)   65.00 (2.47)  &lt;0.001       0.850</span></span>
<span><span class="co">#&gt;   Biomarker1 (mean (SD))  37.00 (2.24)   35.00 (2.24)  &lt;0.001       0.894</span></span>
<span><span class="co">#&gt;   Biomarker2 (mean (SD))  48.00 (2.23)   50.00 (2.46)  &lt;0.001       0.853</span></span>
<span><span class="co">#&gt;   Smoker = 1 (%)            145 (29.0)     119 (19.8)   0.001       0.215</span></span>
<span><span class="co">#&gt;   Sex = 1 (%)               355 (71.0)     476 (79.3)   0.002       0.194</span></span>
<span><span class="co">#&gt;   ECOG1 = 1 (%)             195 (39.0)     183 (30.5)   0.004       0.179</span></span></code></pre></div>
<p>Note that the standardized mean difference for all covariates is
large. Next, we will conduct matching/weighting approach to reduce
difference in baseline characteristics.</p>
<p>We also examine the standardized mean difference for covariates
between the treated and control patients before conducting
matching/weighting. Note that <code>strata="group"</code> in the
following code.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tab2</span> <span class="op">&lt;-</span> <span class="fu">CreateTableOne</span><span class="op">(</span>vars <span class="op">=</span> <span class="va">myVars</span>, strata <span class="op">=</span> <span class="st">"group"</span> , data <span class="op">=</span> <span class="va">final.data</span>, factorVars <span class="op">=</span> <span class="va">catVars</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">tab2</span>,smd<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;                         Stratified by group</span></span>
<span><span class="co">#&gt;                          0              1              p      test SMD   </span></span>
<span><span class="co">#&gt;   n                         678            422                           </span></span>
<span><span class="co">#&gt;   Age (mean (SD))         56.43 (3.91)   55.08 (3.83)  &lt;0.001       0.348</span></span>
<span><span class="co">#&gt;   Weight (mean (SD))     148.57 (3.26)  149.92 (3.24)  &lt;0.001       0.416</span></span>
<span><span class="co">#&gt;   Height (mean (SD))      63.60 (2.49)   64.88 (2.49)  &lt;0.001       0.511</span></span>
<span><span class="co">#&gt;   Biomarker1 (mean (SD))  36.54 (2.40)   34.89 (2.16)  &lt;0.001       0.723</span></span>
<span><span class="co">#&gt;   Biomarker2 (mean (SD))  48.58 (2.50)   49.91 (2.43)  &lt;0.001       0.541</span></span>
<span><span class="co">#&gt;   Smoker = 1 (%)            177 (26.1)      87 (20.6)   0.045       0.130</span></span>
<span><span class="co">#&gt;   Sex = 1 (%)               487 (71.8)     344 (81.5)  &lt;0.001       0.231</span></span>
<span><span class="co">#&gt;   ECOG1 = 1 (%)             239 (35.3)     139 (32.9)   0.472       0.049</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="propensity-scores-overlap">Propensity scores overlap<a class="anchor" aria-label="anchor" href="#propensity-scores-overlap"></a>
</h2>
<p>Before applying the matching/weighting methods, we investigate the
overlapping of propensity scores. The overlapping coefficient is only
<span class="math inline">\(0.19\)</span> indicating a very small
overlap.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final.data</span><span class="op">$</span><span class="va">indicator</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">final.data</span><span class="op">$</span><span class="va">data</span><span class="op">==</span><span class="st">"TRIAL"</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">ps.logit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">indicator</span> <span class="op">~</span> <span class="va">Age</span> <span class="op">+</span> <span class="va">Weight</span> <span class="op">+</span> <span class="va">Height</span> <span class="op">+</span> <span class="va">Biomarker1</span>  <span class="op">+</span> <span class="va">Biomarker2</span> <span class="op">+</span> <span class="va">Smoker</span> <span class="op">+</span></span>
<span>                            <span class="va">Sex</span> <span class="op">+</span><span class="va">ECOG1</span>, data <span class="op">=</span> <span class="va">final.data</span>,</span>
<span>                            family<span class="op">=</span><span class="va">binomial</span><span class="op">)</span></span>
<span><span class="va">psfit</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">ps.logit</span>,type <span class="op">=</span> <span class="st">"response"</span>,data<span class="op">=</span><span class="va">final.data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ps_trial</span> <span class="op">&lt;-</span> <span class="va">psfit</span><span class="op">[</span><span class="va">final.data</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span> </span>
<span><span class="va">ps_extcont</span> <span class="op">&lt;-</span> <span class="va">psfit</span><span class="op">[</span><span class="va">final.data</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">overlap</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ps_trial<span class="op">=</span><span class="va">ps_trial</span>, ps_extcont<span class="op">=</span><span class="va">ps_extcont</span><span class="op">)</span>,plot<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="figure-match_weight_01_methods-unnamed-chunk-28-1.png" alt="plot of chunk unnamed-chunk-28"><p class="caption">
plot of chunk unnamed-chunk-28
</p>
</div>
<pre><code><span><span class="co">#&gt; $OV</span></span>
<span><span class="co">#&gt; [1] 0.3875297</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="matching-methods">Matching Methods<a class="anchor" aria-label="anchor" href="#matching-methods"></a>
</h2>
<p>We will explore several matching methods to balance the balance the
baseline characteristics between subjects in the RCT and external
control data.</p>
<ul>
<li>Matching methods
<ul>
<li>1:1 Nearest Neighbor Propensity score matching with a caliper width
of 0.2 of the standard deviation of the logit of the propensity score
(PSML)</li>
<li>1:1 Nearest Neighbor Propensity score matching with a caliper width
of 0.2 of the standard deviation of raw propensity score (PSMR)</li>
<li>Genetic matching with replacement (GM)</li>
<li>1:1 Genetic matching without replacement (GMW)</li>
<li>1:1 Optimal matching (OM)</li>
</ul>
</li>
</ul>
<p>All of the matching methods can be conducted using the
<code>MatchIt</code> package. The matching is conducted between the RCT
subjects and external control subjects. Hence, we introduce a variable
named <code>indicator</code> in <code>final.data</code> to represent the
data source indicator.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final.data</span><span class="op">$</span><span class="va">indicator</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">final.data</span><span class="op">$</span><span class="va">data</span><span class="op">==</span><span class="st">"TRIAL"</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="psml">PSML<a class="anchor" aria-label="anchor" href="#psml"></a>
</h3>
<p>This matching method is a variation of nearest neighbour or greedy
matching that selects matches based on the difference in the logit of
the propensity score, up to a certain distance (caliper) <span class="citation">(Austin 2011)</span>. We selected a caliper width of
0.2 of the standard deviation of the logit of the propensity score,
where the propensity score is estimated using a logistic regression.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m.out.nearest.ratio1.caliper.lps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html" class="external-link">matchit</a></span><span class="op">(</span><span class="va">indicator</span> <span class="op">~</span> <span class="va">Age</span> <span class="op">+</span> <span class="va">Weight</span> <span class="op">+</span> <span class="va">Height</span> <span class="op">+</span> <span class="va">Biomarker1</span>  <span class="op">+</span> <span class="va">Biomarker2</span> <span class="op">+</span> <span class="va">Smoker</span> <span class="op">+</span></span>
<span>                                                        <span class="va">Sex</span> <span class="op">+</span><span class="va">ECOG1</span>, estimand<span class="op">=</span><span class="st">"ATT"</span>,data <span class="op">=</span> <span class="va">final.data</span>, </span>
<span>                                                        method<span class="op">=</span><span class="st">"nearest"</span>,ratio<span class="op">=</span><span class="fl">1</span>,caliper<span class="op">=</span><span class="fl">0.20</span>,</span>
<span>                                                        distance<span class="op">=</span><span class="st">"glm"</span>,link<span class="op">=</span><span class="st">"linear.logit"</span>,replace<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>                                                        m.order<span class="op">=</span><span class="st">"largest"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Fewer control units than treated units; not all treated units will get</span></span>
<span><span class="co">#&gt; a match.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m.out.nearest.ratio1.caliper.lps</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; matchit(formula = indicator ~ Age + Weight + Height + Biomarker1 + </span></span>
<span><span class="co">#&gt;     Biomarker2 + Smoker + Sex + ECOG1, data = final.data, method = "nearest", </span></span>
<span><span class="co">#&gt;     distance = "glm", link = "linear.logit", estimand = "ATT", </span></span>
<span><span class="co">#&gt;     replace = FALSE, m.order = "largest", caliper = 0.2, ratio = 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for All Data:</span></span>
<span><span class="co">#&gt;            Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance          2.0386       -1.6416          1.8769     1.0922    0.4123</span></span>
<span><span class="co">#&gt; Age              55.0001       56.9985         -0.5151     1.0883    0.1497</span></span>
<span><span class="co">#&gt; Weight          150.0006      147.9990          0.6306     1.0170    0.1673</span></span>
<span><span class="co">#&gt; Height           65.0010       62.9998          0.8104     1.2222    0.2232</span></span>
<span><span class="co">#&gt; Biomarker1       34.9998       36.9999         -0.8948     0.9984    0.2397</span></span>
<span><span class="co">#&gt; Biomarker2       50.0003       47.9994          0.8138     1.2180    0.2254</span></span>
<span><span class="co">#&gt; Smoker            0.1983        0.2900         -0.2299          .    0.0917</span></span>
<span><span class="co">#&gt; Sex               0.7933        0.7100          0.2058          .    0.0833</span></span>
<span><span class="co">#&gt; ECOG1             0.3050        0.3900         -0.1846          .    0.0850</span></span>
<span><span class="co">#&gt;            eCDF Max</span></span>
<span><span class="co">#&gt; distance     0.6657</span></span>
<span><span class="co">#&gt; Age          0.2277</span></span>
<span><span class="co">#&gt; Weight       0.2493</span></span>
<span><span class="co">#&gt; Height       0.3247</span></span>
<span><span class="co">#&gt; Biomarker1   0.3717</span></span>
<span><span class="co">#&gt; Biomarker2   0.3463</span></span>
<span><span class="co">#&gt; Smoker       0.0917</span></span>
<span><span class="co">#&gt; Sex          0.0833</span></span>
<span><span class="co">#&gt; ECOG1        0.0850</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for Matched Data:</span></span>
<span><span class="co">#&gt;            Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance          0.3084       -0.0768          0.1964     1.2651    0.0495</span></span>
<span><span class="co">#&gt; Age              55.9994       56.1273         -0.0330     1.2535    0.0200</span></span>
<span><span class="co">#&gt; Weight          149.0622      148.8328          0.0723     0.9531    0.0202</span></span>
<span><span class="co">#&gt; Height           63.9366       63.8937          0.0174     0.9519    0.0195</span></span>
<span><span class="co">#&gt; Biomarker1       35.8765       36.2704         -0.1762     1.1409    0.0574</span></span>
<span><span class="co">#&gt; Biomarker2       49.0364       48.8589          0.0722     1.0945    0.0225</span></span>
<span><span class="co">#&gt; Smoker            0.2455        0.2277          0.0448          .    0.0179</span></span>
<span><span class="co">#&gt; Sex               0.7857        0.7723          0.0331          .    0.0134</span></span>
<span><span class="co">#&gt; ECOG1             0.3304        0.3348         -0.0097          .    0.0045</span></span>
<span><span class="co">#&gt;            eCDF Max Std. Pair Dist.</span></span>
<span><span class="co">#&gt; distance     0.1786          0.1973</span></span>
<span><span class="co">#&gt; Age          0.0491          1.1372</span></span>
<span><span class="co">#&gt; Weight       0.0536          1.1005</span></span>
<span><span class="co">#&gt; Height       0.0625          0.9848</span></span>
<span><span class="co">#&gt; Biomarker1   0.1473          1.0799</span></span>
<span><span class="co">#&gt; Biomarker2   0.0536          0.9051</span></span>
<span><span class="co">#&gt; Smoker       0.0179          0.9628</span></span>
<span><span class="co">#&gt; Sex          0.0134          0.8489</span></span>
<span><span class="co">#&gt; ECOG1        0.0045          0.9987</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample Sizes:</span></span>
<span><span class="co">#&gt;           Control Treated</span></span>
<span><span class="co">#&gt; All           500     600</span></span>
<span><span class="co">#&gt; Matched       224     224</span></span>
<span><span class="co">#&gt; Unmatched     276     376</span></span>
<span><span class="co">#&gt; Discarded       0       0</span></span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final.data</span><span class="op">$</span><span class="va">ratio1_caliper_weights_lps</span> <span class="op">=</span> <span class="va">m.out.nearest.ratio1.caliper.lps</span><span class="op">$</span><span class="va">weights</span></span></code></pre></div>
<p>We now compare the SMD between the two datasets.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span>id <span class="op">=</span> <span class="op">~</span><span class="fl">0</span>, data<span class="op">=</span><span class="va">final.data</span>,weights <span class="op">=</span> <span class="op">~</span><span class="va">ratio1_caliper_weights_lps</span><span class="op">)</span></span>
<span><span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu">svyCreateTableOne</span><span class="op">(</span>vars <span class="op">=</span> <span class="va">myVars</span>, strata <span class="op">=</span> <span class="st">"data"</span> , data <span class="op">=</span> <span class="va">svy</span>, factorVars <span class="op">=</span> <span class="va">catVars</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">t1</span>,smd<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;                         Stratified by data</span></span>
<span><span class="co">#&gt;                          EC             TRIAL          p      test SMD   </span></span>
<span><span class="co">#&gt;   n                      224.00         224.00                           </span></span>
<span><span class="co">#&gt;   Age (mean (SD))         56.13 (3.63)   56.00 (4.06)   0.725       0.033</span></span>
<span><span class="co">#&gt;   Weight (mean (SD))     148.83 (3.14)  149.06 (3.07)   0.434       0.074</span></span>
<span><span class="co">#&gt;   Height (mean (SD))      63.89 (2.14)   63.94 (2.08)   0.829       0.020</span></span>
<span><span class="co">#&gt;   Biomarker1 (mean (SD))  36.27 (2.10)   35.88 (2.25)   0.056       0.181</span></span>
<span><span class="co">#&gt;   Biomarker2 (mean (SD))  48.86 (2.12)   49.04 (2.21)   0.385       0.082</span></span>
<span><span class="co">#&gt;   Smoker = 1 (%)           51.0 (22.8)    55.0 (24.6)   0.657       0.042</span></span>
<span><span class="co">#&gt;   Sex = 1 (%)             173.0 (77.2)   176.0 (78.6)   0.733       0.032</span></span>
<span><span class="co">#&gt;   ECOG1 = 1 (%)            75.0 (33.5)    74.0 (33.0)   0.920       0.009</span></span></code></pre></div>
<!-- "Hi Ming, does the following make sense to you? Maybe we don't need this. I am thinking to include SMD between the data sets as well as the SMD between all treated patients and all control patients from trial along with matched external control patients." -->
<!-- We also examine the SMD between all treated patients and all control patients from trial along with matched external control patients. -->
<!-- ```{r message=FALSE} -->
<!-- final.data$ratio1_caliper_weights_lps_star = 1 -->
<!-- final.data$ratio1_caliper_weights_lps_star[final.data$data=="EC"] = final.data$ratio1_caliper_weights_lps[final.data$data=="EC"] -->
<!-- ``` -->
<!-- ```{r message=FALSE} -->
<!-- svy <- svydesign(id = ~0, data=final.data,weights = ~ratio1_caliper_weights_lps_star) -->
<!-- t1 <- svyCreateTableOne(vars = myVars, strata = "group" , data = svy, factorVars = catVars) -->
<!-- ``` -->
<!-- ```{r message=FALSE} -->
<!-- print(t1,smd=TRUE) -->
<!-- ``` -->
</div>
<div class="section level3">
<h3 id="psmr">PSMR<a class="anchor" aria-label="anchor" href="#psmr"></a>
</h3>
<p>This matching method is similar to PSML except the caliper width of
0.2 is based on the standard deviation of the propensity score scale
<span class="citation">(Stuart et al. 2011)</span>.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m.out.nearest.ratio1.caliper</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html" class="external-link">matchit</a></span><span class="op">(</span><span class="va">indicator</span> <span class="op">~</span> <span class="va">Age</span> <span class="op">+</span> <span class="va">Weight</span> <span class="op">+</span> <span class="va">Height</span> <span class="op">+</span> <span class="va">Biomarker1</span>  <span class="op">+</span> <span class="va">Biomarker2</span> <span class="op">+</span> <span class="va">Smoker</span> <span class="op">+</span></span>
<span>                                                    <span class="va">Sex</span> <span class="op">+</span><span class="va">ECOG1</span>, estimand<span class="op">=</span><span class="st">"ATT"</span>,data <span class="op">=</span> <span class="va">final.data</span>, </span>
<span>                                                    method <span class="op">=</span> <span class="st">"nearest"</span>,  ratio <span class="op">=</span> <span class="fl">1</span>, caliper<span class="op">=</span><span class="fl">0.2</span>, replace<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Fewer control units than treated units; not all treated units will get</span></span>
<span><span class="co">#&gt; a match.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m.out.nearest.ratio1.caliper</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; matchit(formula = indicator ~ Age + Weight + Height + Biomarker1 + </span></span>
<span><span class="co">#&gt;     Biomarker2 + Smoker + Sex + ECOG1, data = final.data, method = "nearest", </span></span>
<span><span class="co">#&gt;     estimand = "ATT", replace = FALSE, caliper = 0.2, ratio = 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for All Data:</span></span>
<span><span class="co">#&gt;            Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance          0.7827        0.2608          2.1517     0.8827    0.4123</span></span>
<span><span class="co">#&gt; Age              55.0001       56.9985         -0.5151     1.0883    0.1497</span></span>
<span><span class="co">#&gt; Weight          150.0006      147.9990          0.6306     1.0170    0.1673</span></span>
<span><span class="co">#&gt; Height           65.0010       62.9998          0.8104     1.2222    0.2232</span></span>
<span><span class="co">#&gt; Biomarker1       34.9998       36.9999         -0.8948     0.9984    0.2397</span></span>
<span><span class="co">#&gt; Biomarker2       50.0003       47.9994          0.8138     1.2180    0.2254</span></span>
<span><span class="co">#&gt; Smoker            0.1983        0.2900         -0.2299          .    0.0917</span></span>
<span><span class="co">#&gt; Sex               0.7933        0.7100          0.2058          .    0.0833</span></span>
<span><span class="co">#&gt; ECOG1             0.3050        0.3900         -0.1846          .    0.0850</span></span>
<span><span class="co">#&gt;            eCDF Max</span></span>
<span><span class="co">#&gt; distance     0.6657</span></span>
<span><span class="co">#&gt; Age          0.2277</span></span>
<span><span class="co">#&gt; Weight       0.2493</span></span>
<span><span class="co">#&gt; Height       0.3247</span></span>
<span><span class="co">#&gt; Biomarker1   0.3717</span></span>
<span><span class="co">#&gt; Biomarker2   0.3463</span></span>
<span><span class="co">#&gt; Smoker       0.0917</span></span>
<span><span class="co">#&gt; Sex          0.0833</span></span>
<span><span class="co">#&gt; ECOG1        0.0850</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for Matched Data:</span></span>
<span><span class="co">#&gt;            Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance          0.5431        0.5011          0.1731     1.2229    0.0367</span></span>
<span><span class="co">#&gt; Age              56.0260       56.1310         -0.0271     1.1311    0.0181</span></span>
<span><span class="co">#&gt; Weight          148.9502      148.8880          0.0196     0.9491    0.0181</span></span>
<span><span class="co">#&gt; Height           64.1172       63.9245          0.0781     1.1794    0.0170</span></span>
<span><span class="co">#&gt; Biomarker1       35.9585       36.1764         -0.0975     1.1896    0.0426</span></span>
<span><span class="co">#&gt; Biomarker2       49.2512       48.9165          0.1361     1.4438    0.0344</span></span>
<span><span class="co">#&gt; Smoker            0.2266        0.2365         -0.0247          .    0.0099</span></span>
<span><span class="co">#&gt; Sex               0.7734        0.7734          0.0000          .    0.0000</span></span>
<span><span class="co">#&gt; ECOG1             0.3251        0.3498         -0.0535          .    0.0246</span></span>
<span><span class="co">#&gt;            eCDF Max Std. Pair Dist.</span></span>
<span><span class="co">#&gt; distance     0.1133          0.1743</span></span>
<span><span class="co">#&gt; Age          0.0443          1.1398</span></span>
<span><span class="co">#&gt; Weight       0.0640          1.0586</span></span>
<span><span class="co">#&gt; Height       0.0443          1.0077</span></span>
<span><span class="co">#&gt; Biomarker1   0.1182          0.9965</span></span>
<span><span class="co">#&gt; Biomarker2   0.0739          0.9127</span></span>
<span><span class="co">#&gt; Smoker       0.0099          0.9883</span></span>
<span><span class="co">#&gt; Sex          0.0000          0.3448</span></span>
<span><span class="co">#&gt; ECOG1        0.0246          0.9950</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample Sizes:</span></span>
<span><span class="co">#&gt;           Control Treated</span></span>
<span><span class="co">#&gt; All           500     600</span></span>
<span><span class="co">#&gt; Matched       203     203</span></span>
<span><span class="co">#&gt; Unmatched     297     397</span></span>
<span><span class="co">#&gt; Discarded       0       0</span></span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final.data</span><span class="op">$</span><span class="va">ratio1_caliper_weights</span> <span class="op">=</span> <span class="va">m.out.nearest.ratio1.caliper</span><span class="op">$</span><span class="va">weights</span></span></code></pre></div>
<p>We now compare the SMD between the two datasets.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span>id <span class="op">=</span> <span class="op">~</span><span class="fl">0</span>, data<span class="op">=</span><span class="va">final.data</span>,weights <span class="op">=</span> <span class="op">~</span><span class="va">ratio1_caliper_weights</span><span class="op">)</span></span>
<span><span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu">svyCreateTableOne</span><span class="op">(</span>vars <span class="op">=</span> <span class="va">myVars</span>, strata <span class="op">=</span> <span class="st">"data"</span> , data <span class="op">=</span> <span class="va">svy</span>, factorVars <span class="op">=</span> <span class="va">catVars</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">t1</span>,smd<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;                         Stratified by data</span></span>
<span><span class="co">#&gt;                          EC             TRIAL          p      test SMD   </span></span>
<span><span class="co">#&gt;   n                      203.00         203.00                           </span></span>
<span><span class="co">#&gt;   Age (mean (SD))         56.13 (3.63)   56.03 (3.86)   0.777       0.028</span></span>
<span><span class="co">#&gt;   Weight (mean (SD))     148.89 (3.15)  148.95 (3.07)   0.840       0.020</span></span>
<span><span class="co">#&gt;   Height (mean (SD))      63.92 (2.15)   64.12 (2.34)   0.387       0.086</span></span>
<span><span class="co">#&gt;   Biomarker1 (mean (SD))  36.18 (2.07)   35.96 (2.26)   0.312       0.100</span></span>
<span><span class="co">#&gt;   Biomarker2 (mean (SD))  48.92 (2.07)   49.25 (2.49)   0.141       0.146</span></span>
<span><span class="co">#&gt;   Smoker = 1 (%)           48.0 (23.6)    46.0 (22.7)   0.814       0.023</span></span>
<span><span class="co">#&gt;   Sex = 1 (%)             157.0 (77.3)   157.0 (77.3)   1.000      &lt;0.001</span></span>
<span><span class="co">#&gt;   ECOG1 = 1 (%)            71.0 (35.0)    66.0 (32.5)   0.600       0.052</span></span></code></pre></div>
<!-- We also examine the SMD between all treated patients and all control patients from trial along with matched external control patients. -->
<!-- ```{r message=FALSE} -->
<!--  final.data$ratio1_caliper_weights_star = 1 -->
<!--  final.data$ratio1_caliper_weights_star[final.data$data=="EC"] = final.data$ratio1_caliper_weights[final.data$data=="EC"] -->
<!-- ``` -->
<!-- ```{r message=FALSE} -->
<!-- svy <- svydesign(id = ~0, data=final.data,weights = ~ratio1_caliper_weights_star) -->
<!-- t1 <- svyCreateTableOne(vars = myVars, strata = "group" , data = svy, factorVars = catVars) -->
<!-- ``` -->
<!-- ```{r message=FALSE} -->
<!-- print(t1,smd=TRUE) -->
<!-- ``` -->
<!-- ```{r message=FALSE} -->
<!-- ##MS: I think we should be consistent throughout the matching section in terms of which SMDS we present. We should certainly present the comparison between RCT and matched controls. We can also present treated + hybrid controls, but should be consistent throughout the vignette. -->
<!-- #head(final.data) -->
<!-- ``` -->
</div>
<div class="section level3">
<h3 id="gm">GM<a class="anchor" aria-label="anchor" href="#gm"></a>
</h3>
<p>Genetic matching is a form of nearest neighbor matching where
distances are computed using the generalized Mahalanobis distance, which
is a generalization of the Mahalanobis distance with a scaling factor
for each covariate that represents the importance of that covariate to
the distance. A genetic algorithm is used to select the scaling factors.
Matching is done with replacement, so an external control can be a
matched for more than one patient in the treatment arm. Weighting is
used to maintain the sample size in the treated arm <span class="citation">(Sekhon 2008)</span>.</p>
<p>For a treated unit <span class="math inline">\(i\)</span> and a
control unit <span class="math inline">\(j\)</span>, genetic matching
uses the generalized Mahalanobis distance as <span class="math display">\[\delta_{GMD}(\mathbf{x}_i,\mathbf{x}_j,
\mathbf{W})=\sqrt{(\mathbf{x}_i -
\mathbf{x}_j)'(\mathbf{S}^{-1/2})'\mathbf{W}(\mathbf{S}^{-1/2})(\mathbf{x}_i
- \mathbf{x}_j)}\]</span> where <span class="math inline">\(\mathbf{x}\)</span> is a <span class="math inline">\(p \times 1\)</span> vector containing the value of
each of the <span class="math inline">\(p\)</span> included covariates
for that unit, <span class="math inline">\(\mathbf{S}^{-1/2}\)</span> is
the Cholesky decomposition of the covariance matrix <span class="math inline">\(\mathbf{S}\)</span> of the covariates, and <span class="math inline">\(\mathbf{W}\)</span> is a diagonal matrix with
scaling factors <span class="math inline">\(w\)</span> on the diagonal
<span class="citation">(Greifer 2020)</span>. <span class="math display">\[
  \begin{pmatrix}
    w_1 &amp; 0 &amp; \dots &amp; 0 \\
    0 &amp; w_2 &amp; \dots &amp; 0 \\
    \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
    0 &amp; 0 &amp; \dots &amp; w_p
  \end{pmatrix}
\]</span></p>
<p>If <span class="math inline">\(w_k=1\)</span> for all <span class="math inline">\(k\)</span> then the distance is the standard
Mahalanobis distance. However, genetic matching estimates the optimal
<span class="math inline">\(w_k\)</span>s. The default is to maximize
the smallest p-value among balance tests for the covariates in the
matched sample (both Kolmogorov-Smirnov tests and t-tests for each
covariate) <span class="citation">(Greifer 2020)</span>.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m.out.genetic.ratio1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html" class="external-link">matchit</a></span><span class="op">(</span><span class="va">indicator</span> <span class="op">~</span> <span class="va">Age</span> <span class="op">+</span> <span class="va">Weight</span> <span class="op">+</span> <span class="va">Height</span> <span class="op">+</span> <span class="va">Biomarker1</span>  <span class="op">+</span> <span class="va">Biomarker2</span> <span class="op">+</span> <span class="va">Smoker</span> <span class="op">+</span></span>
<span>                                            <span class="va">Sex</span> <span class="op">+</span><span class="va">ECOG1</span> ,replace<span class="op">=</span><span class="cn">TRUE</span>, estimand<span class="op">=</span><span class="st">"ATT"</span>, </span>
<span>                                            data <span class="op">=</span> <span class="va">final.data</span>, method <span class="op">=</span> <span class="st">"genetic"</span>,  </span>
<span>                                            ratio <span class="op">=</span> <span class="fl">1</span>,pop.size<span class="op">=</span><span class="fl">200</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m.out.genetic.ratio1</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; matchit(formula = indicator ~ Age + Weight + Height + Biomarker1 + </span></span>
<span><span class="co">#&gt;     Biomarker2 + Smoker + Sex + ECOG1, data = final.data, method = "genetic", </span></span>
<span><span class="co">#&gt;     estimand = "ATT", replace = TRUE, ratio = 1, pop.size = 200)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for All Data:</span></span>
<span><span class="co">#&gt;            Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance          0.7827        0.2608          2.1517     0.8827    0.4123</span></span>
<span><span class="co">#&gt; Age              55.0001       56.9985         -0.5151     1.0883    0.1497</span></span>
<span><span class="co">#&gt; Weight          150.0006      147.9990          0.6306     1.0170    0.1673</span></span>
<span><span class="co">#&gt; Height           65.0010       62.9998          0.8104     1.2222    0.2232</span></span>
<span><span class="co">#&gt; Biomarker1       34.9998       36.9999         -0.8948     0.9984    0.2397</span></span>
<span><span class="co">#&gt; Biomarker2       50.0003       47.9994          0.8138     1.2180    0.2254</span></span>
<span><span class="co">#&gt; Smoker            0.1983        0.2900         -0.2299          .    0.0917</span></span>
<span><span class="co">#&gt; Sex               0.7933        0.7100          0.2058          .    0.0833</span></span>
<span><span class="co">#&gt; ECOG1             0.3050        0.3900         -0.1846          .    0.0850</span></span>
<span><span class="co">#&gt;            eCDF Max</span></span>
<span><span class="co">#&gt; distance     0.6657</span></span>
<span><span class="co">#&gt; Age          0.2277</span></span>
<span><span class="co">#&gt; Weight       0.2493</span></span>
<span><span class="co">#&gt; Height       0.3247</span></span>
<span><span class="co">#&gt; Biomarker1   0.3717</span></span>
<span><span class="co">#&gt; Biomarker2   0.3463</span></span>
<span><span class="co">#&gt; Smoker       0.0917</span></span>
<span><span class="co">#&gt; Sex          0.0833</span></span>
<span><span class="co">#&gt; ECOG1        0.0850</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for Matched Data:</span></span>
<span><span class="co">#&gt;            Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance          0.7827        0.7618          0.0860     1.0260    0.0379</span></span>
<span><span class="co">#&gt; Age              55.0001       55.1101         -0.0283     1.1784    0.0342</span></span>
<span><span class="co">#&gt; Weight          150.0006      149.3077          0.2183     1.2776    0.0561</span></span>
<span><span class="co">#&gt; Height           65.0010       64.9209          0.0324     1.1642    0.0145</span></span>
<span><span class="co">#&gt; Biomarker1       34.9998       35.3957         -0.1771     1.2578    0.0414</span></span>
<span><span class="co">#&gt; Biomarker2       50.0003       49.7966          0.0829     1.4752    0.0245</span></span>
<span><span class="co">#&gt; Smoker            0.1983        0.1933          0.0125          .    0.0050</span></span>
<span><span class="co">#&gt; Sex               0.7933        0.7933          0.0000          .    0.0000</span></span>
<span><span class="co">#&gt; ECOG1             0.3050        0.2483          0.1231          .    0.0567</span></span>
<span><span class="co">#&gt;            eCDF Max Std. Pair Dist.</span></span>
<span><span class="co">#&gt; distance     0.1950          0.1920</span></span>
<span><span class="co">#&gt; Age          0.0917          0.9201</span></span>
<span><span class="co">#&gt; Weight       0.1367          1.0483</span></span>
<span><span class="co">#&gt; Height       0.0683          0.1557</span></span>
<span><span class="co">#&gt; Biomarker1   0.1400          0.8230</span></span>
<span><span class="co">#&gt; Biomarker2   0.1150          0.6582</span></span>
<span><span class="co">#&gt; Smoker       0.0050          0.0125</span></span>
<span><span class="co">#&gt; Sex          0.0000          0.0000</span></span>
<span><span class="co">#&gt; ECOG1        0.0567          0.7747</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample Sizes:</span></span>
<span><span class="co">#&gt;               Control Treated</span></span>
<span><span class="co">#&gt; All            500.       600</span></span>
<span><span class="co">#&gt; Matched (ESS)   43.22     600</span></span>
<span><span class="co">#&gt; Matched        151.       600</span></span>
<span><span class="co">#&gt; Unmatched      349.         0</span></span>
<span><span class="co">#&gt; Discarded        0.         0</span></span></code></pre></div>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final.data</span><span class="op">$</span><span class="va">genetic_ratio1_weights</span> <span class="op">=</span> <span class="va">m.out.genetic.ratio1</span><span class="op">$</span><span class="va">weights</span></span></code></pre></div>
<p>We now compare the SMD between the two datasets.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span>id <span class="op">=</span> <span class="op">~</span><span class="fl">0</span>, data<span class="op">=</span><span class="va">final.data</span>,weights <span class="op">=</span> <span class="op">~</span><span class="va">genetic_ratio1_weights</span><span class="op">)</span></span>
<span><span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu">svyCreateTableOne</span><span class="op">(</span>vars <span class="op">=</span> <span class="va">myVars</span>, strata <span class="op">=</span> <span class="st">"data"</span> , data <span class="op">=</span> <span class="va">svy</span>, factorVars <span class="op">=</span> <span class="va">catVars</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">t1</span>,smd<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;                         Stratified by data</span></span>
<span><span class="co">#&gt;                          EC             TRIAL          p      test SMD   </span></span>
<span><span class="co">#&gt;   n                      151.00         600.00                           </span></span>
<span><span class="co">#&gt;   Age (mean (SD))         55.11 (3.54)   55.00 (3.88)   0.830       0.030</span></span>
<span><span class="co">#&gt;   Weight (mean (SD))     149.31 (2.78)  150.00 (3.17)   0.111       0.232</span></span>
<span><span class="co">#&gt;   Height (mean (SD))      64.92 (2.27)   65.00 (2.47)   0.815       0.034</span></span>
<span><span class="co">#&gt;   Biomarker1 (mean (SD))  35.40 (1.98)   35.00 (2.24)   0.122       0.188</span></span>
<span><span class="co">#&gt;   Biomarker2 (mean (SD))  49.80 (2.01)   50.00 (2.46)   0.506       0.091</span></span>
<span><span class="co">#&gt;   Smoker = 1 (%)           29.2 (19.3)   119.0 (19.8)   0.924       0.013</span></span>
<span><span class="co">#&gt;   Sex = 1 (%)             119.8 (79.3)   476.0 (79.3)   1.000      &lt;0.001</span></span>
<span><span class="co">#&gt;   ECOG1 = 1 (%)            37.5 (24.8)   183.0 (30.5)   0.346       0.127</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="gmw">GMW<a class="anchor" aria-label="anchor" href="#gmw"></a>
</h3>
<p>We now consider genetic matching without replacement.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m.out.genetic.ratio1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html" class="external-link">matchit</a></span><span class="op">(</span><span class="va">indicator</span> <span class="op">~</span> <span class="va">Age</span> <span class="op">+</span> <span class="va">Weight</span> <span class="op">+</span> <span class="va">Height</span> <span class="op">+</span> <span class="va">Biomarker1</span>  <span class="op">+</span> <span class="va">Biomarker2</span> <span class="op">+</span> <span class="va">Smoker</span> <span class="op">+</span></span>
<span>                                            <span class="va">Sex</span> <span class="op">+</span><span class="va">ECOG1</span> ,replace<span class="op">=</span><span class="cn">FALSE</span>, estimand<span class="op">=</span><span class="st">"ATT"</span>, </span>
<span>                                            data <span class="op">=</span> <span class="va">final.data</span>, method <span class="op">=</span> <span class="st">"genetic"</span>,  </span>
<span>                                            ratio <span class="op">=</span> <span class="fl">1</span>,pop.size<span class="op">=</span><span class="fl">200</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Fewer control units than treated units; not all treated units will get</span></span>
<span><span class="co">#&gt; a match.</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m.out.genetic.ratio1</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; matchit(formula = indicator ~ Age + Weight + Height + Biomarker1 + </span></span>
<span><span class="co">#&gt;     Biomarker2 + Smoker + Sex + ECOG1, data = final.data, method = "genetic", </span></span>
<span><span class="co">#&gt;     estimand = "ATT", replace = FALSE, ratio = 1, pop.size = 200)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for All Data:</span></span>
<span><span class="co">#&gt;            Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance          0.7827        0.2608          2.1517     0.8827    0.4123</span></span>
<span><span class="co">#&gt; Age              55.0001       56.9985         -0.5151     1.0883    0.1497</span></span>
<span><span class="co">#&gt; Weight          150.0006      147.9990          0.6306     1.0170    0.1673</span></span>
<span><span class="co">#&gt; Height           65.0010       62.9998          0.8104     1.2222    0.2232</span></span>
<span><span class="co">#&gt; Biomarker1       34.9998       36.9999         -0.8948     0.9984    0.2397</span></span>
<span><span class="co">#&gt; Biomarker2       50.0003       47.9994          0.8138     1.2180    0.2254</span></span>
<span><span class="co">#&gt; Smoker            0.1983        0.2900         -0.2299          .    0.0917</span></span>
<span><span class="co">#&gt; Sex               0.7933        0.7100          0.2058          .    0.0833</span></span>
<span><span class="co">#&gt; ECOG1             0.3050        0.3900         -0.1846          .    0.0850</span></span>
<span><span class="co">#&gt;            eCDF Max</span></span>
<span><span class="co">#&gt; distance     0.6657</span></span>
<span><span class="co">#&gt; Age          0.2277</span></span>
<span><span class="co">#&gt; Weight       0.2493</span></span>
<span><span class="co">#&gt; Height       0.3247</span></span>
<span><span class="co">#&gt; Biomarker1   0.3717</span></span>
<span><span class="co">#&gt; Biomarker2   0.3463</span></span>
<span><span class="co">#&gt; Smoker       0.0917</span></span>
<span><span class="co">#&gt; Sex          0.0833</span></span>
<span><span class="co">#&gt; ECOG1        0.0850</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for Matched Data:</span></span>
<span><span class="co">#&gt;            Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance          0.8753        0.2608          2.5336     0.2211    0.4823</span></span>
<span><span class="co">#&gt; Age              54.7088       56.9985         -0.5902     1.0304    0.1701</span></span>
<span><span class="co">#&gt; Weight          150.3086      147.9990          0.7276     0.9875    0.1960</span></span>
<span><span class="co">#&gt; Height           65.3230       62.9998          0.9408     1.2096    0.2597</span></span>
<span><span class="co">#&gt; Biomarker1       34.6396       36.9999         -1.0560     0.8539    0.2828</span></span>
<span><span class="co">#&gt; Biomarker2       50.2868       47.9994          0.9304     1.1739    0.2579</span></span>
<span><span class="co">#&gt; Smoker            0.1880        0.2900         -0.2558          .    0.1020</span></span>
<span><span class="co">#&gt; Sex               0.8060        0.7100          0.2371          .    0.0960</span></span>
<span><span class="co">#&gt; ECOG1             0.2920        0.3900         -0.2129          .    0.0980</span></span>
<span><span class="co">#&gt;            eCDF Max Std. Pair Dist.</span></span>
<span><span class="co">#&gt; distance      0.832          2.5336</span></span>
<span><span class="co">#&gt; Age           0.260          0.7405</span></span>
<span><span class="co">#&gt; Weight        0.292          0.7796</span></span>
<span><span class="co">#&gt; Height        0.382          0.9666</span></span>
<span><span class="co">#&gt; Biomarker1    0.434          1.0763</span></span>
<span><span class="co">#&gt; Biomarker2    0.398          0.9554</span></span>
<span><span class="co">#&gt; Smoker        0.102          0.6169</span></span>
<span><span class="co">#&gt; Sex           0.096          0.5433</span></span>
<span><span class="co">#&gt; ECOG1         0.098          0.4822</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample Sizes:</span></span>
<span><span class="co">#&gt;           Control Treated</span></span>
<span><span class="co">#&gt; All           500     600</span></span>
<span><span class="co">#&gt; Matched       500     500</span></span>
<span><span class="co">#&gt; Unmatched       0     100</span></span>
<span><span class="co">#&gt; Discarded       0       0</span></span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final.data</span><span class="op">$</span><span class="va">genetic_ratio1_weights_no_replace</span> <span class="op">=</span> <span class="va">m.out.genetic.ratio1</span><span class="op">$</span><span class="va">weights</span></span></code></pre></div>
<p>We now compare the SMD between the two datasets.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span>id <span class="op">=</span> <span class="op">~</span><span class="fl">0</span>, data<span class="op">=</span><span class="va">final.data</span>,weights <span class="op">=</span> <span class="op">~</span><span class="va">genetic_ratio1_weights_no_replace</span><span class="op">)</span></span>
<span><span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu">svyCreateTableOne</span><span class="op">(</span>vars <span class="op">=</span> <span class="va">myVars</span>, strata <span class="op">=</span> <span class="st">"data"</span> , data <span class="op">=</span> <span class="va">svy</span>, factorVars <span class="op">=</span> <span class="va">catVars</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">t1</span>,smd<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;                         Stratified by data</span></span>
<span><span class="co">#&gt;                          EC             TRIAL          p      test SMD   </span></span>
<span><span class="co">#&gt;   n                      500.00         500.00                           </span></span>
<span><span class="co">#&gt;   Age (mean (SD))         57.00 (3.72)   54.71 (3.78)  &lt;0.001       0.611</span></span>
<span><span class="co">#&gt;   Weight (mean (SD))     148.00 (3.15)  150.31 (3.13)  &lt;0.001       0.736</span></span>
<span><span class="co">#&gt;   Height (mean (SD))      63.00 (2.23)   65.32 (2.46)  &lt;0.001       0.989</span></span>
<span><span class="co">#&gt;   Biomarker1 (mean (SD))  37.00 (2.24)   34.64 (2.07)  &lt;0.001       1.096</span></span>
<span><span class="co">#&gt;   Biomarker2 (mean (SD))  48.00 (2.23)   50.29 (2.41)  &lt;0.001       0.985</span></span>
<span><span class="co">#&gt;   Smoker = 1 (%)          145.0 (29.0)    94.0 (18.8)  &lt;0.001       0.241</span></span>
<span><span class="co">#&gt;   Sex = 1 (%)             355.0 (71.0)   403.0 (80.6)  &lt;0.001       0.226</span></span>
<span><span class="co">#&gt;   ECOG1 = 1 (%)           195.0 (39.0)   146.0 (29.2)   0.001       0.208</span></span></code></pre></div>
<!-- We will also check the standardized mean difference after including all the treated patients from trial data and only matched patients from external control along with all control patients from trial. -->
<!-- ```{r message=FALSE} -->
<!-- final.data$genetic_ratio1_weights_star = m.out.genetic.ratio1$weights -->
<!-- final.data$genetic_ratio1_weights_star[final.data$data=="TRIAL"] = 1 -->
<!-- ``` -->
<!-- ```{r message=FALSE} -->
<!-- svy <- svydesign(id = ~0, data=final.data,weights = ~genetic_ratio1_weights_star) -->
<!-- t1 <- svyCreateTableOne(vars = myVars, strata = "group" , data = svy, factorVars = catVars) -->
<!-- ``` -->
<!-- ```{r message=FALSE} -->
<!-- print(t1,smd=TRUE) -->
<!-- ``` -->
</div>
<div class="section level3">
<h3 id="om">OM<a class="anchor" aria-label="anchor" href="#om"></a>
</h3>
<p>The optimal matching algorithm performs a global minimization of
propensity score distance between the RCT subjects and matched external
controls <span class="citation">(Harris and Horst 2016)</span>. The
criterion used is the sum of the absolute pair distances in the matched
sample. Optimal pair matching and nearest neighbor matching often yield
the same or very similar matched samples and some research has indicated
that optimal pair matching is not much better than nearest neighbor
matching at yielding balanced matched samples <span class="citation">(Greifer 2020)</span>.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m.out.optimal.ratio1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html" class="external-link">matchit</a></span><span class="op">(</span><span class="va">indicator</span> <span class="op">~</span> <span class="va">Age</span> <span class="op">+</span> <span class="va">Weight</span> <span class="op">+</span> <span class="va">Height</span> <span class="op">+</span> <span class="va">Biomarker1</span>  <span class="op">+</span> <span class="va">Biomarker2</span> <span class="op">+</span> <span class="va">Smoker</span> <span class="op">+</span></span>
<span>                                            <span class="va">Sex</span> <span class="op">+</span><span class="va">ECOG1</span> , estimand<span class="op">=</span><span class="st">"ATT"</span>, </span>
<span>                                            data <span class="op">=</span> <span class="va">final.data</span>, method <span class="op">=</span> <span class="st">"optimal"</span>,  </span>
<span>                                            ratio <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Fewer control units than treated units; not all treated units will get</span></span>
<span><span class="co">#&gt; a match.</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m.out.optimal.ratio1</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; matchit(formula = indicator ~ Age + Weight + Height + Biomarker1 + </span></span>
<span><span class="co">#&gt;     Biomarker2 + Smoker + Sex + ECOG1, data = final.data, method = "optimal", </span></span>
<span><span class="co">#&gt;     estimand = "ATT", ratio = 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for All Data:</span></span>
<span><span class="co">#&gt;            Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance          0.7827        0.2608          2.1517     0.8827    0.4123</span></span>
<span><span class="co">#&gt; Age              55.0001       56.9985         -0.5151     1.0883    0.1497</span></span>
<span><span class="co">#&gt; Weight          150.0006      147.9990          0.6306     1.0170    0.1673</span></span>
<span><span class="co">#&gt; Height           65.0010       62.9998          0.8104     1.2222    0.2232</span></span>
<span><span class="co">#&gt; Biomarker1       34.9998       36.9999         -0.8948     0.9984    0.2397</span></span>
<span><span class="co">#&gt; Biomarker2       50.0003       47.9994          0.8138     1.2180    0.2254</span></span>
<span><span class="co">#&gt; Smoker            0.1983        0.2900         -0.2299          .    0.0917</span></span>
<span><span class="co">#&gt; Sex               0.7933        0.7100          0.2058          .    0.0833</span></span>
<span><span class="co">#&gt; ECOG1             0.3050        0.3900         -0.1846          .    0.0850</span></span>
<span><span class="co">#&gt;            eCDF Max</span></span>
<span><span class="co">#&gt; distance     0.6657</span></span>
<span><span class="co">#&gt; Age          0.2277</span></span>
<span><span class="co">#&gt; Weight       0.2493</span></span>
<span><span class="co">#&gt; Height       0.3247</span></span>
<span><span class="co">#&gt; Biomarker1   0.3717</span></span>
<span><span class="co">#&gt; Biomarker2   0.3463</span></span>
<span><span class="co">#&gt; Smoker       0.0917</span></span>
<span><span class="co">#&gt; Sex          0.0833</span></span>
<span><span class="co">#&gt; ECOG1        0.0850</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for Matched Data:</span></span>
<span><span class="co">#&gt;            Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance          0.7410        0.2608          1.9801     0.9032    0.3589</span></span>
<span><span class="co">#&gt; Age              55.3043       56.9985         -0.4367     1.1079    0.1263</span></span>
<span><span class="co">#&gt; Weight          149.7031      147.9990          0.5369     0.9493    0.1424</span></span>
<span><span class="co">#&gt; Height           64.6469       62.9998          0.6670     1.0524    0.1886</span></span>
<span><span class="co">#&gt; Biomarker1       35.2375       36.9999         -0.7885     0.9722    0.2114</span></span>
<span><span class="co">#&gt; Biomarker2       49.5934       47.9994          0.6483     1.0178    0.1862</span></span>
<span><span class="co">#&gt; Smoker            0.2020        0.2900         -0.2207          .    0.0880</span></span>
<span><span class="co">#&gt; Sex               0.7760        0.7100          0.1630          .    0.0660</span></span>
<span><span class="co">#&gt; ECOG1             0.3360        0.3900         -0.1173          .    0.0540</span></span>
<span><span class="co">#&gt;            eCDF Max Std. Pair Dist.</span></span>
<span><span class="co">#&gt; distance      0.632          1.9801</span></span>
<span><span class="co">#&gt; Age           0.192          1.0969</span></span>
<span><span class="co">#&gt; Weight        0.220          1.1664</span></span>
<span><span class="co">#&gt; Height        0.286          1.1544</span></span>
<span><span class="co">#&gt; Biomarker1    0.342          1.2647</span></span>
<span><span class="co">#&gt; Biomarker2    0.296          1.1523</span></span>
<span><span class="co">#&gt; Smoker        0.088          0.9129</span></span>
<span><span class="co">#&gt; Sex           0.066          0.8940</span></span>
<span><span class="co">#&gt; ECOG1         0.054          1.1077</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample Sizes:</span></span>
<span><span class="co">#&gt;           Control Treated</span></span>
<span><span class="co">#&gt; All           500     600</span></span>
<span><span class="co">#&gt; Matched       500     500</span></span>
<span><span class="co">#&gt; Unmatched       0     100</span></span>
<span><span class="co">#&gt; Discarded       0       0</span></span></code></pre></div>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final.data</span><span class="op">$</span><span class="va">optimal_ratio1_weights</span> <span class="op">=</span> <span class="va">m.out.optimal.ratio1</span><span class="op">$</span><span class="va">weights</span></span></code></pre></div>
<p>We now compare the SMD between the two datasets.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span>id <span class="op">=</span> <span class="op">~</span><span class="fl">0</span>, data<span class="op">=</span><span class="va">final.data</span>,weights <span class="op">=</span> <span class="op">~</span><span class="va">optimal_ratio1_weights</span><span class="op">)</span></span>
<span><span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu">svyCreateTableOne</span><span class="op">(</span>vars <span class="op">=</span> <span class="va">myVars</span>, strata <span class="op">=</span> <span class="st">"data"</span> , data <span class="op">=</span> <span class="va">svy</span>, factorVars <span class="op">=</span> <span class="va">catVars</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">t1</span>,smd<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;                         Stratified by data</span></span>
<span><span class="co">#&gt;                          EC             TRIAL          p      test SMD   </span></span>
<span><span class="co">#&gt;   n                      500.00         500.00                           </span></span>
<span><span class="co">#&gt;   Age (mean (SD))         57.00 (3.72)   55.30 (3.91)  &lt;0.001       0.444</span></span>
<span><span class="co">#&gt;   Weight (mean (SD))     148.00 (3.15)  149.70 (3.07)  &lt;0.001       0.548</span></span>
<span><span class="co">#&gt;   Height (mean (SD))      63.00 (2.23)   64.65 (2.29)  &lt;0.001       0.728</span></span>
<span><span class="co">#&gt;   Biomarker1 (mean (SD))  37.00 (2.24)   35.24 (2.21)  &lt;0.001       0.793</span></span>
<span><span class="co">#&gt;   Biomarker2 (mean (SD))  48.00 (2.23)   49.59 (2.25)  &lt;0.001       0.712</span></span>
<span><span class="co">#&gt;   Smoker = 1 (%)          145.0 (29.0)   101.0 (20.2)   0.001       0.205</span></span>
<span><span class="co">#&gt;   Sex = 1 (%)             355.0 (71.0)   388.0 (77.6)   0.017       0.151</span></span>
<span><span class="co">#&gt;   ECOG1 = 1 (%)           195.0 (39.0)   168.0 (33.6)   0.076       0.112</span></span></code></pre></div>
<!-- We will also check the standardized mean difference after including all the treated patients from trial data and only matched patients from external control along with all control patients from trial. -->
<!-- ```{r message=FALSE} -->
<!-- ##MS this is not outputting the SMDs -->
<!-- final.data$optimal_ratio1_weights_star = m.out.optimal.ratio1$weights -->
<!-- final.data$optimal_ratio1_weights_star[final.data$data=="TRIAL"] = 1 -->
<!-- ``` -->
</div>
</div>
<div class="section level2">
<h2 id="weighting-methods">Weighting Methods<a class="anchor" aria-label="anchor" href="#weighting-methods"></a>
</h2>
<p>We also explore several weighting approaches.</p>
<ul>
<li>Weighting methods
<ul>
<li>Propensity score weighting based on a gradient boosted model
(GBM)</li>
<li>Entropy balancing weighting (EB)</li>
<li>Inverse probability of treatment weighting (IPW)</li>
</ul>
</li>
</ul>
<div class="section level3">
<h3 id="gbm">GBM<a class="anchor" aria-label="anchor" href="#gbm"></a>
</h3>
<p>The GBM (Gradient Boosting Machine) is a machine learning method
which generates predicted values from a flexible regression model. It
can adjust for a large number of covariates. The estimation involves an
iterative process with multiple regression trees to capture complex and
non-linear relationships. One of the most useful features of GBM for
estimating the propensity score is that its iterative estimation
procedure can be tuned to find the propensity score model leading to the
best balance between treated and control groups, where balance refers to
the similarity between different groups on their propensity score
weighted distributions of pretreatment covariates <span class="citation">(McCaffrey et al. 2013)</span>.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Toolkit for Weighting and Analysis of Nonequivalent Groups</span></span>
<span><span class="co"># https://cran.r-project.org/web/packages/twang/vignettes/twang.pdf</span></span>
<span></span>
<span><span class="co"># Model includes non-linear effects and interactions with shrinkage to </span></span>
<span><span class="co"># avoid overfitting</span></span>
<span>                                                      </span>
<span><span class="va">ps.AOD.ATT</span> <span class="op">&lt;-</span> <span class="fu">ps</span><span class="op">(</span><span class="va">indicator</span> <span class="op">~</span> <span class="va">Age</span> <span class="op">+</span> <span class="va">Weight</span> <span class="op">+</span> <span class="va">Height</span> <span class="op">+</span> <span class="va">Biomarker1</span>  <span class="op">+</span> <span class="va">Biomarker2</span> <span class="op">+</span> <span class="va">Smoker</span> <span class="op">+</span></span>
<span>                             <span class="va">Sex</span> <span class="op">+</span><span class="va">ECOG1</span>, data <span class="op">=</span> <span class="va">final.data</span>,</span>
<span>                             estimand <span class="op">=</span> <span class="st">"ATT"</span>, interaction.depth<span class="op">=</span><span class="fl">3</span>, </span>
<span>                             shrinkage<span class="op">=</span><span class="fl">0.01</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span>, n.trees <span class="op">=</span> <span class="fl">7000</span>, </span>
<span>                             stop.method <span class="op">=</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="st">"es.mean"</span>,<span class="st">"ks.max"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># interaction.dept is the tree depth used in gradient boosting; loosely interpreted as </span></span>
<span><span class="co"># the maximum number of variables that can be included in an interaction</span></span>
<span></span>
<span><span class="co"># n.trees is the maximum number of gradient boosting iterations to be considered. The</span></span>
<span><span class="co"># more iterations allows for more nonlienarity and interactions to be considered.</span></span>
<span></span>
<span><span class="co"># shrinkage is a numeric value between 0 and 1 denoting the learning rate. Smaller </span></span>
<span><span class="co"># values restrict the complexity that is added at each iteration of the gradient </span></span>
<span><span class="co"># boosting algorithm. A smaller learning rate requires more iterations (n.trees), but </span></span>
<span><span class="co"># adds some protection against model overfit. The default value is 0.01.</span></span>
<span></span>
<span><span class="co"># windows()</span></span>
<span><span class="co"># plot(ps.AOD.ATT, plot=5)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># summary(ps.AOD.ATT)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># # Relative influence</span></span>
<span><span class="co"># summary(ps.AOD.ATT$gbm.obj, n.trees=ps.AOD.ATT$desc$ks.max.ATT$n.trees, plot=FALSE)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># bal.table(ps.AOD.ATT)</span></span>
<span></span>
<span><span class="va">final.data</span><span class="op">$</span><span class="va">weights_gbm</span> <span class="op">&lt;-</span> <span class="va">ps.AOD.ATT</span><span class="op">$</span><span class="va">w</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<p>We now compare the SMD between the two datasets.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span>id <span class="op">=</span> <span class="op">~</span><span class="fl">0</span>, data<span class="op">=</span><span class="va">final.data</span>,weights <span class="op">=</span> <span class="op">~</span><span class="va">weights_gbm</span><span class="op">)</span></span>
<span><span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu">svyCreateTableOne</span><span class="op">(</span>vars <span class="op">=</span> <span class="va">myVars</span>, strata <span class="op">=</span> <span class="st">"data"</span> , data <span class="op">=</span> <span class="va">svy</span>, factorVars <span class="op">=</span> <span class="va">catVars</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">t1</span>,smd<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;                         Stratified by data</span></span>
<span><span class="co">#&gt;                          EC             TRIAL          p      test SMD   </span></span>
<span><span class="co">#&gt;   n                      284.19         600.00                           </span></span>
<span><span class="co">#&gt;   Age (mean (SD))         54.93 (4.03)   55.00 (3.88)   0.902       0.018</span></span>
<span><span class="co">#&gt;   Weight (mean (SD))     148.84 (2.69)  150.00 (3.17)  &lt;0.001       0.394</span></span>
<span><span class="co">#&gt;   Height (mean (SD))      64.27 (2.11)   65.00 (2.47)   0.002       0.317</span></span>
<span><span class="co">#&gt;   Biomarker1 (mean (SD))  35.61 (2.01)   35.00 (2.24)   0.002       0.285</span></span>
<span><span class="co">#&gt;   Biomarker2 (mean (SD))  49.57 (2.11)   50.00 (2.46)   0.081       0.188</span></span>
<span><span class="co">#&gt;   Smoker = 1 (%)           70.0 (24.6)   119.0 (19.8)   0.338       0.116</span></span>
<span><span class="co">#&gt;   Sex = 1 (%)             222.6 (78.3)   476.0 (79.3)   0.816       0.025</span></span>
<span><span class="co">#&gt;   ECOG1 = 1 (%)            85.7 (30.2)   183.0 (30.5)   0.950       0.007</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="eb">EB<a class="anchor" aria-label="anchor" href="#eb"></a>
</h3>
<p>Entropy balancing is a weighting method to balance the covariates by
assigning a scalar weight to each external control observations such
that the reweighted groups satisfy a set of balance constraints that are
imposed on the sample moments of the covariate distributions <span class="citation">(Hainmueller 2012)</span>.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eb.out</span> <span class="op">&lt;-</span> <span class="fu">ebalance</span><span class="op">(</span><span class="va">final.data</span><span class="op">$</span><span class="va">indicator</span>,<span class="va">final.data</span><span class="op">[</span>,<span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span><span class="op">]</span>,max.iterations <span class="op">=</span> <span class="fl">300</span><span class="op">)</span></span>
<span><span class="co">#&gt; Converged within tolerance</span></span>
<span><span class="va">final.data</span><span class="op">$</span><span class="va">eb_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">final.data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">final.data</span><span class="op">$</span><span class="va">eb_weights</span><span class="op">[</span><span class="va">final.data</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">eb.out</span><span class="op">$</span><span class="va">w</span></span></code></pre></div>
<p>Note that the entropy balancing method failed to converge.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eb.out</span><span class="op">$</span><span class="va">converged</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>We now compare the SMD between the two datasets. By definition, the
SMD after EB should be zero.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span>id <span class="op">=</span> <span class="op">~</span><span class="fl">0</span>, data<span class="op">=</span><span class="va">final.data</span>,weights <span class="op">=</span> <span class="op">~</span><span class="va">eb_weights</span><span class="op">)</span></span>
<span><span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu">svyCreateTableOne</span><span class="op">(</span>vars <span class="op">=</span> <span class="va">myVars</span>, strata <span class="op">=</span> <span class="st">"data"</span> , data <span class="op">=</span> <span class="va">svy</span>, factorVars <span class="op">=</span> <span class="va">catVars</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">t1</span>,smd<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;                         Stratified by data</span></span>
<span><span class="co">#&gt;                          EC             TRIAL          p      test SMD   </span></span>
<span><span class="co">#&gt;   n                      600.00         600.00                           </span></span>
<span><span class="co">#&gt;   Age (mean (SD))         55.00 (3.68)   55.00 (3.88)   1.000      &lt;0.001</span></span>
<span><span class="co">#&gt;   Weight (mean (SD))     150.00 (2.82)  150.00 (3.17)   1.000      &lt;0.001</span></span>
<span><span class="co">#&gt;   Height (mean (SD))      65.00 (2.15)   65.00 (2.47)   1.000      &lt;0.001</span></span>
<span><span class="co">#&gt;   Biomarker1 (mean (SD))  35.00 (1.49)   35.00 (2.24)   1.000      &lt;0.001</span></span>
<span><span class="co">#&gt;   Biomarker2 (mean (SD))  50.00 (1.91)   50.00 (2.46)   1.000      &lt;0.001</span></span>
<span><span class="co">#&gt;   Smoker = 1 (%)          119.0 (19.8)   119.0 (19.8)   1.000      &lt;0.001</span></span>
<span><span class="co">#&gt;   Sex = 1 (%)             476.0 (79.3)   476.0 (79.3)   1.000      &lt;0.001</span></span>
<span><span class="co">#&gt;   ECOG1 = 1 (%)           183.0 (30.5)   183.0 (30.5)   1.000      &lt;0.001</span></span></code></pre></div>
<!-- We will also check the standardized mean difference after including all the treated patients from trial data and only matched patients from external control along with all control patients from trial. -->
<!-- ```{r message=FALSE} -->
<!-- final.data$eb_weights_star = final.data$eb_weights -->
<!-- final.data$eb_weights_star[final.data$data=="TRIAL"] = 1 -->
<!-- ``` -->
</div>
<div class="section level3">
<h3 id="ipw">IPW<a class="anchor" aria-label="anchor" href="#ipw"></a>
</h3>
<p>The propensity score is defined as the probability of a patient being
in a trial given the observed baseline covariates. We utilized the ATT
weights, which are defined for the IPW as fixing the trial patients
weight at unity, and external control patients as <span class="math inline">\(\hat{e}(x)/(1-\hat{e}(x))\)</span> where <span class="math inline">\(\hat{e}(x)\)</span> is estimated using a logistic
regression model <span class="citation">(Amusa, Zewotir, and North
2019)</span>.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ps.logit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">indicator</span> <span class="op">~</span> <span class="va">Age</span> <span class="op">+</span> <span class="va">Weight</span> <span class="op">+</span> <span class="va">Height</span> <span class="op">+</span> <span class="va">Biomarker1</span>  <span class="op">+</span> <span class="va">Biomarker2</span> <span class="op">+</span> <span class="va">Smoker</span> <span class="op">+</span></span>
<span>                            <span class="va">Sex</span> <span class="op">+</span><span class="va">ECOG1</span>, data <span class="op">=</span> <span class="va">final.data</span>,</span>
<span>                            family<span class="op">=</span><span class="va">binomial</span><span class="op">)</span></span>
<span><span class="va">psfit</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">ps.logit</span>,type <span class="op">=</span> <span class="st">"response"</span>,data<span class="op">=</span><span class="va">final.data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ps_trial</span> <span class="op">&lt;-</span> <span class="va">psfit</span><span class="op">[</span><span class="va">final.data</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span> </span>
<span><span class="va">ps_extcont</span> <span class="op">&lt;-</span> <span class="va">psfit</span><span class="op">[</span><span class="va">final.data</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span></span>
<span></span>
<span><span class="va">final.data</span><span class="op">$</span><span class="va">invprob_weights</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">final.data</span><span class="op">$</span><span class="va">invprob_weights</span><span class="op">[</span><span class="va">final.data</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">ps_extcont</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">ps_extcont</span><span class="op">)</span></span>
<span><span class="va">final.data</span><span class="op">$</span><span class="va">invprob_weights</span><span class="op">[</span><span class="va">final.data</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">ps_trial</span><span class="op">/</span><span class="va">ps_trial</span></span></code></pre></div>
<p>We now compare the SMD between the two datasets.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span>id <span class="op">=</span> <span class="op">~</span><span class="fl">0</span>, data<span class="op">=</span><span class="va">final.data</span>,weights <span class="op">=</span> <span class="op">~</span><span class="va">invprob_weights</span><span class="op">)</span></span>
<span><span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu">svyCreateTableOne</span><span class="op">(</span>vars <span class="op">=</span> <span class="va">myVars</span>, strata <span class="op">=</span> <span class="st">"data"</span> , data <span class="op">=</span> <span class="va">svy</span>, factorVars <span class="op">=</span> <span class="va">catVars</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">t1</span>,smd<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;                         Stratified by data</span></span>
<span><span class="co">#&gt;                          EC             TRIAL          p      test SMD   </span></span>
<span><span class="co">#&gt;   n                      522.38         600.00                           </span></span>
<span><span class="co">#&gt;   Age (mean (SD))         54.44 (4.03)   55.00 (3.88)   0.458       0.141</span></span>
<span><span class="co">#&gt;   Weight (mean (SD))     148.92 (2.76)  150.00 (3.17)   0.002       0.364</span></span>
<span><span class="co">#&gt;   Height (mean (SD))      64.65 (2.26)   65.00 (2.47)   0.311       0.147</span></span>
<span><span class="co">#&gt;   Biomarker1 (mean (SD))  35.38 (1.80)   35.00 (2.24)   0.077       0.185</span></span>
<span><span class="co">#&gt;   Biomarker2 (mean (SD))  49.83 (2.11)   50.00 (2.46)   0.589       0.076</span></span>
<span><span class="co">#&gt;   Smoker = 1 (%)           90.5 (17.3)   119.0 (19.8)   0.568       0.064</span></span>
<span><span class="co">#&gt;   Sex = 1 (%)             419.5 (80.3)   476.0 (79.3)   0.849       0.024</span></span>
<span><span class="co">#&gt;   ECOG1 = 1 (%)           121.3 (23.2)   183.0 (30.5)   0.158       0.165</span></span></code></pre></div>
<!-- We will also check the standardized mean difference after including all the treated patients from trial data and only matched patients from external control along with all control patients from trial. -->
<!-- ```{r message=FALSE} -->
<!-- final.data$invprob_weights_star = final.data$invprob_weights -->
<!-- final.data$invprob_weights_star[final.data$data=="TRIAL"] = 1 -->
<!-- ``` -->
<p>Next we will investigate balance plots.</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">covs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">final.data</span><span class="op">[</span>,<span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="st">"Age"</span>,<span class="st">"Weight"</span>,<span class="st">"Height"</span>,<span class="st">"Biomarker1"</span>,<span class="st">"Biomarker2"</span>,<span class="st">"Smoker"</span>,<span class="st">"Sex"</span>,<span class="st">"ECOG1"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">data_with_weights</span> <span class="op">&lt;-</span> <span class="va">final.data</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="balance-plots-for-matching-methods">Balance Plots for Matching Methods<a class="anchor" aria-label="anchor" href="#balance-plots-for-matching-methods"></a>
</h2>
<p>We now conduct a balance diagnostic by considering SMD plot. The
x-axis of the plot represent the absolute value of the SMD and y-axis
represent the list of all covariates. SMD greater than <span class="math inline">\(0.1\)</span> can be considered a sign of imbalance
<span class="citation">(Zhang et al. 2019)</span>. Hence, we put a
threshold of <span class="math inline">\(0.1\)</span> in the plot with a
vertical dashed line.</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/love.plot.html" class="external-link">love.plot</a></span><span class="op">(</span><span class="va">covs</span>, </span>
<span>          treat<span class="op">=</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">data</span>,</span>
<span>          weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>NNMPS<span class="op">=</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">ratio1_caliper_weights</span>,</span>
<span>                         NNMLPS<span class="op">=</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">ratio1_caliper_weights_lps</span>,</span>
<span>                         OPTM<span class="op">=</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">optimal_ratio1_weights</span>,</span>
<span>                         GENMATCH<span class="op">=</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">genetic_ratio1_weights</span>,</span>
<span>                         GENMATCHW<span class="op">=</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">genetic_ratio1_weights_no_replace</span><span class="op">)</span>,</span>
<span>          thresholds<span class="op">=</span><span class="fl">0.1</span> ,binary<span class="op">=</span><span class="st">"std"</span>,shapes <span class="op">=</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="st">"circle filled"</span><span class="op">)</span>,</span>
<span>          line<span class="op">=</span><span class="cn">FALSE</span>,estimand<span class="op">=</span><span class="st">"ATT"</span>,abs<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>          sample.names <span class="op">=</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="st">"PSMR"</span>, </span>
<span>                           <span class="st">"PSML"</span>, </span>
<span>                           <span class="st">"OM"</span>,</span>
<span>                           <span class="st">"GM"</span>,</span>
<span>                           <span class="st">"GMW"</span><span class="op">)</span>,</span>
<span>          title<span class="op">=</span><span class="st">"Covariate Balance after matching methods"</span>,</span>
<span>          s.d.denom<span class="op">=</span><span class="st">"pooled"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="figure-match_weight_01_methods-unnamed-chunk-61-1.png" alt="plot of chunk unnamed-chunk-61"><p class="caption">
plot of chunk unnamed-chunk-61
</p>
</div>
</div>
<div class="section level2">
<h2 id="balance-plots-for-weighting-methods">Balance Plots for Weighting Methods<a class="anchor" aria-label="anchor" href="#balance-plots-for-weighting-methods"></a>
</h2>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/love.plot.html" class="external-link">love.plot</a></span><span class="op">(</span><span class="va">covs</span>, </span>
<span>          treat<span class="op">=</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">data</span>,</span>
<span>          weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>EB<span class="op">=</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">eb_weights</span>,</span>
<span>                         IPW<span class="op">=</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">invprob_weights</span>,</span>
<span>                         GBM<span class="op">=</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">weights_gbm</span><span class="op">)</span>,</span>
<span>          thresholds<span class="op">=</span><span class="fl">0.1</span> ,binary<span class="op">=</span><span class="st">"std"</span>,shapes <span class="op">=</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="st">"circle filled"</span><span class="op">)</span>,</span>
<span>          line<span class="op">=</span><span class="cn">FALSE</span>,estimand<span class="op">=</span><span class="st">"ATT"</span>,abs<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>          sample.names <span class="op">=</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="st">"EB"</span>, </span>
<span>                           <span class="st">"IPW"</span>, </span>
<span>                           <span class="st">"GBM"</span><span class="op">)</span>,</span>
<span>          title<span class="op">=</span><span class="st">"Covariate Balance after weighting methods"</span>,</span>
<span>          s.d.denom<span class="op">=</span><span class="st">"pooled"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="figure-match_weight_01_methods-unnamed-chunk-62-1.png" alt="plot of chunk unnamed-chunk-62"><p class="caption">
plot of chunk unnamed-chunk-62
</p>
</div>
<p>We now investigate the effective sample size (ESS) in the trial and
external control cohort.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#External control</span></span>
<span><span class="va">ess.PSML.extcont</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">ratio1_caliper_weights_lps</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">ratio1_caliper_weights_lps</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ess.PSMR.extcont</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">ratio1_caliper_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">ratio1_caliper_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ess.OM.extcont</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">optimal_ratio1_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">optimal_ratio1_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ess.GM.extcont</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">genetic_ratio1_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">genetic_ratio1_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ess.eb.extcont</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">eb_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">eb_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ess.ipw.extcont</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">invprob_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">invprob_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ess.gbm.extcont</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">weights_gbm</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">weights_gbm</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ess.genetic.extcont</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">genetic_ratio1_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">genetic_ratio1_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ess.genetic.no.replace.extcont</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">genetic_ratio1_weights_no_replace</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">genetic_ratio1_weights_no_replace</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Trial</span></span>
<span><span class="va">ess.PSML.trial</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">ratio1_caliper_weights_lps</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">ratio1_caliper_weights_lps</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ess.PSMR.trial</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">ratio1_caliper_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">ratio1_caliper_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ess.OM.trial</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">optimal_ratio1_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">optimal_ratio1_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ess.GM.trial</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">genetic_ratio1_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">genetic_ratio1_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ess.eb.trial</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">eb_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">eb_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ess.ipw.trial</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">invprob_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">invprob_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ess.gbm.trial</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">weights_gbm</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">weights_gbm</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ess.genetic.trial</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">genetic_ratio1_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">genetic_ratio1_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">ess.genetic.no.replace.trial</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">genetic_ratio1_weights_no_replace</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">genetic_ratio1_weights_no_replace</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out.ess</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Unadjusted<span class="op">=</span><span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">final.data</span><span class="op">$</span><span class="va">data</span><span class="op">==</span><span class="st">"TRIAL"</span><span class="op">)</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">final.data</span><span class="op">$</span><span class="va">data</span><span class="op">==</span><span class="st">"EC"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           PSML<span class="op">=</span><span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="va">ess.PSML.trial</span>,<span class="va">ess.PSML.extcont</span><span class="op">)</span>,</span>
<span>           PSMR<span class="op">=</span><span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="va">ess.PSMR.trial</span>,<span class="va">ess.PSMR.extcont</span><span class="op">)</span>,</span>
<span>           OM<span class="op">=</span><span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="va">ess.OM.trial</span>,<span class="va">ess.OM.extcont</span><span class="op">)</span>,</span>
<span>           GM<span class="op">=</span><span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="va">ess.genetic.trial</span>,<span class="va">ess.genetic.extcont</span><span class="op">)</span>,</span>
<span>           GMW<span class="op">=</span><span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="va">ess.genetic.no.replace.trial</span>,<span class="va">ess.genetic.no.replace.extcont</span><span class="op">)</span>,</span>
<span>           EB<span class="op">=</span><span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="va">ess.eb.trial</span>,<span class="va">ess.eb.extcont</span><span class="op">)</span>,</span>
<span>           IPW<span class="op">=</span><span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="va">ess.ipw.trial</span>,<span class="va">ess.ipw.extcont</span><span class="op">)</span>,</span>
<span>           GBM<span class="op">=</span><span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="va">ess.gbm.trial</span>,<span class="va">ess.gbm.extcont</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">out.ess</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="st">"Trial"</span>,<span class="st">"External Control"</span><span class="op">)</span></span></code></pre></div>
<p>Note: After applying the matching methods, some patients in RCT were
excluded. For demonstration purpose in this article, we will also
exclude RCT patients that were not matched in the Bayesian outcome
model. However, in reality we may keep the full sample size in RCT and
discounting could be done at the second stage with power prior and
commensurate prior. Before, moving to the next stage of Bayesian
borrowing, ESS also needs to be taken into account.</p>
<p>The ESS for each cohort using different methods are shown below.</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out.ess</span></span>
<span><span class="co">#&gt;                  Unadjusted PSML PSMR  OM        GM GMW        EB       IPW</span></span>
<span><span class="co">#&gt; Trial                   600  224  203 500 600.00000 500 600.00000 600.00000</span></span>
<span><span class="co">#&gt; External Control        500  224  203 500  43.21729 500  27.69881  43.69827</span></span>
<span><span class="co">#&gt;                        GBM</span></span>
<span><span class="co">#&gt; Trial            600.00000</span></span>
<span><span class="co">#&gt; External Control  73.21273</span></span></code></pre></div>
<p>We also investigate the histogram of the weights for external control
patients and the effective sample size (ESS).</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">eb_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span>,main<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"EB \n ESS="</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">ess.eb.extcont</span><span class="op">)</span>,sep<span class="op">=</span><span class="st">""</span><span class="op">)</span>,xlab<span class="op">=</span><span class="st">"Weight"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">invprob_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span>,main<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"IPW\n ESS="</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">ess.ipw.extcont</span><span class="op">)</span>,sep<span class="op">=</span><span class="st">""</span><span class="op">)</span>,xlab<span class="op">=</span><span class="st">"Weight"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">weights_gbm</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span>,main<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"GBM \n ESS="</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">ess.gbm.extcont</span><span class="op">)</span>,sep<span class="op">=</span><span class="st">""</span><span class="op">)</span>,xlab<span class="op">=</span><span class="st">"Weight"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">genetic_ratio1_weights</span><span class="op">[</span><span class="va">data_with_weights</span><span class="op">$</span><span class="va">indicator</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span>,main<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"GM \n ESS="</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">ess.genetic.extcont</span><span class="op">)</span>,sep<span class="op">=</span><span class="st">""</span><span class="op">)</span>,xlab<span class="op">=</span><span class="st">"Weight"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="figure-match_weight_01_methods-unnamed-chunk-67-1.png" alt="plot of chunk unnamed-chunk-67"><p class="caption">
plot of chunk unnamed-chunk-67
</p>
</div>
</div>
<div class="section level2">
<h2 id="selection-of-matchingweighting-methods">Selection of matching/weighting methods<a class="anchor" aria-label="anchor" href="#selection-of-matchingweighting-methods"></a>
</h2>
<p>Based on the standardized difference mean plot, PSML, PSMR, and GM
can be the methods for selection. In terms of ESS, the PSML has the
highest sample size of <span class="math inline">\(215\)</span> in both
trial and external control data.</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-amusa2019examination" class="csl-entry">
Amusa, Lateef, Temesgen Zewotir, and Delia North. 2019.
<span>“Examination of Entropy Balancing Technique for Estimating Some
Standard Measures of Treatment Effects: A Simulation Study.”</span>
<em>Electronic Journal of Applied Statistical Analysis</em> 12 (2):
491–507.
</div>
<div id="ref-austin2011optimal" class="csl-entry">
Austin, Peter C. 2011. <span>“Optimal Caliper Widths for
Propensity-Score Matching When Estimating Differences in Means and
Differences in Proportions in Observational Studies.”</span>
<em>Pharmaceutical Statistics</em> 10 (2): 150–61.
</div>
<div id="ref-cox1972regression" class="csl-entry">
Cox, David R. 1972. <span>“Regression Models and Life-Tables.”</span>
<em>Journal of the Royal Statistical Society: Series B
(Methodological)</em> 34 (2): 187–202.
</div>
<div id="ref-greifer2020update" class="csl-entry">
Greifer, Noah. 2020. <span>“An Update on the MatchIt Package in
r.”</span> <em>Last Modified December</em> 8: 2020.
</div>
<div id="ref-hainmueller2012entropy" class="csl-entry">
Hainmueller, Jens. 2012. <span>“Entropy Balancing for Causal Effects: A
Multivariate Reweighting Method to Produce Balanced Samples in
Observational Studies.”</span> <em>Political Analysis</em> 20 (1):
25–46.
</div>
<div id="ref-harris2016brief" class="csl-entry">
Harris, Heather, and S Jeanne Horst. 2016. <span>“A Brief Guide to
Decisions at Each Step of the Propensity Score Matching Process.”</span>
<em>Practical Assessment, Research, and Evaluation</em> 21 (1): 4.
</div>
<div id="ref-mccaffrey2013tutorial" class="csl-entry">
McCaffrey, Daniel F, Beth Ann Griffin, Daniel Almirall, Mary Ellen
Slaughter, Rajeev Ramchand, and Lane F Burgette. 2013. <span>“A Tutorial
on Propensity Score Estimation for Multiple Treatments Using Generalized
Boosted Models.”</span> <em>Statistics in Medicine</em> 32 (19):
3388–3414.
</div>
<div id="ref-sekhon2008multivariate" class="csl-entry">
Sekhon, Jasjeet S. 2008. <span>“Multivariate and Propensity Score
Matching Software with Automated Balance Optimization: The Matching
Package for r.”</span> <em>Journal of Statistical Software,
Forthcoming</em>.
</div>
<div id="ref-stuart2011nonparametric" class="csl-entry">
Stuart, EA, G King, K Imai, and D MatchIt Ho. 2011. <span>“Nonparametric
Preprocessing for Parametric 368 Causal Inference.”</span> <em>Journal
of Statistical Software</em> 369.
</div>
<div id="ref-zhang2019balance" class="csl-entry">
Zhang, Zhongheng, Hwa Jung Kim, Guillaume Lonjon, Yibing Zhu, et al.
2019. <span>“Balance Diagnostics After Propensity Score
Matching.”</span> <em>Annals of Translational Medicine</em> 7 (1).
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Matt Secrest, Isaac Gravestock, Genentech, Inc..</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.8.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
